<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Marine Celestial Calculation</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@300;400&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #f8fafc;
    --card: #ffffff;
    --card-border: #cbd5e1;
    --text: #0f172a;
    --text-dim: #475569;
    --primary: #0369a1;
    --primary-light: #e0f2fe;
    --primary-dark: #075985;
    --secondary: #0891b2;
    --accent: #f59e0b;
    --accent-light: #fef3c7;
    --gold: #d97706;
    --rose: #dc2626;
    --moon-blue: #0284c7;
    --star-gold: #ca8a04;
    --success: #059669;
    --danger: #dc2626;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
    --gradient-primary: linear-gradient(135deg, #0369a1 0%, #0891b2 100%);
    --gradient-accent: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }
  
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --card-border: #334155;
      --text: #f1f5f9;
      --text-dim: #94a3b8;
      --primary: #38bdf8;
      --primary-light: #1e3a5f;
      --primary-dark: #0ea5e9;
      --secondary: #22d3ee;
      --accent: #fbbf24;
      --accent-light: #422006;
      --gold: #fbbf24;
      --rose: #f87171;
      --moon-blue: #60a5fa;
      --star-gold: #fde047;
      --success: #34d399;
      --danger: #f87171;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.3);
      --gradient-primary: linear-gradient(135deg, #38bdf8 0%, #22d3ee 100%);
      --gradient-accent: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }
  }
  
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body { height:100%; width:100%; overflow-x:hidden; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    font-size: 16px;
  }

  /* Remove decorative elements */
  .stars, .atmosphere { display: none; }

  /* Layout */
  .wrapper { max-width: 900px; margin: 0 auto; padding: 24px 20px 60px; width:100%; }
  
  /* Full width on mobile - no empty space */
  @media(max-width: 600px) {
    .wrapper { 
      max-width: 100%; 
      width: 100%;
      padding: 16px 8px 60px 8px; 
      margin: 0;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
    }
  }

  /* Header */
  .header { 
    text-align: center; 
    margin-bottom: 32px; 
    padding: 32px 20px 24px; 
    background: var(--gradient-primary);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }
  .header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
  }
  .header h1 {
    font-size: 2.5rem; 
    font-weight: 700; 
    letter-spacing: -0.02em;
    color: #ffffff; 
    margin-bottom: 8px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    position: relative;
    z-index: 1;
  }
  .header h1 em { 
    font-style: normal; 
    color: var(--accent);
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  .header p { 
    font-size: 1rem; 
    color: rgba(255,255,255,0.95); 
    font-weight: 500; 
    letter-spacing: 0.1em;
    position: relative;
    z-index: 1;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  /* GPS Bar */
  .gps-bar {
    background: var(--card); 
    border: 2px solid var(--card-border);
    border-radius: 12px; 
    padding: 18px 22px; 
    margin-bottom: 20px;
    display: flex; 
    align-items: center; 
    gap: 16px; 
    flex-wrap: wrap;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
  }
  .gps-bar:hover {
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
  }
  .gps-icon { font-size: 1.5rem; }
  .gps-info { flex: 1; min-width: 0; }
  .gps-info .label { 
    font-size: 0.75rem; 
    color: var(--text-dim); 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: 0.1em; 
    margin-bottom: 6px; 
  }
  .gps-info .coords { 
    font-size: 1rem; 
    color: var(--primary); 
    font-weight: 700; 
    font-family: 'Courier New', monospace;
    white-space: nowrap;
    overflow-x: auto;
  }
  
  @media(max-width: 600px) {
    .gps-info .coords {
      font-size: 0.85rem;
      white-space: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
  }
  .gps-btn {
    background: var(--gradient-primary); 
    border: none; 
    color: #fff;
    border-radius: 8px; 
    padding: 12px 24px; 
    font-family: inherit; 
    font-size: 0.9rem;
    cursor: pointer; 
    font-weight: 700; 
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .gps-btn:hover { 
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    filter: brightness(1.1);
  }
  .gps-btn:active {
    transform: translateY(0);
  }
  .gps-status { font-size: 0.85rem; color: var(--danger); font-weight: 700; }

  /* Mobile GPS Compact View */
  @media(max-width: 600px) {
    .gps-bar {
      padding: 12px 14px;
      margin-bottom: 16px;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }
    .gps-info .label {
      font-size: 0.65rem;
      margin-bottom: 4px;
    }
    .gps-info .coords {
      font-size: 0.95rem;
      margin-bottom: 8px;
    }
    .gps-bar > div:first-child {
      width: 100%;
    }
    .gps-bar > div:last-child {
      width: 100%;
      display: flex;
      gap: 8px;
      flex-direction: row;
    }
    .gps-btn {
      flex: 1;
      padding: 10px 16px;
      font-size: 0.8rem;
    }
    /* Compact data grid for mobile */
    .gps-bar .gps-info > div[style*="grid"] {
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 8px !important;
      margin-top: 8px !important;
    }
    .gps-bar .gps-info > div[style*="grid"] > div {
      padding: 6px !important;
    }
    .gps-bar .gps-info > div[style*="grid"] > div > div:first-child {
      font-size: 0.6rem !important;
      margin-bottom: 3px !important;
    }
    .gps-bar .gps-info > div[style*="grid"] > div > div:last-child {
      font-size: 0.85rem !important;
    }
    /* Mode toggle compact */
    .gps-bar > div:last-child > div {
      flex: 1;
      padding: 6px 8px !important;
    }
    .gps-bar > div:last-child > div label {
      font-size: 0.65rem !important;
    }
    .gps-bar > div:last-child > div button {
      padding: 5px 10px !important;
      font-size: 0.65rem !important;
    }
  }

  /* Manual input */
  .manual-row {
    display: none; gap: 12px; align-items: flex-end; flex-wrap: wrap;
    margin-bottom: 20px; padding: 16px 20px;
    background: var(--primary-light); border: 2px solid var(--primary); border-radius: 8px;
  }
  .manual-row.show { display: flex; }
  .manual-row input {
    flex: 1; min-width: 180px; background: var(--bg); border: 2px solid var(--card-border);
    border-radius: 6px; padding: 10px 12px; color: var(--text); font-family: 'Courier New', monospace; font-size: 0.95rem;
    outline: none; font-weight: 600;
  }
  .manual-row input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
  .manual-row label { font-size: 0.75rem; color: var(--text); font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 4px; }
  .manual-row .go-btn {
    background: var(--primary); color: #fff; border: none; border-radius: 6px;
    padding: 10px 24px; font-family: inherit; font-size: 0.9rem; font-weight: 700;
    cursor: pointer;
  }
  .manual-row .go-btn:hover { background: var(--secondary); }
  .manual-row .hint { color: var(--text-dim); font-size: 0.85rem; font-style: italic; }

  /* Time Display Bar */
  .time-bar {
    background: var(--card); 
    border: 2px solid var(--card-border);
    border-radius: 12px; 
    padding: 20px 24px; 
    margin-bottom: 20px;
    display: grid; 
    grid-template-columns: 1fr 1fr auto; 
    gap: 24px; 
    align-items: center;
    box-shadow: var(--shadow-md);
  }
  .time-block {
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    background: var(--primary-light);
    border: 1px solid var(--primary);
  }
  .time-label {
    font-size: 0.75rem; 
    color: var(--text-dim); 
    font-weight: 700;
    text-transform: uppercase; 
    letter-spacing: 0.1em; 
    margin-bottom: 8px;
  }
  .time-display {
    font-family: 'Courier New', monospace; 
    font-size: 1.6rem; 
    font-weight: 700;
    color: var(--primary); 
    letter-spacing: 0.05em;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .timezone-select {
    min-width: 160px;
  }
  .timezone-select label {
    display: block; 
    font-size: 0.75rem; 
    color: var(--text); 
    font-weight: 700;
    text-transform: uppercase; 
    letter-spacing: 0.05em; 
    margin-bottom: 8px;
  }
  .timezone-select select {
    width: 100%; 
    background: var(--bg); 
    border: 2px solid var(--card-border);
    border-radius: 8px; 
    padding: 10px 12px; 
    color: var(--text); 
    font-family: inherit;
    font-size: 0.85rem; 
    outline: none; 
    cursor: pointer; 
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .timezone-select select:focus { 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px var(--primary-light); 
  }

  @media(max-width: 768px) {
    .time-bar { grid-template-columns: 1fr; gap: 16px; }
    .time-block { text-align: left; }
  }

  /* Date row */
  .date-row {
    display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
  }
  .date-row input[type=date] {
    background: var(--card); border: 2px solid var(--card-border); border-radius: 6px;
    padding: 10px 14px; color: var(--text); font-family: inherit; font-size: 1rem;
    outline: none; flex: 1; min-width: 160px; font-weight: 600;
  }
  .date-row input[type=date]:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
  .date-nav {
    background: var(--card); border: 2px solid var(--card-border); color: var(--text);
    border-radius: 6px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1.5rem; transition: 0.15s; font-weight: 700;
  }
  .date-nav:hover { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }

  /* Star selector */
  .star-selector {
    background: var(--card); 
    border: 2px solid var(--card-border);
    border-radius: 12px; 
    padding: 18px 22px; 
    margin-bottom: 20px;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
  }
  .star-selector:hover {
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
  }
  .star-label {
    font-size: 0.75rem; 
    color: var(--text); 
    font-weight: 700; 
    text-transform: uppercase;
    letter-spacing: 0.1em; 
    margin-bottom: 12px;
  }
  .star-selector select {
    width: 100%; 
    background: var(--bg); 
    border: 2px solid var(--card-border);
    border-radius: 10px; 
    padding: 12px 16px; 
    color: var(--text); 
    font-family: inherit;
    font-size: 1rem; 
    outline: none; 
    cursor: pointer; 
    font-weight: 600;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
  }
  .star-selector select:focus { 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px var(--primary-light), var(--shadow-md); 
  }
  .star-selector select option { background: var(--bg); padding: 8px; }
  .star-selector select optgroup { 
    background: var(--bg); 
    color: var(--primary); 
    font-weight: 700; 
  }

  /* Arc removed - too decorative */
  .arc-wrap { display: none; }

  /* Cards grid */
  .cards { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 18px; 
    margin-bottom: 20px; 
  }
  .card {
    background: var(--card); 
    border: 2px solid var(--card-border);
    border-radius: 12px; 
    padding: 22px 20px; 
    position: relative;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    overflow: hidden;
  }
  .card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
  }
  .card::before { display: none; }
  .card .card-label {
    font-size: 0.75rem; 
    color: var(--text-dim); 
    font-weight: 700; 
    text-transform: uppercase;
    letter-spacing: 0.1em; 
    margin-bottom: 12px; 
    display: flex; 
    align-items: center; 
    gap: 8px;
  }
  .card .card-label .dot { 
    width: 10px; 
    height: 10px; 
    border-radius: 50%;
    box-shadow: 0 0 8px currentColor;
  }
  .card.sunrise .dot { background: var(--gold); }
  .card.sunset .dot { background: var(--rose); }
  .card.moonrise .dot { background: var(--moon-blue); }
  .card.moonset .dot { background: var(--secondary); }
  .card .card-time {
    font-family: 'Courier New', monospace; 
    font-size: 2.2rem; 
    font-weight: 700;
    margin-bottom: 16px; 
    letter-spacing: -0.02em;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .card.sunrise .card-time { color: var(--gold); }
  .card.sunset .card-time { color: var(--rose); }
  .card.moonrise .card-time { color: var(--moon-blue); }
  .card.moonset .card-time { color: var(--secondary); }
  .card .card-meta { 
    font-size: 0.95rem; 
    color: var(--text-dim); 
    line-height: 2; 
    font-weight: 500; 
  }
  .card .card-meta span { 
    color: var(--text); 
    font-weight: 700; 
  }

  /* Detail table */
  .detail-wrap {
    background: var(--card); 
    border: 2px solid var(--card-border);
    border-radius: 12px; 
    padding: 24px; 
    margin-bottom: 20px;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
  }
  .detail-wrap:hover {
    box-shadow: var(--shadow-lg);
  }
  .detail-wrap .sec-title {
    font-size: 0.9rem; 
    color: var(--primary); 
    font-weight: 700; 
    text-transform: uppercase;
    letter-spacing: 0.1em; 
    margin-bottom: 18px; 
    padding-bottom: 12px;
    border-bottom: 3px solid var(--primary);
  }
  table { width: 100%; border-collapse: collapse; }
  table th {
    text-align: left; 
    font-size: 0.85rem; 
    color: #fff; 
    font-weight: 700;
    text-transform: uppercase; 
    letter-spacing: 0.05em; 
    padding: 14px 12px;
    border-bottom: 2px solid var(--card-border); 
    background: var(--gradient-primary);
  }
  table td { 
    padding: 14px 12px; 
    font-size: 0.95rem; 
    border-bottom: 1px solid var(--card-border); 
    font-weight: 600;
    transition: background 0.2s ease;
  }
  table tr:hover td {
    background: var(--primary-light);
  }
  table tr:last-child td { border: none; }
  table td:first-child { color: var(--text); font-weight: 700; }
  table td:last-child { text-align: right; color: var(--text); }

  /* Daylight bar */
  .daybar-wrap { margin-top: 18px; }
  .daybar-label { 
    display: flex; 
    justify-content: space-between; 
    font-size: 0.85rem; 
    color: var(--text-dim); 
    margin-bottom: 10px; 
    font-weight: 600; 
  }
  .daybar-bg {
    height: 14px; 
    background: var(--card-border); 
    border-radius: 8px; 
    overflow: hidden; 
    border: 2px solid var(--card-border);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }
  .daybar-fill {
    height: 100%; 
    border-radius: 6px;
    background: var(--gradient-accent);
    transition: width 0.6s ease;
    box-shadow: 0 0 10px rgba(245,158,11,0.4);
  }

  /* Responsive */
  @media(max-width: 600px) {
    .cards { grid-template-columns: 1fr; }
    .header h1 { font-size: 1.8rem; }
    body { font-size: 15px; }
  }

  /* Tab Navigation */
  .tab-nav {
    display: flex; gap: 6px; margin-bottom: 20px; overflow-x: auto; 
    background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
    border: 2px solid #2d5a8c; 
    border-radius: 10px; padding: 10px;
    -webkit-overflow-scrolling: touch;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  .tab-btn {
    background: rgba(255,255,255,0.1); 
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.85);
    padding: 12px 20px; font-family: inherit; font-size: 0.9rem;
    cursor: pointer; font-weight: 600; border-radius: 8px;
    white-space: nowrap; transition: all 0.3s ease; flex-shrink: 0;
    backdrop-filter: blur(10px);
  }
  .tab-btn:hover { 
    background: rgba(255,255,255,0.2); 
    color: #fff;
    border-color: rgba(255,255,255,0.4);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .tab-btn.active { 
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: #fff;
    border: 2px solid #fbbf24;
    box-shadow: 0 4px 12px rgba(245,158,11,0.4), 0 0 20px rgba(245,158,11,0.3);
    font-weight: 700;
  }
  
  @media (prefers-color-scheme: dark) {
    .tab-nav {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      border-color: #334155;
    }
    .tab-btn {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.1);
      color: rgba(241,245,249,0.8);
    }
    .tab-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #f1f5f9;
      border-color: rgba(255,255,255,0.2);
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #60a5fa;
      box-shadow: 0 4px 12px rgba(59,130,246,0.4), 0 0 20px rgba(59,130,246,0.3);
    }
  }
  
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Visible Bodies Table */
  .visible-table {
    background: var(--card); 
    border: 2px solid var(--card-border);
    border-radius: 12px; 
    overflow-x: auto;
    box-shadow: var(--shadow-md);
  }
  .visible-table table { width: 100%; min-width: 600px; }
  .visible-table th {
    background: var(--gradient-primary); 
    color: #fff; 
    font-size: 0.9rem;
    padding: 16px 14px; 
    text-align: left; 
    font-weight: 700;
    position: sticky; 
    top: 0; 
    z-index: 10;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 3px solid var(--primary-dark);
  }
  .visible-table td {
    padding: 14px; 
    font-size: 0.95rem; 
    border-bottom: 1px solid var(--card-border);
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .visible-table tr:hover { 
    background: var(--primary-light);
  }
  .visible-table tr:hover td {
    color: var(--primary-dark);
  }
  .visible-table .body-name { 
    color: var(--primary); 
    font-weight: 700; 
    font-size: 1rem;
  }
  .visible-table .visible-yes { 
    color: var(--success); 
    font-weight: 700; 
  }
  .visible-table .visible-no { 
    color: var(--danger); 
    font-weight: 700; 
  }

  /* Settings Panel */
  .settings-panel {
    background: var(--card); 
    border: 2px solid var(--card-border);
    border-radius: 12px; 
    padding: 28px;
    box-shadow: var(--shadow-md);
  }
  .settings-group {
    margin-bottom: 28px; 
    padding: 20px;
    background: var(--primary-light);
    border-radius: 10px;
    border: 1px solid var(--primary);
  }
  .settings-group:last-child { margin-bottom: 0; }
  .settings-group h3 {
    font-size: 1.1rem; 
    font-weight: 700; 
    color: var(--primary);
    margin-bottom: 16px; 
    text-transform: uppercase; 
    letter-spacing: 0.05em;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--primary);
  }
  .settings-row {
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    padding: 14px 0; 
    gap: 16px; 
    flex-wrap: wrap;
  }
  .settings-row label { 
    font-size: 1rem; 
    font-weight: 600; 
    color: var(--text); 
  }
  .settings-row select, .settings-row input {
    background: var(--bg); 
    border: 2px solid var(--card-border);
    border-radius: 8px; 
    padding: 10px 14px; 
    color: var(--text);
    font-family: inherit; 
    font-size: 0.95rem; 
    font-weight: 600; 
    min-width: 140px;
    transition: all 0.3s ease;
  }
  .settings-row select:focus, .settings-row input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
    outline: none;
  }
  .settings-row input[type="checkbox"] {
    width: 24px; 
    height: 24px; 
    cursor: pointer; 
    min-width: auto;
    accent-color: var(--primary);
  }

  /* Developer Notes */
  .dev-notes {
    background: var(--card); border: 2px solid var(--card-border);
    border-radius: 8px; padding: 24px; line-height: 1.8;
  }
  .dev-notes h3 {
    font-size: 1.2rem; font-weight: 700; color: var(--primary);
    margin-bottom: 16px; border-bottom: 2px solid var(--primary); padding-bottom: 8px;
  }
  .dev-notes h4 {
    font-size: 1rem; font-weight: 700; color: var(--text);
    margin-top: 20px; margin-bottom: 8px;
  }
  .dev-notes p { margin-bottom: 12px; color: var(--text-dim); }
  .dev-notes ul { margin-left: 24px; margin-bottom: 12px; color: var(--text-dim); }
  .dev-notes li { margin-bottom: 6px; }
  .dev-notes code {
    background: var(--bg); padding: 2px 6px; border-radius: 4px;
    font-family: 'Courier New', monospace; font-size: 0.85rem;
    color: var(--primary); border: 1px solid var(--card-border);
  }

  /* Enhanced Responsive */
  @media(max-width: 600px) {
    .wrapper { padding: 16px 12px 60px; max-width: 100%; }
    .header h1 { font-size: 1.6rem; }
    .header p { font-size: 0.85rem; }
    .gps-bar { flex-direction: column; align-items: stretch; gap: 12px; padding: 14px 16px; }
    .gps-info .coords { font-size: 0.85rem; word-break: break-all; }
    .gps-btn { width: 100%; padding: 12px; }
    .time-bar { padding: 12px 16px; grid-template-columns: 1fr; gap: 12px; }
    .time-block { text-align: left; }
    .time-display { font-size: 1.3rem; }
    .time-label { font-size: 0.7rem; }
    .timezone-select { width: 100%; }
    .timezone-select select { width: 100%; }
    .date-row { gap: 8px; }
    .date-row input[type=date] { font-size: 0.9rem; padding: 8px 10px; }
    .date-nav { width: 40px; height: 40px; font-size: 1.2rem; }
    .star-selector { padding: 12px 14px; }
    .star-selector select { font-size: 0.9rem; padding: 10px; }
    .tab-nav { padding: 6px; gap: 4px; }
    .tab-btn { 
      padding: 11px 14px; 
      font-size: 0.8rem; 
      border-radius: 6px;
    }
    .tab-btn.active {
      padding: 10px 13px; /* Account for thicker border */
    }
    .cards { grid-template-columns: 1fr; gap: 12px; }
    .card { padding: 16px 14px; }
    .card .card-time { font-size: 1.6rem; }
    .card .card-meta { font-size: 0.85rem; }
    .detail-wrap { padding: 16px 14px; }
    table th { font-size: 0.7rem; padding: 8px 6px; }
    table td { font-size: 0.85rem; padding: 10px 6px; }
    .visible-table th, .visible-table td { padding: 10px 8px; font-size: 0.85rem; }
    .settings-panel { padding: 18px 14px; }
    .settings-group h3 { font-size: 0.95rem; }
    .settings-row { flex-direction: column; align-items: flex-start; gap: 8px; }
    .settings-row label { font-size: 0.9rem; }
    .settings-row select, .settings-row input { width: 100%; min-width: auto; max-width: 100%; }
    .dev-notes { padding: 18px 14px; }
    .dev-notes h3 { font-size: 1.1rem; }
    .dev-notes h4 { font-size: 0.95rem; }
    .dev-notes p, .dev-notes li { font-size: 0.85rem; }
    /* Compass tab mobile */
    #compass-true-bearing { font-size: 1.5rem; }
    #compass-gyro-heading, #compass-mag-heading, #compass-gyro-bearing { width: 100%; }
    /* Moon phases mobile */
    #moonphase-calendar table { font-size: 0.75rem; }
    #moonphase-calendar td { padding: 6px 4px; }
    /* Day/night chart mobile */
    #daynight-chart { height: 300px; }
  }

  @media(min-width: 601px) and (max-width: 1024px) {
    .wrapper { max-width: 95%; padding: 20px 16px; }
    .cards { grid-template-columns: repeat(2, 1fr); }
    .time-bar { grid-template-columns: 1fr 1fr; }
    .timezone-select { grid-column: 1 / -1; }
  }

  @media(min-width: 1025px) {
    .wrapper { max-width: 1200px; }
    body { font-size: 17px; }
    .header h1 { font-size: 3rem; }
  }

  /* Mobile landscape */
  @media(max-height: 500px) and (orientation: landscape) {
    .header { margin-bottom: 16px; padding-bottom: 12px; }
    .header h1 { font-size: 1.5rem; }
    .header p { font-size: 0.8rem; }
    .gps-bar, .time-bar, .date-row, .star-selector { margin-bottom: 12px; }
  }

</style>
</head>
<body>

<div class="stars" id="stars"></div>
<div class="atmosphere"></div>

<div class="wrapper">
  <!-- Header -->
  <div class="header">
    <h1>Marine <em>Celestial</em> Calculation</h1>
    <p>Sun ‚Ä¢ Moon ‚Ä¢ Planets ‚Ä¢ Stars ‚Ä¢ Navigation</p>
  </div>

  <!-- GPS Bar -->
  <div class="gps-bar">
    <div class="gps-info" style="flex:1;">
      <div class="label">GPS POSITION</div>
      <div class="coords" id="coordsDisplay" style="font-size:1.4rem; font-weight:700; margin-bottom:12px;">Waiting for location‚Ä¶</div>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-top:12px;">
        <div>
          <div style="font-size:0.7rem; color:var(--text-dim); font-weight:700; text-transform:uppercase; margin-bottom:4px;">COG (Course)</div>
          <div id="cog-display" style="font-size:1.1rem; font-weight:700; color:var(--primary); font-family:'Courier New', monospace;">---¬∞</div>
        </div>
        <div>
          <div style="font-size:0.7rem; color:var(--text-dim); font-weight:700; text-transform:uppercase; margin-bottom:4px;">SOG (Speed)</div>
          <div id="sog-display" style="font-size:1.1rem; font-weight:700; color:var(--primary); font-family:'Courier New', monospace;">--- kts</div>
        </div>
        <div>
          <div style="font-size:0.7rem; color:var(--text-dim); font-weight:700; text-transform:uppercase; margin-bottom:4px;">Barometer</div>
          <div id="barometer-display" style="font-size:1.1rem; font-weight:700; color:var(--primary); font-family:'Courier New', monospace;">--- mb</div>
        </div>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <button class="gps-btn" onclick="fetchGPS()">GPS</button>
      <div style="display:flex; align-items:center; gap:8px; background:var(--card); padding:8px 12px; border-radius:6px; border:2px solid var(--card-border);">
        <label style="font-size:0.75rem; font-weight:700; color:var(--text); white-space:nowrap;">Mode:</label>
        <button id="mode-online" onclick="setMode('online')" style="background:var(--primary); color:#fff; border:none; padding:6px 12px; border-radius:4px; font-size:0.75rem; font-weight:700; cursor:pointer;">Online</button>
        <button id="mode-offline" onclick="setMode('offline')" style="background:var(--card); color:var(--text); border:2px solid var(--card-border); padding:6px 12px; border-radius:4px; font-size:0.75rem; font-weight:700; cursor:pointer;">Offline</button>
      </div>
    </div>
  </div>
  <div id="manualRow" class="manual-row">
    <div style="flex:1; min-width:200px;">
      <label>Latitude (DD MM.MMM N/S)</label>
      <input type="text" id="manLat" placeholder="e.g. 40 42.768 N"/>
    </div>
    <div style="flex:1; min-width:200px;">
      <label>Longitude (DDD MM.MMM E/W)</label>
      <input type="text" id="manLon" placeholder="e.g. 074 00.360 W"/>
    </div>
    <button class="go-btn" onclick="applyManual()">Go</button>
  </div>

  <!-- Time Display Bar -->
  <div class="time-bar">
    <div class="time-block">
      <div class="time-label">üåê UTC Time</div>
      <div class="time-display" id="utcTime">--:--:--</div>
    </div>
    <div class="time-block">
      <div class="time-label">üïê Local Time (UTC<span id="offsetDisplay">+0</span>)</div>
      <div class="time-display" id="localTime">--:--:--</div>
    </div>
    <div class="timezone-select">
      <label>UTC Offset</label>
      <select id="utcOffset" onchange="updateTimeDisplay()">
        <option value="-12">UTC-12:00</option>
        <option value="-11">UTC-11:00</option>
        <option value="-10">UTC-10:00</option>
        <option value="-9.5">UTC-09:30</option>
        <option value="-9">UTC-09:00</option>
        <option value="-8">UTC-08:00</option>
        <option value="-7">UTC-07:00</option>
        <option value="-6">UTC-06:00</option>
        <option value="-5">UTC-05:00</option>
        <option value="-4">UTC-04:00</option>
        <option value="-3.5">UTC-03:30</option>
        <option value="-3">UTC-03:00</option>
        <option value="-2">UTC-02:00</option>
        <option value="-1">UTC-01:00</option>
        <option value="0" selected>UTC¬±00:00</option>
        <option value="1">UTC+01:00</option>
        <option value="2">UTC+02:00</option>
        <option value="3">UTC+03:00</option>
        <option value="3.5">UTC+03:30</option>
        <option value="4">UTC+04:00</option>
        <option value="4.5">UTC+04:30</option>
        <option value="5">UTC+05:00</option>
        <option value="5.5">UTC+05:30</option>
        <option value="5.75">UTC+05:45</option>
        <option value="6">UTC+06:00</option>
        <option value="6.5">UTC+06:30</option>
        <option value="7">UTC+07:00</option>
        <option value="8">UTC+08:00</option>
        <option value="8.75">UTC+08:45</option>
        <option value="9">UTC+09:00</option>
        <option value="9.5">UTC+09:30</option>
        <option value="10">UTC+10:00</option>
        <option value="10.5">UTC+10:30</option>
        <option value="11">UTC+11:00</option>
        <option value="12">UTC+12:00</option>
        <option value="12.75">UTC+12:45</option>
        <option value="13">UTC+13:00</option>
        <option value="14">UTC+14:00</option>
      </select>
    </div>
  </div>

  <!-- Date row -->
  <div class="date-row">
    <button class="date-nav" onclick="shiftDay(-1)">‚Äπ</button>
    <input type="date" id="datePicker" onchange="compute()"/>
    <button class="date-nav" onclick="shiftDay(1)">‚Ä∫</button>
  </div>

  <!-- Navigation Stars Dropdown -->
  <div class="star-selector">
    <div class="star-label">‚≠ê Celestial Bodies</div>
    <select id="starDropdown" onchange="updateStarPosition()">
      <option value="">Select a celestial body...</option>
      <optgroup label="Planets">
        <option value="Mercury">‚òø Mercury</option>
        <option value="Venus">‚ôÄ Venus</option>
        <option value="Mars">‚ôÇ Mars</option>
        <option value="Jupiter">‚ôÉ Jupiter</option>
        <option value="Saturn">‚ôÑ Saturn</option>
      </optgroup>
      <optgroup label="First Magnitude Stars">
        <option value="Sirius">Sirius (Œ± CMa) - Brightest star</option>
        <option value="Canopus">Canopus (Œ± Car)</option>
        <option value="Arcturus">Arcturus (Œ± Boo)</option>
        <option value="Rigel Kentaurus">Rigel Kentaurus (Œ± Cen)</option>
        <option value="Vega">Vega (Œ± Lyr)</option>
        <option value="Capella">Capella (Œ± Aur)</option>
        <option value="Rigel">Rigel (Œ≤ Ori)</option>
        <option value="Procyon">Procyon (Œ± CMi)</option>
        <option value="Achernar">Achernar (Œ± Eri)</option>
        <option value="Betelgeuse">Betelgeuse (Œ± Ori)</option>
        <option value="Hadar">Hadar (Œ≤ Cen)</option>
        <option value="Altair">Altair (Œ± Aql)</option>
        <option value="Acrux">Acrux (Œ± Cru)</option>
        <option value="Aldebaran">Aldebaran (Œ± Tau)</option>
        <option value="Spica">Spica (Œ± Vir)</option>
        <option value="Antares">Antares (Œ± Sco)</option>
        <option value="Pollux">Pollux (Œ≤ Gem)</option>
        <option value="Fomalhaut">Fomalhaut (Œ± PsA)</option>
        <option value="Deneb">Deneb (Œ± Cyg)</option>
        <option value="Mimosa">Mimosa (Œ≤ Cru)</option>
      </optgroup>
      <optgroup label="Second Magnitude Navigation Stars">
        <option value="Regulus">Regulus (Œ± Leo)</option>
        <option value="Adhara">Adhara (Œµ CMa)</option>
        <option value="Castor">Castor (Œ± Gem)</option>
        <option value="Gacrux">Gacrux (Œ≥ Cru)</option>
        <option value="Shaula">Shaula (Œª Sco)</option>
        <option value="Bellatrix">Bellatrix (Œ≥ Ori)</option>
        <option value="Elnath">Elnath (Œ≤ Tau)</option>
        <option value="Miaplacidus">Miaplacidus (Œ≤ Car)</option>
        <option value="Alnilam">Alnilam (Œµ Ori)</option>
        <option value="Alnitak">Alnitak (Œ∂ Ori)</option>
        <option value="Alioth">Alioth (Œµ UMa)</option>
        <option value="Mirfak">Mirfak (Œ± Per)</option>
        <option value="Kaus Australis">Kaus Australis (Œµ Sgr)</option>
        <option value="Alkaid">Alkaid (Œ∑ UMa)</option>
        <option value="Avior">Avior (Œµ Car)</option>
        <option value="Sargas">Sargas (Œ∏ Sco)</option>
        <option value="Menkalinan">Menkalinan (Œ≤ Aur)</option>
        <option value="Atria">Atria (Œ± TrA)</option>
        <option value="Alhena">Alhena (Œ≥ Gem)</option>
        <option value="Peacock">Peacock (Œ± Pav)</option>
        <option value="Mirzam">Mirzam (Œ≤ CMa)</option>
        <option value="Alphard">Alphard (Œ± Hya)</option>
        <option value="Hamal">Hamal (Œ± Ari)</option>
        <option value="Polaris">Polaris (Œ± UMi) - North Star</option>
        <option value="Algieba">Algieba (Œ≥ Leo)</option>
        <option value="Diphda">Diphda (Œ≤ Cet)</option>
        <option value="Mizar">Mizar (Œ∂ UMa)</option>
        <option value="Nunki">Nunki (œÉ Sgr)</option>
        <option value="Suhail">Suhail (Œª Vel)</option>
        <option value="Alpheratz">Alpheratz (Œ± And)</option>
        <option value="Kochab">Kochab (Œ≤ UMi)</option>
        <option value="Rasalhague">Rasalhague (Œ± Oph)</option>
        <option value="Algol">Algol (Œ≤ Per)</option>
        <option value="Denebola">Denebola (Œ≤ Leo)</option>
        <option value="Gienah">Gienah (Œ≥ Crv)</option>
        <option value="Alphecca">Alphecca (Œ± CrB)</option>
        <option value="Navi">Navi (Œµ Cas)</option>
        <option value="Zubenelgenubi">Zubenelgenubi (Œ± Lib)</option>
        <option value="Eltanin">Eltanin (Œ≥ Dra)</option>
        <option value="Schedar">Schedar (Œ± Cas)</option>
        <option value="Sabik">Sabik (Œ∑ Oph)</option>
        <option value="Phecda">Phecda (Œ≥ UMa)</option>
        <option value="Ankaa">Ankaa (Œ± Phe)</option>
        <option value="Scheat">Scheat (Œ≤ Peg)</option>
        <option value="Alderamin">Alderamin (Œ± Cep)</option>
        <option value="Enif">Enif (Œµ Peg)</option>
        <option value="Markab">Markab (Œ± Peg)</option>
        <option value="Acamar">Acamar (Œ∏ Eri)</option>
        <option value="Menkar">Menkar (Œ± Cet)</option>
        <option value="Dubhe">Dubhe (Œ± UMa)</option>
      </optgroup>
    </select>
  </div>

  <!-- Tab Navigation - Two Row Layout -->
  <div style="margin-bottom:20px;">
    <!-- First Row - Primary Navigation -->
    <div class="tab-nav" style="margin-bottom:8px;">
      <button class="tab-btn active" onclick="switchTab('main')">üìä Main</button>
      <button class="tab-btn" onclick="switchTab('visible')">üëÅÔ∏è Visible Now</button>
      <button class="tab-btn" onclick="switchTab('compass')">üß≠ Compass Error</button>
      <button class="tab-btn" onclick="switchTab('marinecompass')">‚öì Marine Compass</button>
      <button class="tab-btn" onclick="switchTab('moonphases')">üåô Moon Phases</button>
      <button class="tab-btn" onclick="switchTab('lunarcalendar')">üìÖ Lunar Calendar</button>
    </div>
    <!-- Second Row - Secondary Navigation -->
    <div class="tab-nav" style="margin-bottom:0;">
      <button class="tab-btn" onclick="switchTab('eclipses')">üåë Eclipses</button>
      <button class="tab-btn" onclick="switchTab('daynight')">‚òÄÔ∏èüåô Day/Night</button>
      <button class="tab-btn" onclick="switchTab('worldclock')">üåç World Clock</button>
      <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
      <button class="tab-btn" onclick="switchTab('about')">‚ÑπÔ∏è About</button>
      <button class="tab-btn" onclick="switchTab('developer')">¬©Ô∏è Developer</button>
    </div>
  </div>

  <!-- Main Tab Content -->
  <div id="tab-main" class="tab-content active">

  <!-- Sun Arc SVG -->
  <div class="arc-wrap">
    <svg id="arcSvg" viewBox="0 0 400 180" preserveAspectRatio="xMidYMid meet">
      <defs>
        <linearGradient id="arcGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#d4a853"/>
          <stop offset="50%" stop-color="#f0c87a"/>
          <stop offset="100%" stop-color="#e07a5f"/>
        </linearGradient>
      </defs>
      <!-- Horizon line -->
      <line x1="10" y1="155" x2="390" y2="155" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
      <!-- Horizon labels -->
      <text x="14" y="172" fill="rgba(255,255,255,0.25)" font-size="9" font-family="IBM Plex Mono">E</text>
      <text x="192" y="172" fill="rgba(255,255,255,0.25)" font-size="9" font-family="IBM Plex Mono">S / N</text>
      <text x="375" y="172" fill="rgba(255,255,255,0.25)" font-size="9" font-family="IBM Plex Mono">W</text>
      <!-- Arc path (dashed ghost) -->
      <path id="arcGhost" d="" stroke="rgba(255,255,255,0.08)" stroke-width="2" fill="none" stroke-dasharray="6,5"/>
      <!-- Arc path (progress) -->
      <path id="arcProgress" d="" stroke="url(#arcGrad)" stroke-width="3" fill="none" stroke-linecap="round"/>
      <!-- Sun circle -->
      <circle id="sunCircle" cx="200" cy="100" r="10" fill="#f0c87a">
        <filter id="glow"><feGaussianBlur stdDeviation="4" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode/></feMerge></filter>
      </circle>
      <circle id="sunCircle" cx="200" cy="100" r="10" fill="#f0c87a" filter="url(#glow)"/>
      <!-- Sunrise / Sunset labels on arc -->
      <text id="sriseLabel" x="0" y="0" fill="#d4a853" font-size="9" font-family="IBM Plex Mono" text-anchor="middle"/>
      <text id="ssetLabel" x="0" y="0" fill="#e07a5f" font-size="9" font-family="IBM Plex Mono" text-anchor="middle"/>
      <!-- Current time marker -->
      <circle id="nowDot" cx="0" cy="0" r="4" fill="#fff" opacity="0"/>
      <text id="nowLabel" x="0" y="0" fill="#fff" font-size="8" font-family="IBM Plex Mono" text-anchor="middle" opacity="0">Now</text>
    </svg>
  </div>

  <!-- Sunrise / Sunset cards -->
  <div class="cards">
    <div class="card sunrise">
      <div class="card-label"><span class="dot"></span>Sunrise</div>
      <div class="card-time" id="sriseTime">--:--</div>
      <div class="card-meta">
        Azimuth: <span id="sriseAz">--¬∞</span><br/>
        Altitude: <span id="sriseAlt">0¬∞</span>
      </div>
    </div>
    <div class="card sunset">
      <div class="card-label"><span class="dot"></span>Sunset</div>
      <div class="card-time" id="ssetTime">--:--</div>
      <div class="card-meta">
        Azimuth: <span id="ssetAz">--¬∞</span><br/>
        Altitude: <span id="ssetAlt">0¬∞</span>
      </div>
    </div>
  </div>

  <!-- Moon cards -->
  <div class="cards">
    <div class="card moonrise">
      <div class="card-label"><span class="dot"></span>Moonrise</div>
      <div class="card-time" id="mriseTime">--:--</div>
      <div class="card-meta">
        Azimuth: <span id="mriseAz">--¬∞</span><br/>
        Altitude: <span id="mriseAlt">0¬∞</span>
      </div>
    </div>
    <div class="card moonset">
      <div class="card-label"><span class="dot"></span>Moonset</div>
      <div class="card-time" id="msetTime">--:--</div>
      <div class="card-meta">
        Azimuth: <span id="msetAz">--¬∞</span><br/>
        Altitude: <span id="msetAlt">0¬∞</span>
      </div>
    </div>
  </div>

  <!-- Current Position Card -->
  <div class="detail-wrap">
    <div class="sec-title">‚è∞ Current Celestial Positions</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
      <div style="background:var(--primary-light); padding:16px; border-radius:6px; border:2px solid var(--primary);">
        <div style="font-size:0.85rem; color:var(--text); font-weight:700; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:12px;">‚òÄÔ∏è Sun Now</div>
        <div style="font-size:1.5rem; font-weight:700; color:var(--gold); margin-bottom:6px;" id="sunNowAz">--¬∞</div>
        <div style="font-size:0.85rem; color:var(--text-dim); font-weight:600; margin-bottom:12px;">Azimuth</div>
        <div style="font-size:1.5rem; font-weight:700; color:var(--gold); margin-bottom:6px;" id="sunNowAlt">--¬∞</div>
        <div style="font-size:0.85rem; color:var(--text-dim); font-weight:600;">Altitude</div>
      </div>
      <div style="background:var(--primary-light); padding:16px; border-radius:6px; border:2px solid var(--moon-blue);">
        <div style="font-size:0.85rem; color:var(--text); font-weight:700; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:12px;">üåô Moon Now</div>
        <div style="font-size:1.5rem; font-weight:700; color:var(--moon-blue); margin-bottom:6px;" id="moonNowAz">--¬∞</div>
        <div style="font-size:0.85rem; color:var(--text-dim); font-weight:600; margin-bottom:12px;">Azimuth</div>
        <div style="font-size:1.5rem; font-weight:700; color:var(--moon-blue); margin-bottom:6px;" id="moonNowAlt">--¬∞</div>
        <div style="font-size:0.85rem; color:var(--text-dim); font-weight:600; margin-bottom:12px;">Altitude</div>
        <div style="font-size:0.9rem; color:var(--text-dim); font-weight:600;">Phase: <span id="moonPhase" style="color:var(--text); font-weight:700;">--</span></div>
      </div>
    </div>
  </div>

  <!-- Selected Star Position -->
  <div class="detail-wrap" id="starCard" style="display:none; background:var(--primary-light); border:3px solid var(--star-gold);">
    <div class="sec-title" style="border-color:var(--star-gold);">
      <span id="starIcon">‚≠ê</span> <span id="starName" style="color:var(--primary);">Star Position</span>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-bottom:16px;">
      <div style="text-align:center; background:var(--bg); padding:12px; border-radius:6px; border:2px solid var(--card-border);">
        <div style="font-size:1.5rem; font-weight:700; color:var(--star-gold); margin-bottom:6px;" id="starAz">--¬∞</div>
        <div style="font-size:0.85rem; color:var(--text-dim); font-weight:600;">Azimuth</div>
      </div>
      <div style="text-align:center; background:var(--bg); padding:12px; border-radius:6px; border:2px solid var(--card-border);">
        <div style="font-size:1.5rem; font-weight:700; color:var(--star-gold); margin-bottom:6px;" id="starAlt">--¬∞</div>
        <div style="font-size:0.85rem; color:var(--text-dim); font-weight:600;">Altitude</div>
      </div>
      <div style="text-align:center; background:var(--bg); padding:12px; border-radius:6px; border:2px solid var(--card-border);">
        <div style="font-size:1.25rem; font-weight:700; margin-bottom:6px;" id="starVisible">--</div>
        <div style="font-size:0.85rem; color:var(--text-dim); font-weight:600;">Visible</div>
      </div>
    </div>
    <div style="font-size:0.95rem; color:var(--text); line-height:2; background:var(--bg); padding:12px; border-radius:6px; font-weight:600;">
      <strong style="color:var(--primary);">Rise:</strong> <span id="starRise">--:--</span> &nbsp;|&nbsp; 
      <strong style="color:var(--primary);">Transit:</strong> <span id="starTransit">--:--</span> &nbsp;|&nbsp; 
      <strong style="color:var(--primary);">Set:</strong> <span id="starSet">--:--</span>
    </div>
  </div>

  <!-- Detail table -->
  <div class="detail-wrap">
    <div class="sec-title">Solar Details</div>
    <table>
      <thead><tr><th>Event</th><th>Time</th><th>Azimuth</th><th>Altitude</th></tr></thead>
      <tbody id="detailBody">
        <tr><td colspan="4" style="color:var(--text-dim);text-align:center;padding:18px 0;">Calculating‚Ä¶</td></tr>
      </tbody>
    </table>
    <div class="daybar-wrap">
      <div class="daybar-label"><span>Sunrise</span><span id="daylightHrs">--</span><span>Sunset</span></div>
      <div class="daybar-bg"><div class="daybar-fill" id="daylightBar" style="width:0%"></div></div>
    </div>
  </div>
  </div><!-- End Main Tab -->

  <!-- Visible Bodies Tab -->
  <div id="tab-visible" class="tab-content">
    <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
      <h3 style="font-size:1.2rem; font-weight:700; color:var(--primary);">Currently Visible Celestial Bodies</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        <label style="font-size:0.9rem; font-weight:600; color:var(--text);">Sort by Altitude:</label>
        <select id="visibleSortOrder" onchange="updateVisibleBodies()" style="background:var(--card); border:2px solid var(--card-border); border-radius:6px; padding:6px 10px; color:var(--text); font-family:inherit; font-size:0.85rem; font-weight:600;">
          <option value="desc">Descending (Highest first)</option>
          <option value="asc">Ascending (Lowest first)</option>
        </select>
      </div>
    </div>
    <div class="visible-table">
      <table id="visibleBodiesTable">
        <thead>
          <tr>
            <th>Body</th>
            <th>Type</th>
            <th>Azimuth</th>
            <th>Altitude</th>
            <th>Visible</th>
          </tr>
        </thead>
        <tbody id="visibleTableBody">
          <tr><td colspan="5" style="text-align:center;padding:20px;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Sky Plot Visualization -->
    <div style="margin-top:30px; background:var(--card); border:2px solid var(--card-border); border-radius:12px; padding:24px; box-shadow:var(--shadow-md);">
      <h4 style="font-size:1.1rem; font-weight:700; color:var(--primary); margin-bottom:20px;">Sky View - Azimuth & Altitude Plot</h4>
      <div style="position:relative; width:100%; max-width:500px; margin:0 auto;">
        <canvas id="skyPlotCanvas" width="500" height="500" style="width:100%; height:auto; border-radius:50%; background:linear-gradient(180deg, #0a1929 0%, #1a2332 50%, #2a3342 100%);"></canvas>
      </div>
      <div style="margin-top:16px; display:flex; gap:16px; justify-content:center; flex-wrap:wrap; font-size:0.85rem;">
        <div><span style="display:inline-block; width:12px; height:12px; background:#fbbf24; border-radius:50%; margin-right:6px;"></span>Sun</div>
        <div><span style="display:inline-block; width:12px; height:12px; background:#60a5fa; border-radius:50%; margin-right:6px;"></span>Moon</div>
        <div><span style="display:inline-block; width:12px; height:12px; background:#f87171; border-radius:50%; margin-right:6px;"></span>Planets</div>
        <div><span style="display:inline-block; width:12px; height:12px; background:#fde047; border-radius:50%; margin-right:6px;"></span>Stars</div>
      </div>
    </div>

    <!-- Body Description Overlay -->
    <div id="body-description-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center; padding:20px;">
      <div style="background:var(--card); border-radius:12px; padding:30px; max-width:600px; width:100%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 40px rgba(0,0,0,0.3); position:relative;">
        <button onclick="closeBodyDescription()" style="position:absolute; top:15px; right:15px; background:var(--danger); color:#fff; border:none; border-radius:50%; width:36px; height:36px; font-size:1.5rem; cursor:pointer; line-height:1;">√ó</button>
        <h3 id="body-description-title" style="font-size:1.5rem; font-weight:700; color:var(--primary); margin-bottom:16px;"></h3>
        <div id="body-description-content" style="line-height:1.8; color:var(--text);"></div>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div id="tab-settings" class="tab-content">
    <div class="settings-panel">
      <div class="settings-group">
        <h3>üåê Language</h3>
        <div class="settings-row">
          <label>Display language</label>
          <select id="setting-language" onchange="applyLanguage()">
            <option value="en" selected>English</option>
            <option value="es">Espa√±ol (Spanish)</option>
            <option value="fr">Fran√ßais (French)</option>
            <option value="de">Deutsch (German)</option>
            <option value="pt">Portugu√™s (Portuguese)</option>
            <option value="it">Italiano (Italian)</option>
            <option value="ja">Êó•Êú¨Ë™û (Japanese)</option>
            <option value="zh">‰∏≠Êñá (Chinese)</option>
          </select>
        </div>
      </div>

      <div class="settings-group">
        <h3>üïê Time & GPS Updates</h3>
        <div class="settings-row">
          <label>Auto-refresh interval (seconds)</label>
          <input type="number" id="setting-refresh-interval" min="5" max="300" value="30" style="width:100px;">
        </div>
        <div class="settings-row">
          <label>Auto-refresh Time</label>
          <input type="checkbox" id="setting-autorefresh-time" checked>
        </div>
        <div class="settings-row">
          <label>Auto-refresh GPS Position</label>
          <input type="checkbox" id="setting-autorefresh-gps">
        </div>
      </div>

      <div class="settings-group">
        <h3>üìè Units</h3>
        <div class="settings-row">
          <label>Speed unit</label>
          <select id="setting-speed-unit" onchange="updateSpeedUnit()">
            <option value="knots" selected>Knots (kts)</option>
            <option value="ms">Meters/second (m/s)</option>
            <option value="kmh">Kilometers/hour (km/h)</option>
          </select>
        </div>
        <div class="settings-row">
          <label>Barometer unit</label>
          <select id="setting-barometer-unit" onchange="updateBarometerUnit()">
            <option value="mb" selected>Millibars (mb)</option>
            <option value="hPa">Hectopascals (hPa)</option>
            <option value="kPa">Kilopascals (kPa)</option>
            <option value="atm">Atmospheres (atm)</option>
            <option value="psi">PSI (psi)</option>
            <option value="bar">Bar (bar)</option>
            <option value="mmWC">mm Water Column (mmWC)</option>
            <option value="inHg">Inches Mercury (inHg)</option>
          </select>
        </div>
      </div>

      <div class="settings-group">
        <h3>üïê Time Format</h3>
        <div class="settings-row">
          <label>Time display format</label>
          <select id="setting-timeformat" onchange="applyTimeFormat()">
            <option value="24h" selected>24-hour (HH:MM:SS)</option>
            <option value="12h">12-hour (AM/PM)</option>
          </select>
        </div>
      </div>
      
      <div class="settings-group">
        <h3>üìê Coordinate Format</h3>
        <div class="settings-row">
          <label>Display format</label>
          <select id="setting-coordformat">
            <option value="dms" selected>Degrees Minutes (DD¬∞ MM.MMM')</option>
            <option value="decimal">Decimal Degrees (DD.DDDD¬∞)</option>
          </select>
        </div>
      </div>

      <div class="settings-group">
        <h3>üìä Display Options</h3>
        <div class="settings-row">
          <label>Show sun/moon cards</label>
          <input type="checkbox" id="setting-showcards" checked>
        </div>
        <div class="settings-row">
          <label>Show detail table</label>
          <input type="checkbox" id="setting-showtable" checked>
        </div>
        <div class="settings-row">
          <label>Show current positions</label>
          <input type="checkbox" id="setting-showcurrent" checked>
        </div>
      </div>

      <div class="settings-group">
        <h3>üé® Theme</h3>
        <div class="settings-row">
          <label>Color scheme</label>
          <select id="setting-theme" onchange="applyTheme()">
            <option value="auto">Auto (System)</option>
            <option value="professional-navy" selected>Professional Navy</option>
            <option value="midnight-dark">Midnight Dark</option>
            <option value="ocean-blue">Ocean Blue</option>
            <option value="aviation-grey">Aviation Grey</option>
            <option value="elegant-light">Elegant Light</option>
          </select>
        </div>
      </div>

      <div class="settings-group" style="border:none;">
        <div style="display:flex; gap:12px; justify-content:center; margin-top:10px; flex-wrap:wrap;">
          <button onclick="saveDefaultSettings()" style="background:var(--gradient-primary); color:#fff; border:none; padding:14px 28px; border-radius:8px; font-weight:700; font-size:1rem; cursor:pointer; box-shadow:var(--shadow-md); white-space:nowrap;">üíæ Save as Default</button>
          <button onclick="loadDefaultSettings()" style="background:var(--card); color:var(--text); border:2px solid var(--card-border); padding:14px 28px; border-radius:8px; font-weight:700; font-size:1rem; cursor:pointer; white-space:nowrap;">‚Üª Load Defaults</button>
          <button onclick="resetToSystemDefaults()" style="background:var(--danger); color:#fff; border:none; padding:14px 28px; border-radius:8px; font-weight:700; font-size:1rem; cursor:pointer; box-shadow:var(--shadow-md); white-space:nowrap;">‚ü≤ Reset to System</button>
        </div>
        <div id="settings-save-message" style="text-align:center; margin-top:12px; font-size:0.9rem; font-weight:600;"></div>
      </div>
    </div>
  </div>

  <!-- Compass Error Calculation Tab -->
  <div id="tab-compass" class="tab-content">
    <div class="settings-panel">
      <h3 style="font-size:1.3rem; font-weight:700; color:var(--primary); margin-bottom:20px; border-bottom:3px solid var(--primary); padding-bottom:10px;">üß≠ Compass Error Calculation</h3>
      
      <div class="settings-group">
        <h3>Select Celestial Object</h3>
        <div class="settings-row">
          <label>Object</label>
          <select id="compass-object" onchange="updateCompassObject()" style="flex:1; max-width:300px;">
            <option value="">-- Select Object --</option>
            <option value="Sun">‚òÄÔ∏è Sun</option>
            <option value="Moon">üåô Moon</option>
            <option value="Mercury">‚òø Mercury</option>
            <option value="Venus">‚ôÄ Venus</option>
            <option value="Mars">‚ôÇ Mars</option>
            <option value="Jupiter">‚ôÉ Jupiter</option>
            <option value="Saturn">‚ôÑ Saturn</option>
            <optgroup label="Navigation Stars">
              <option value="Sirius">Sirius</option>
              <option value="Canopus">Canopus</option>
              <option value="Arcturus">Arcturus</option>
              <option value="Vega">Vega</option>
              <option value="Capella">Capella</option>
              <option value="Rigel">Rigel</option>
              <option value="Procyon">Procyon</option>
              <option value="Betelgeuse">Betelgeuse</option>
              <option value="Altair">Altair</option>
              <option value="Aldebaran">Aldebaran</option>
              <option value="Spica">Spica</option>
              <option value="Antares">Antares</option>
              <option value="Pollux">Pollux</option>
              <option value="Fomalhaut">Fomalhaut</option>
              <option value="Deneb">Deneb</option>
            </optgroup>
          </select>
        </div>
        <div class="settings-row">
          <label>Or enter custom object name</label>
          <input type="text" id="compass-custom-object" placeholder="e.g., Polaris" style="flex:1; max-width:300px;">
        </div>
      </div>

      <div class="settings-group">
        <h3>Magnetic Variation</h3>
        <div class="settings-row">
          <label>Mode</label>
          <div style="display:flex; gap:8px;">
            <button id="magvar-auto-btn" onclick="setMagVarMode('auto')" style="background:var(--primary); color:#fff; border:none; padding:8px 16px; border-radius:6px; font-weight:700; cursor:pointer;">Auto</button>
            <button id="magvar-manual-btn" onclick="setMagVarMode('manual')" style="background:var(--card); color:var(--text); border:2px solid var(--card-border); padding:8px 16px; border-radius:6px; font-weight:700; cursor:pointer;">Manual</button>
          </div>
        </div>
        <div id="magvar-manual-inputs" style="display:none; margin-top:12px; padding:12px; background:var(--primary-light); border-radius:8px;">
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <label style="font-size:0.9rem; font-weight:700;">Value:</label>
            <input type="number" id="magvar-value" min="0" max="180" step="0.1" placeholder="0.0" style="width:100px; padding:8px; border:2px solid var(--card-border); border-radius:6px;" onchange="updateMagneticVariation()">
            <label style="font-size:0.9rem; font-weight:700;">Direction:</label>
            <select id="magvar-direction" onchange="updateMagneticVariation()" style="padding:8px 12px; border:2px solid var(--card-border); border-radius:6px; font-weight:600;">
              <option value="E">East (E)</option>
              <option value="W">West (W)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="settings-group">
        <h3>True Bearing (Auto-Calculated)</h3>
        <div style="background:var(--primary-light); padding:16px; border-radius:8px; border:2px solid var(--primary);">
          <div style="font-size:2rem; font-weight:700; color:var(--primary); font-family:'Courier New', monospace;" id="compass-true-bearing">---¬∞</div>
          <div style="font-size:0.85rem; color:var(--text-dim); margin-top:4px;">True Bearing of Selected Object</div>
        </div>
      </div>

      <div class="settings-group">
        <h3>Manual Input Fields</h3>
        <div class="settings-row">
          <label>Gyro Heading (¬∞)</label>
          <input type="number" id="compass-gyro-heading" min="0" max="360" step="0.1" placeholder="000.0" onchange="calculateCompassError()">
        </div>
        <div class="settings-row">
          <label>Magnetic Heading (¬∞)</label>
          <input type="number" id="compass-mag-heading" min="0" max="360" step="0.1" placeholder="000.0" onchange="calculateCompassError()">
        </div>
        <div class="settings-row">
          <label>Gyro Bearing of Object (¬∞)</label>
          <input type="number" id="compass-gyro-bearing" min="0" max="360" step="0.1" placeholder="000.0" onchange="calculateCompassError()">
        </div>
      </div>

      <div class="settings-group">
        <h3>Auto-Calculated Results</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
          <div style="background:var(--card); padding:16px; border-radius:8px; border:2px solid var(--card-border);">
            <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:6px; font-weight:700; text-transform:uppercase;">Magnetic Variation</div>
            <div style="font-size:1.5rem; font-weight:700; color:var(--primary); font-family:'Courier New', monospace;" id="compass-mag-variation">--¬∞</div>
          </div>
          <div style="background:var(--card); padding:16px; border-radius:8px; border:2px solid var(--card-border);">
            <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:6px; font-weight:700; text-transform:uppercase;">Gyro Error</div>
            <div style="font-size:1.5rem; font-weight:700; color:var(--gold); font-family:'Courier New', monospace;" id="compass-gyro-error">--¬∞</div>
          </div>
          <div style="background:var(--card); padding:16px; border-radius:8px; border:2px solid var(--card-border);">
            <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:6px; font-weight:700; text-transform:uppercase;">Magnetic Error</div>
            <div style="font-size:1.5rem; font-weight:700; color:var(--rose); font-family:'Courier New', monospace;" id="compass-mag-error">--¬∞</div>
          </div>
          <div style="background:var(--card); padding:16px; border-radius:8px; border:2px solid var(--card-border);">
            <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:6px; font-weight:700; text-transform:uppercase;">Deviation</div>
            <div style="font-size:1.5rem; font-weight:700; color:var(--secondary); font-family:'Courier New', monospace;" id="compass-deviation">--¬∞</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Marine Compass Tab -->
  <div id="tab-marinecompass" class="tab-content">
    <div class="settings-panel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:10px; border-bottom:3px solid var(--primary);">
        <h3 style="font-size:1.3rem; font-weight:700; color:var(--primary); margin:0;">‚öì Marine Compass & Navigation</h3>
        <div style="display:flex; align-items:center; gap:10px;">
          <div id="gps-status-indicator" style="display:flex; align-items:center; gap:8px; padding:8px 16px; background:var(--card); border:2px solid var(--card-border); border-radius:8px;">
            <div id="gps-status-dot" style="width:12px; height:12px; border-radius:50%; background:#666;"></div>
            <span id="gps-status-text" style="font-size:0.85rem; font-weight:700; color:var(--text-dim);">GPS Offline</span>
          </div>
        </div>
      </div>
      
      <!-- Compass Display -->
      <div style="position:relative; width:100%; max-width:400px; margin:0 auto 30px;">
        <canvas id="marineCompassCanvas" width="400" height="400" style="width:100%; height:auto;"></canvas>
      </div>

      <!-- Navigation Data Grid -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
        <div style="background:var(--primary-light); border:2px solid var(--primary); border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:0.75rem; color:var(--text-dim); font-weight:700; text-transform:uppercase; margin-bottom:8px;">COURSE (COG)</div>
          <div id="marine-cog" style="font-size:2.5rem; font-weight:700; color:var(--primary); font-family:'Courier New', monospace;">---¬∞</div>
        </div>
        <div style="background:var(--primary-light); border:2px solid var(--primary); border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:0.75rem; color:var(--text-dim); font-weight:700; text-transform:uppercase; margin-bottom:8px;">SPEED (SOG)</div>
          <div id="marine-sog" style="font-size:2.5rem; font-weight:700; color:var(--primary); font-family:'Courier New', monospace;">--- kts</div>
        </div>
      </div>

      <!-- GPS Position -->
      <div style="background:var(--card); border:2px solid var(--card-border); border-radius:12px; padding:24px; margin-top:20px;">
        <h4 style="font-size:0.9rem; font-weight:700; color:var(--primary); text-transform:uppercase; margin-bottom:16px; letter-spacing:0.1em;">GPS POSITION</h4>
        <div id="marine-position" style="font-size:1.3rem; font-weight:700; color:var(--text); font-family:'Courier New', monospace; text-align:center; line-height:2;">
          Waiting for GPS...
        </div>
      </div>
    </div>
  </div>

  <!-- Moon Phases Tab -->
  <div id="tab-moonphases" class="tab-content">
    <div class="settings-panel">
      <h3 style="font-size:1.3rem; font-weight:700; color:var(--primary); margin-bottom:20px; border-bottom:3px solid var(--primary); padding-bottom:10px;">üåô Moon Phases Calendar</h3>
      
      <div style="display:flex; gap:12px; align-items:center; margin-bottom:20px; flex-wrap:wrap; justify-content:space-between;">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <label style="font-size:1rem; font-weight:700; color:var(--text);">Month:</label>
          <select id="moonphase-month" onchange="updateMoonPhases()" style="background:var(--card); border:2px solid var(--card-border); border-radius:6px; padding:8px 12px; color:var(--text); font-size:0.95rem; font-weight:600;">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
          </select>
          <select id="moonphase-year" onchange="updateMoonPhases()" style="background:var(--card); border:2px solid var(--card-border); border-radius:6px; padding:8px 12px; color:var(--text); font-size:0.95rem; font-weight:600;">
          </select>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
          <label style="font-size:1rem; font-weight:700; color:var(--text);">View:</label>
          <select id="moonphase-view" onchange="updateMoonPhases()" style="background:var(--card); border:2px solid var(--card-border); border-radius:6px; padding:8px 12px; color:var(--text); font-size:0.95rem; font-weight:600;">
            <option value="grid" selected>Monthly Grid View</option>
            <option value="timeline">Timeline View</option>
            <option value="circular">Circular Lunar Cycle</option>
            <option value="minimal">Minimal Professional</option>
          </select>
        </div>
      </div>

      <div id="moonphase-calendar" style="background:var(--card); border:2px solid var(--card-border); border-radius:8px; padding:20px; overflow-x:auto;">
        <div style="text-align:center; padding:40px; color:var(--text-dim);">Loading calendar...</div>
      </div>
    </div>
  </div>

  <!-- Lunar Calendar Tab -->
  <div id="tab-lunarcalendar" class="tab-content">
    <div class="settings-panel">
      <h3 style="font-size:1.3rem; font-weight:700; color:var(--primary); margin-bottom:20px; border-bottom:3px solid var(--primary); padding-bottom:10px;">üìÖ Lunar Calendar</h3>
      
      <div style="display:flex; gap:12px; align-items:center; margin-bottom:20px; flex-wrap:wrap;">
        <label style="font-size:1rem; font-weight:700; color:var(--text);">Month:</label>
        <select id="lunarcal-month" onchange="updateLunarCalendar()" style="background:var(--card); border:2px solid var(--card-border); border-radius:6px; padding:8px 12px; color:var(--text); font-size:0.95rem; font-weight:600;">
          <option value="0">January</option>
          <option value="1">February</option>
          <option value="2">March</option>
          <option value="3">April</option>
          <option value="4">May</option>
          <option value="5">June</option>
          <option value="6">July</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">October</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
        <select id="lunarcal-year" onchange="updateLunarCalendar()" style="background:var(--card); border:2px solid var(--card-border); border-radius:6px; padding:8px 12px; color:var(--text); font-size:0.95rem; font-weight:600;">
        </select>
      </div>

      <div style="background:var(--card); border:2px solid var(--card-border); border-radius:12px; overflow-x:auto; box-shadow:var(--shadow-md);">
        <table id="lunarCalendarTable" style="width:100%; min-width:900px; border-collapse:collapse;">
          <thead>
            <tr style="background:var(--gradient-primary);">
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Date & Day</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Moonrise</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Azimuth</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Moonset</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Azimuth</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Phase</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Distance (km)</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Age (days)</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Visibility</th>
            </tr>
          </thead>
          <tbody id="lunarCalendarBody">
            <tr><td colspan="9" style="text-align:center; padding:30px; color:var(--text-dim);">Loading lunar data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Eclipses Tab -->
  <div id="tab-eclipses" class="tab-content">
    <div class="settings-panel">
      <h3 style="font-size:1.3rem; font-weight:700; color:var(--primary); margin-bottom:20px; border-bottom:3px solid var(--primary); padding-bottom:10px;">üåë Solar & Lunar Eclipses</h3>
      
      <div style="background:var(--primary-light); padding:20px; border-radius:8px; border:2px solid var(--primary); margin-bottom:24px;">
        <h4 style="font-size:1.1rem; font-weight:700; color:var(--primary); margin-bottom:16px;">üîÆ Next Eclipses</h4>
        
        <div style="margin-bottom:20px; background:var(--bg); padding:16px; border-radius:6px;">
          <div style="font-size:0.85rem; font-weight:700; color:var(--text-dim); text-transform:uppercase; margin-bottom:8px;">Next Lunar Eclipse</div>
          <div style="font-size:1.1rem; font-weight:700; color:var(--text); margin-bottom:4px;" id="eclipse-next-lunar-date">May 26, 2026</div>
          <div style="font-size:0.9rem; color:var(--text-dim); margin-bottom:2px;"><strong>UTC:</strong> <span id="eclipse-next-lunar-time-utc">11:18 UTC</span></div>
          <div style="font-size:0.9rem; color:var(--primary); margin-bottom:4px;"><strong>Local:</strong> <span id="eclipse-next-lunar-time-local">--:--</span></div>
          <div style="font-size:0.85rem; color:var(--text-dim);" id="eclipse-next-lunar-location">Total Lunar Eclipse - Visible from: Americas, Europe, Africa</div>
        </div>

        <div style="background:var(--bg); padding:16px; border-radius:6px;">
          <div style="font-size:0.85rem; font-weight:700; color:var(--text-dim); text-transform:uppercase; margin-bottom:8px;">Next Solar Eclipse</div>
          <div style="font-size:1.1rem; font-weight:700; color:var(--text); margin-bottom:4px;" id="eclipse-next-solar-date">August 12, 2026</div>
          <div style="font-size:0.9rem; color:var(--text-dim); margin-bottom:2px;"><strong>UTC:</strong> <span id="eclipse-next-solar-time-utc">17:47 UTC</span></div>
          <div style="font-size:0.9rem; color:var(--primary); margin-bottom:4px;"><strong>Local:</strong> <span id="eclipse-next-solar-time-local">--:--</span></div>
          <div style="font-size:0.85rem; color:var(--text-dim);" id="eclipse-next-solar-location">Total Solar Eclipse - Path: Arctic, Greenland, Iceland, Spain</div>
        </div>
      </div>

      <div style="background:var(--card); padding:20px; border-radius:8px; border:2px solid var(--card-border);">
        <h4 style="font-size:1.1rem; font-weight:700; color:var(--text); margin-bottom:16px;">üìú Last Eclipses</h4>
        
        <div style="margin-bottom:20px; background:var(--bg); padding:16px; border-radius:6px;">
          <div style="font-size:0.85rem; font-weight:700; color:var(--text-dim); text-transform:uppercase; margin-bottom:8px;">Last Lunar Eclipse</div>
          <div style="font-size:1.1rem; font-weight:700; color:var(--text); margin-bottom:4px;" id="eclipse-last-lunar-date">September 18, 2025</div>
          <div style="font-size:0.9rem; color:var(--text-dim); margin-bottom:2px;"><strong>UTC:</strong> <span id="eclipse-last-lunar-time-utc">02:44 UTC</span></div>
          <div style="font-size:0.9rem; color:var(--primary); margin-bottom:4px;"><strong>Local:</strong> <span id="eclipse-last-lunar-time-local">--:--</span></div>
          <div style="font-size:0.85rem; color:var(--text-dim);" id="eclipse-last-lunar-location">Partial Lunar Eclipse - Visible from: Americas, Europe, Africa, Western Asia</div>
        </div>

        <div style="background:var(--bg); padding:16px; border-radius:6px;">
          <div style="font-size:0.85rem; font-weight:700; color:var(--text-dim); text-transform:uppercase; margin-bottom:8px;">Last Solar Eclipse</div>
          <div style="font-size:1.1rem; font-weight:700; color:var(--text); margin-bottom:4px;" id="eclipse-last-solar-date">October 2, 2025</div>
          <div style="font-size:0.9rem; color:var(--text-dim); margin-bottom:2px;"><strong>UTC:</strong> <span id="eclipse-last-solar-time-utc">18:46 UTC</span></div>
          <div style="font-size:0.9rem; color:var(--primary); margin-bottom:4px;"><strong>Local:</strong> <span id="eclipse-last-solar-time-local">--:--</span></div>
          <div style="font-size:0.85rem; color:var(--text-dim);" id="eclipse-last-solar-location">Annular Solar Eclipse - Path: Pacific, Easter Island, Chile, Argentina</div>
        </div>
      </div>

      <div style="margin-top:20px; padding:16px; background:var(--primary-light); border-radius:8px; border:2px solid var(--primary);">
        <p style="font-size:0.85rem; color:var(--text-dim); line-height:1.6;"><strong>Note:</strong> Eclipse data is based on NASA predictions. Times shown in UTC. Actual visibility depends on weather conditions and local geography. Always verify with official sources for precise viewing information.</p>
      </div>
    </div>
  </div>

  <!-- Day/Night Duration Tab -->
  <div id="tab-daynight" class="tab-content">
    <div class="settings-panel">
      <h3 style="font-size:1.3rem; font-weight:700; color:var(--primary); margin-bottom:20px; border-bottom:3px solid var(--primary); padding-bottom:10px;">‚òÄÔ∏èüåô Day & Night Duration</h3>
      
      <div class="settings-group">
        <h3>Location Selection</h3>
        <div class="settings-row">
          <label>Country</label>
          <select id="daynight-country" onchange="updateDayNightTable()" style="flex:1; max-width:400px;">
            <option value="">-- Select Country --</option>
            <option value="US">United States</option>
            <option value="GB">United Kingdom</option>
            <option value="CA">Canada</option>
            <option value="AU">Australia</option>
            <option value="IN">India</option>
            <option value="JP">Japan</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="BR">Brazil</option>
            <option value="ZA">South Africa</option>
            <option value="NO">Norway</option>
            <option value="SE">Sweden</option>
            <option value="IS">Iceland</option>
            <option value="NZ">New Zealand</option>
            <option value="SG">Singapore</option>
          </select>
        </div>
        <div id="timezone-indicator" style="margin-top:12px; padding:12px; background:var(--primary-light); border-radius:8px; display:none;">
          <div style="font-size:0.85rem; color:var(--text); font-weight:600;"></div>
        </div>
      </div>

      <div class="settings-group">
        <h3>Table Duration</h3>
        <div class="settings-row">
          <label>Time Period</label>
          <select id="daynight-duration" onchange="updateDayNightTable()" style="flex:1; max-width:300px;">
            <option value="7">7 days</option>
            <option value="14">14 days</option>
            <option value="30" selected>30 days</option>
            <option value="90">90 days</option>
          </select>
        </div>
      </div>

      <div style="background:var(--card); border:2px solid var(--card-border); border-radius:12px; overflow-x:auto; box-shadow:var(--shadow-md); margin-top:20px;">
        <table id="dayNightTable" style="width:100%; min-width:800px; border-collapse:collapse;">
          <thead>
            <tr style="background:var(--gradient-primary);">
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Date</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Sunrise</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Sunset</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Day Duration</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Night Duration</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Civil Twilight</th>
              <th style="padding:14px; text-align:left; color:#fff; font-weight:700; font-size:0.85rem;">Nautical Twilight</th>
            </tr>
          </thead>
          <tbody id="dayNightTableBody">
            <tr><td colspan="7" style="text-align:center; padding:30px; color:var(--text-dim);">Please select a country to view day/night data.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- World Clock Tab -->
  <div id="tab-worldclock" class="tab-content">
    <div class="settings-panel">
      <h3 style="font-size:1.3rem; font-weight:700; color:var(--primary); margin-bottom:20px; border-bottom:3px solid var(--primary); padding-bottom:10px;">üåç World Clock</h3>
      
      <div style="display:flex; gap:16px; align-items:center; margin-bottom:24px; flex-wrap:wrap;">
        <div style="flex:1; min-width:200px;">
          <label style="display:block; font-size:0.85rem; font-weight:700; color:var(--text); margin-bottom:8px;">Add Country</label>
          <select id="worldclock-country" style="width:100%; background:var(--card); border:2px solid var(--card-border); border-radius:8px; padding:10px 12px; color:var(--text); font-size:0.95rem; font-weight:600;">
            <option value="">-- Select Country --</option>
            <option value="US-EST">USA (Eastern)</option>
            <option value="US-PST">USA (Pacific)</option>
            <option value="GB">United Kingdom</option>
            <option value="FR">France</option>
            <option value="DE">Germany</option>
            <option value="JP">Japan</option>
            <option value="CN">China</option>
            <option value="AU-AEST">Australia (Sydney)</option>
            <option value="IN">India</option>
            <option value="BR">Brazil</option>
            <option value="ZA">South Africa</option>
            <option value="AE">UAE</option>
            <option value="SG">Singapore</option>
            <option value="RU">Russia (Moscow)</option>
            <option value="MX">Mexico</option>
          </select>
        </div>
        <div>
          <label style="display:block; font-size:0.85rem; font-weight:700; color:var(--text); margin-bottom:8px;">Clock Type</label>
          <div style="display:flex; gap:12px;">
            <button onclick="setClockType('digital')" id="btn-digital" class="clock-type-btn active" style="background:var(--primary); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:700; cursor:pointer;">Digital</button>
            <button onclick="setClockType('analog')" id="btn-analog" class="clock-type-btn" style="background:var(--card); color:var(--text); border:2px solid var(--card-border); padding:10px 20px; border-radius:8px; font-weight:700; cursor:pointer;">Analog</button>
          </div>
        </div>
        <button onclick="addWorldClock()" style="background:var(--gradient-accent); color:#fff; border:none; padding:12px 24px; border-radius:8px; font-weight:700; cursor:pointer; align-self:flex-end; box-shadow:var(--shadow-sm);">Add Clock</button>
      </div>

      <div id="worldclock-container" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
        <div style="text-align:center; padding:40px; color:var(--text-dim); grid-column:1/-1;">
          Click "Add Clock" to display world clocks. Up to 8 clocks can be displayed simultaneously.
        </div>
      </div>
    </div>
  </div>

  <!-- About/Developer Tab -->
  <div id="tab-about" class="tab-content">
    <div class="dev-notes">
      <h3>Marine Celestial Calculation Tool</h3>
      <p><strong>Version:</strong> 2.0 | <strong>Last Updated:</strong> February 2026</p>
      
      <h4>üìã Overview</h4>
      <p>This application provides comprehensive celestial navigation calculations for mariners, astronomers, and navigation enthusiasts. All calculations are performed client-side using established astronomical algorithms.</p>

      <h4>‚ú® Features</h4>
      <ul>
        <li><strong>Real-time Position Tracking:</strong> Automatic GPS location detection with manual entry fallback</li>
        <li><strong>Sun & Moon Calculations:</strong> Rise/set times, azimuth, altitude, and twilight periods</li>
        <li><strong>57 Navigation Stars:</strong> Complete database of marine navigation stars with real-time positions</li>
        <li><strong>5 Visible Planets:</strong> Mercury, Venus, Mars, Jupiter, and Saturn tracking</li>
        <li><strong>UTC Time Display:</strong> Live UTC and local time with configurable offset</li>
        <li><strong>Marine Coordinates:</strong> Standard DD¬∞ MM.MMM' format used in nautical navigation</li>
        <li><strong>Responsive Design:</strong> Optimized for mobile, tablet, and desktop use</li>
      </ul>

      <h4>üî¨ Calculation Methods</h4>
      <p>This tool uses the following algorithms:</p>
      <ul>
        <li><strong>Solar Position:</strong> NOAA Solar Calculator algorithms (¬±0.1¬∞ accuracy)</li>
        <li><strong>Lunar Position:</strong> Simplified lunar theory with periodic corrections</li>
        <li><strong>Planetary Positions:</strong> VSOP87 orbital elements (low-precision implementation)</li>
        <li><strong>Star Positions:</strong> Right Ascension and Declination with LST calculations</li>
        <li><strong>Coordinate Conversion:</strong> WGS84 geodetic datum</li>
      </ul>

      <h4>üì± Browser Compatibility</h4>
      <p>Works on modern browsers supporting:</p>
      <ul>
        <li>Geolocation API (optional)</li>
        <li>ES6 JavaScript</li>
        <li>CSS Grid and Flexbox</li>
        <li>Date/Time APIs</li>
      </ul>

      <h4>üîí Privacy & Data</h4>
      <p>All calculations are performed locally in your browser. No data is sent to external servers. GPS coordinates are only accessed with your permission and are not stored or transmitted.</p>

      <h4>‚ö†Ô∏è Disclaimer</h4>
      <p>This tool is provided for educational and planning purposes. For actual marine navigation, always use certified nautical instruments and official publications. The accuracy of calculations may vary and should not be relied upon for critical navigation decisions.</p>

      <h4>üõ†Ô∏è Technical Details</h4>
      <p><strong>Refresh Rate:</strong> Calculations update every 30 seconds (configurable in settings)</p>
      <p><strong>Data Source:</strong> Client-side algorithms, no external APIs required</p>
      <p><strong>Coordinate Systems:</strong> WGS84, Equatorial (J2000), Ecliptic, Horizontal</p>
      <p><strong>Time Standards:</strong> UTC, Local Time with UTC offset</p>

      <h4>üìñ Usage Tips</h4>
      <ul>
        <li>Enable GPS for automatic location detection</li>
        <li>Use manual coordinates in format: <code>DD MM.MMM N/S</code></li>
        <li>Select any celestial body to see its current position and rise/set times</li>
        <li>Check the "Visible Now" tab to see all bodies currently above the horizon</li>
        <li>Adjust settings to customize display preferences</li>
      </ul>

      <h4>üìß Feedback</h4>
      <p>This tool is continuously improved. For questions, suggestions, or bug reports, please provide feedback through the appropriate channels.</p>
    </div>
  </div>

  <!-- Developer Note Tab -->
  <div id="tab-developer" class="tab-content">
    <div class="dev-notes">
      <h3 style="text-align:center; font-size:1.5rem; margin-bottom:30px;">Developer Information</h3>
      
      <div style="background:var(--primary-light); border:3px solid var(--primary); border-radius:12px; padding:40px; text-align:center; margin:40px 0;">
        <div style="font-size:3rem; margin-bottom:20px;">¬©Ô∏è</div>
        <p style="font-size:1.2rem; font-weight:700; color:var(--primary); line-height:2; margin-bottom:20px;">
          Created & Developed by<br/>
          <span style="font-size:1.5rem; color:var(--text);">Capt. Vijay A. Varma</span>
        </p>
        <p style="font-size:1rem; color:var(--text); line-height:1.8; margin-bottom:20px;">
          For Educational Purposes Only
        </p>
        <div style="border-top:2px solid var(--card-border); margin:30px 0; padding-top:30px;">
          <p style="font-size:0.95rem; color:var(--text-dim); line-height:1.8;">
            <strong style="color:var(--text);">¬© All Rights Reserved.</strong><br/>
            No unauthorized copying, redistribution, or reverse engineering is permitted<br/>
            without written consent of the developer.
          </p>
        </div>
      </div>

      <div style="background:var(--card); border:2px solid var(--card-border); border-radius:8px; padding:24px; margin-top:30px;">
        <h4 style="color:var(--primary); margin-bottom:12px;">Legal Notice</h4>
        <p style="font-size:0.9rem; color:var(--text-dim); line-height:1.8;">
          This software is protected by copyright law. The code, algorithms, design, and all associated materials are the intellectual property of Capt. Vijay A. Varma. Any attempt to copy, modify, redistribute, or reverse engineer this application without explicit written permission is strictly prohibited and may result in legal action.
        </p>
      </div>

      <div style="background:var(--card); border:2px solid var(--card-border); border-radius:8px; padding:24px; margin-top:20px;">
        <h4 style="color:var(--primary); margin-bottom:12px;">Contact</h4>
        <p style="font-size:0.9rem; color:var(--text-dim); line-height:1.8;">
          For licensing inquiries, permissions, or other questions, please contact the developer through official channels.
        </p>
      </div>
    </div>
  </div>

</div><!-- End Wrapper -->

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lat=null, lon=null;
let utcOffsetHours = 0; // Default UTC+0
let timeFormat = '24h'; // Default to 24-hour format
let appMode = 'online'; // online or offline
let cachedGPSData = null;
let cogValue = null; // Course Over Ground
let sogValue = null; // Speed Over Ground
let barometerValue = 1013.25; // Default pressure in mb
let speedUnit = 'knots';
let barometerUnit = 'mb';
let currentLanguage = 'en';
const datePicker = document.getElementById('datePicker');

// ‚îÄ‚îÄ‚îÄ Translation System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const translations = {
  en: {
    appTitle: 'Marine Celestial Calculation',
    appSubtitle: 'Sun ‚Ä¢ Moon ‚Ä¢ Planets ‚Ä¢ Stars ‚Ä¢ Navigation',
    gpsPosition: 'GPS POSITION',
    course: 'COG (Course)',
    speed: 'SOG (Speed)',
    barometer: 'Barometer',
    mode: 'Mode:',
    online: 'Online',
    offline: 'Offline',
    requesting: 'Requesting‚Ä¶',
    waiting: 'Waiting for location‚Ä¶',
    // Tabs
    tabMain: 'Main',
    tabVisible: 'Visible Now',
    tabCompass: 'Compass Error',
    tabMarineCompass: 'Marine Compass',
    tabMoonPhases: 'Moon Phases',
    tabLunarCalendar: 'Lunar Calendar',
    tabEclipses: 'Eclipses',
    tabDayNight: 'Day/Night',
    tabWorldClock: 'World Clock',
    tabSettings: 'Settings',
    tabAbout: 'About',
    tabDeveloper: 'Developer',
    // Settings
    language: 'Language',
    displayLanguage: 'Display language',
    saveDefaults: 'Save as Default Settings',
    loadDefaults: 'Load Defaults',
    resetDefaults: 'Reset to System Defaults',
    settingsSaved: '‚úì Settings saved as default successfully!',
    settingsLoaded: '‚úì Default settings loaded!',
    settingsReset: '‚úì Settings reset to system defaults!',
    noSettings: '‚ö† No saved settings found',
    // GPS Status
    gpsOnline: 'GPS Online',
    gpsOffline: 'GPS Offline',
    gpsOfflineCached: 'GPS Offline (Cached)',
    // Common
    date: 'Date',
    time: 'Time',
    latitude: 'Lat:',
    longitude: 'Long:',
    azimuth: 'Azimuth',
    altitude: 'Altitude',
    sunrise: 'Sunrise',
    sunset: 'Sunset',
    moonrise: 'Moonrise',
    moonset: 'Moonset'
  },
  es: {
    appTitle: 'C√°lculo Celestial Marino',
    appSubtitle: 'Sol ‚Ä¢ Luna ‚Ä¢ Planetas ‚Ä¢ Estrellas ‚Ä¢ Navegaci√≥n',
    gpsPosition: 'POSICI√ìN GPS',
    course: 'COG (Rumbo)',
    speed: 'SOG (Velocidad)',
    barometer: 'Bar√≥metro',
    mode: 'Modo:',
    online: 'En l√≠nea',
    offline: 'Desconectado',
    requesting: 'Solicitando‚Ä¶',
    waiting: 'Esperando ubicaci√≥n‚Ä¶',
    tabMain: 'Principal',
    tabVisible: 'Visible Ahora',
    tabCompass: 'Error de Br√∫jula',
    tabMarineCompass: 'Br√∫jula Marina',
    tabMoonPhases: 'Fases Lunares',
    tabLunarCalendar: 'Calendario Lunar',
    tabEclipses: 'Eclipses',
    tabDayNight: 'D√≠a/Noche',
    tabWorldClock: 'Reloj Mundial',
    tabSettings: 'Configuraci√≥n',
    tabAbout: 'Acerca de',
    tabDeveloper: 'Desarrollador',
    language: 'Idioma',
    displayLanguage: 'Idioma de visualizaci√≥n',
    saveDefaults: 'Guardar como Predeterminado',
    loadDefaults: 'Cargar Predeterminados',
    resetDefaults: 'Restablecer Predeterminados',
    settingsSaved: '‚úì Configuraci√≥n guardada correctamente!',
    settingsLoaded: '‚úì Configuraci√≥n predeterminada cargada!',
    settingsReset: '‚úì Configuraci√≥n restablecida!',
    noSettings: '‚ö† No se encontr√≥ configuraci√≥n guardada',
    gpsOnline: 'GPS En L√≠nea',
    gpsOffline: 'GPS Desconectado',
    gpsOfflineCached: 'GPS Desconectado (En Cach√©)',
    date: 'Fecha',
    time: 'Hora',
    latitude: 'Lat:',
    longitude: 'Long:',
    azimuth: 'Acimut',
    altitude: 'Altitud',
    sunrise: 'Amanecer',
    sunset: 'Atardecer',
    moonrise: 'Salida de Luna',
    moonset: 'Puesta de Luna'
  },
  fr: {
    appTitle: 'Calcul C√©leste Maritime',
    appSubtitle: 'Soleil ‚Ä¢ Lune ‚Ä¢ Plan√®tes ‚Ä¢ √âtoiles ‚Ä¢ Navigation',
    gpsPosition: 'POSITION GPS',
    course: 'COG (Route)',
    speed: 'SOG (Vitesse)',
    barometer: 'Barom√®tre',
    mode: 'Mode:',
    online: 'En ligne',
    offline: 'Hors ligne',
    requesting: 'Demande en cours‚Ä¶',
    waiting: 'En attente de localisation‚Ä¶',
    tabMain: 'Principal',
    tabVisible: 'Visible Maintenant',
    tabCompass: 'Erreur de Compas',
    tabMarineCompass: 'Compas Marine',
    tabMoonPhases: 'Phases Lunaires',
    tabLunarCalendar: 'Calendrier Lunaire',
    tabEclipses: '√âclipses',
    tabDayNight: 'Jour/Nuit',
    tabWorldClock: 'Horloge Mondiale',
    tabSettings: 'Param√®tres',
    tabAbout: '√Ä propos',
    tabDeveloper: 'D√©veloppeur',
    language: 'Langue',
    displayLanguage: 'Langue d\'affichage',
    saveDefaults: 'Enregistrer par D√©faut',
    loadDefaults: 'Charger les D√©fauts',
    resetDefaults: 'R√©initialiser aux D√©fauts',
    settingsSaved: '‚úì Param√®tres enregistr√©s avec succ√®s!',
    settingsLoaded: '‚úì Param√®tres par d√©faut charg√©s!',
    settingsReset: '‚úì Param√®tres r√©initialis√©s!',
    noSettings: '‚ö† Aucun param√®tre enregistr√© trouv√©',
    gpsOnline: 'GPS En Ligne',
    gpsOffline: 'GPS Hors Ligne',
    gpsOfflineCached: 'GPS Hors Ligne (En Cache)',
    date: 'Date',
    time: 'Heure',
    latitude: 'Lat:',
    longitude: 'Long:',
    azimuth: 'Azimut',
    altitude: 'Altitude',
    sunrise: 'Lever du soleil',
    sunset: 'Coucher du soleil',
    moonrise: 'Lever de lune',
    moonset: 'Coucher de lune'
  }
  // Add more languages as needed
};

function t(key) {
  return translations[currentLanguage]?.[key] || translations['en'][key] || key;
}

// Init date to today
datePicker.value = new Date().toISOString().slice(0,10);

// Init UTC offset to browser's timezone
(function(){
  const offset = -new Date().getTimezoneOffset() / 60;
  utcOffsetHours = offset;
  const sel = document.getElementById('utcOffset');
  const opt = Array.from(sel.options).find(o => parseFloat(o.value) === offset);
  if(opt) sel.value = opt.value;
})();

// ‚îÄ‚îÄ‚îÄ Mode Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let magVarMode = 'auto'; // auto or manual
let manualMagVar = 0;
let manualMagVarDir = 'E';

function setMode(mode){
  appMode = mode;
  
  // Update button styles
  document.getElementById('mode-online').style.background = mode === 'online' ? 'var(--primary)' : 'var(--card)';
  document.getElementById('mode-online').style.color = mode === 'online' ? '#fff' : 'var(--text)';
  document.getElementById('mode-online').style.border = mode === 'online' ? 'none' : '2px solid var(--card-border)';
  document.getElementById('mode-offline').style.background = mode === 'offline' ? 'var(--primary)' : 'var(--card)';
  document.getElementById('mode-offline').style.color = mode === 'offline' ? '#fff' : 'var(--text)';
  document.getElementById('mode-offline').style.border = mode === 'offline' ? 'none' : '2px solid var(--card-border)';
  
  // If switching to offline mode, ensure we have cached data
  if(mode === 'offline'){
    if(cachedGPSData){
      lat = cachedGPSData.lat;
      lon = cachedGPSData.lon;
      cogValue = cachedGPSData.cog;
      sogValue = cachedGPSData.sog;
      barometerValue = cachedGPSData.baro;
      
      updateCoordsUI();
      updateGPSDisplay();
      updateMarineCompass();
      compute();
      
      console.log('Switched to offline mode - using cached data');
    } else {
      alert('No cached GPS data available. Please get GPS location first in Online mode.');
      // Revert to online
      setMode('online');
      return;
    }
  }
  
  // If switching to online mode, clear requesting message if shown
  if(mode === 'online'){
    console.log('Switched to online mode - GPS updates enabled');
  }
  
  // Update GPS status indicator
  updateGPSStatus();
  
  // Save mode preference
  localStorage.setItem('appMode', mode);
  
  console.log('Mode set to:', mode);
}

function updateGPSStatus(){
  const isOnline = appMode === 'online' && lat !== null;
  const statusDot = document.getElementById('gps-status-dot');
  const statusText = document.getElementById('gps-status-text');
  
  if(statusDot && statusText){
    if(isOnline){
      statusDot.style.background = '#059669'; // Green
      statusText.textContent = 'GPS Online';
      statusText.style.color = '#059669';
    } else if(appMode === 'offline'){
      statusDot.style.background = '#f59e0b'; // Orange/Amber for offline
      statusText.textContent = 'GPS Offline (Cached)';
      statusText.style.color = '#f59e0b';
    } else {
      statusDot.style.background = '#666'; // Grey
      statusText.textContent = 'GPS Offline';
      statusText.style.color = 'var(--text-dim)';
    }
  }
}

function resetToSystemDefaults(){
  if(!confirm('Reset all settings to system defaults? This will clear all saved preferences.')){
    return;
  }
  
  // Clear localStorage
  localStorage.removeItem('marineCalcSettings');
  localStorage.removeItem('appMode');
  localStorage.removeItem('appLanguage');
  
  // Reset to default values
  document.getElementById('setting-language').value = 'en';
  document.getElementById('setting-refresh-interval').value = '30';
  document.getElementById('setting-autorefresh-time').checked = true;
  document.getElementById('setting-autorefresh-gps').checked = false;
  document.getElementById('setting-speed-unit').value = 'knots';
  document.getElementById('setting-barometer-unit').value = 'mb';
  document.getElementById('setting-timeformat').value = '24h';
  document.getElementById('setting-coordformat').value = 'dms';
  document.getElementById('setting-theme').value = 'professional-navy';
  document.getElementById('setting-showcards').checked = true;
  document.getElementById('setting-showtable').checked = true;
  document.getElementById('setting-showcurrent').checked = true;
  
  // Reset global state
  currentLanguage = 'en';
  timeFormat = '24h';
  speedUnit = 'knots';
  barometerUnit = 'mb';
  appMode = 'online';
  magVarMode = 'auto';
  
  // Apply changes
  applyLanguage();
  applyTimeFormat();
  applyTheme();
  setMode('online');
  updateSpeedUnit();
  updateBarometerUnit();
  
  const msg = document.getElementById('settings-save-message');
  msg.textContent = '‚úì Reset to system defaults complete!';
  msg.style.color = 'var(--success)';
  setTimeout(() => { msg.textContent = ''; }, 3000);
  
  console.log('Reset to system defaults complete');
}

// ‚îÄ‚îÄ‚îÄ Magnetic Variation Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMagVarMode(mode){
  magVarMode = mode;
  const autoBtn = document.getElementById('magvar-auto-btn');
  const manualBtn = document.getElementById('magvar-manual-btn');
  const manualInputs = document.getElementById('magvar-manual-inputs');
  
  if(mode === 'auto'){
    autoBtn.style.background = 'var(--primary)';
    autoBtn.style.color = '#fff';
    autoBtn.style.border = 'none';
    manualBtn.style.background = 'var(--card)';
    manualBtn.style.color = 'var(--text)';
    manualBtn.style.border = '2px solid var(--card-border)';
    manualInputs.style.display = 'none';
  } else {
    manualBtn.style.background = 'var(--primary)';
    manualBtn.style.color = '#fff';
    manualBtn.style.border = 'none';
    autoBtn.style.background = 'var(--card)';
    autoBtn.style.color = 'var(--text)';
    autoBtn.style.border = '2px solid var(--card-border)';
    manualInputs.style.display = 'block';
  }
  
  updateMagneticVariation();
}

function updateMagneticVariation(){
  if(magVarMode === 'manual'){
    const value = parseFloat(document.getElementById('magvar-value').value) || 0;
    const dir = document.getElementById('magvar-direction').value;
    manualMagVar = dir === 'W' ? -value : value;
    document.getElementById('compass-mag-variation').textContent = value.toFixed(1) + '¬∞ ' + dir;
  } else {
    // Auto mode - use calculated variation
    const magVar = getMagneticVariation(lat, lon);
    const magVarDir = magVar >= 0 ? 'E' : 'W';
    document.getElementById('compass-mag-variation').textContent = Math.abs(magVar).toFixed(1) + '¬∞ ' + magVarDir;
  }
}

// ‚îÄ‚îÄ‚îÄ Default Settings Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveDefaultSettings(){
  const settings = {
    language: document.getElementById('setting-language')?.value,
    refreshInterval: document.getElementById('setting-refresh-interval')?.value,
    autoRefreshTime: document.getElementById('setting-autorefresh-time')?.checked,
    autoRefreshGPS: document.getElementById('setting-autorefresh-gps')?.checked,
    speedUnit: document.getElementById('setting-speed-unit')?.value,
    barometerUnit: document.getElementById('setting-barometer-unit')?.value,
    timeFormat: document.getElementById('setting-timeformat')?.value,
    coordFormat: document.getElementById('setting-coordformat')?.value,
    theme: document.getElementById('setting-theme')?.value,
    showCards: document.getElementById('setting-showcards')?.checked,
    showTable: document.getElementById('setting-showtable')?.checked,
    showCurrent: document.getElementById('setting-showcurrent')?.checked,
    appMode: appMode,
    magVarMode: magVarMode,
    // World Clock & Day/Night defaults
    lastSelectedCountry: document.getElementById('daynight-country')?.value || '',
    lastSelectedDuration: document.getElementById('daynight-duration')?.value || '30'
  };
  
  localStorage.setItem('marineCalcSettings', JSON.stringify(settings));
  
  const msg = document.getElementById('settings-save-message');
  msg.textContent = t('settingsSaved');
  msg.style.color = 'var(--success)';
  setTimeout(() => { msg.textContent = ''; }, 3000);
  
  console.log('Settings saved:', settings);
}

function loadDefaultSettings(){
  const saved = localStorage.getItem('marineCalcSettings');
  if(!saved){
    const msg = document.getElementById('settings-save-message');
    msg.textContent = t('noSettings');
    msg.style.color = 'var(--danger)';
    setTimeout(() => { msg.textContent = ''; }, 3000);
    return;
  }
  
  const settings = JSON.parse(saved);
  
  if(settings.language) {
    document.getElementById('setting-language').value = settings.language;
    currentLanguage = settings.language;
    applyLanguage();
  }
  if(settings.refreshInterval) document.getElementById('setting-refresh-interval').value = settings.refreshInterval;
  if(settings.autoRefreshTime !== undefined) document.getElementById('setting-autorefresh-time').checked = settings.autoRefreshTime;
  if(settings.autoRefreshGPS !== undefined) document.getElementById('setting-autorefresh-gps').checked = settings.autoRefreshGPS;
  if(settings.speedUnit) {
    document.getElementById('setting-speed-unit').value = settings.speedUnit;
    speedUnit = settings.speedUnit;
  }
  if(settings.barometerUnit) {
    document.getElementById('setting-barometer-unit').value = settings.barometerUnit;
    barometerUnit = settings.barometerUnit;
  }
  if(settings.timeFormat) {
    document.getElementById('setting-timeformat').value = settings.timeFormat;
    timeFormat = settings.timeFormat;
  }
  if(settings.coordFormat) document.getElementById('setting-coordformat').value = settings.coordFormat;
  if(settings.theme) document.getElementById('setting-theme').value = settings.theme;
  if(settings.showCards !== undefined) document.getElementById('setting-showcards').checked = settings.showCards;
  if(settings.showTable !== undefined) document.getElementById('setting-showtable').checked = settings.showTable;
  if(settings.showCurrent !== undefined) document.getElementById('setting-showcurrent').checked = settings.showCurrent;
  if(settings.appMode) {
    appMode = settings.appMode;
    setMode(settings.appMode);
  }
  if(settings.magVarMode) {
    magVarMode = settings.magVarMode;
    setMagVarMode(settings.magVarMode);
  }
  if(settings.lastSelectedCountry) {
    const countryEl = document.getElementById('daynight-country');
    if(countryEl) countryEl.value = settings.lastSelectedCountry;
  }
  if(settings.lastSelectedDuration) {
    const durationEl = document.getElementById('daynight-duration');
    if(durationEl) durationEl.value = settings.lastSelectedDuration;
  }
  
  // Apply all settings
  applyTimeFormat();
  applyTheme();
  updateSpeedUnit();
  updateBarometerUnit();
  updateAllUIText();
  
  const msg = document.getElementById('settings-save-message');
  msg.textContent = t('settingsLoaded');
  msg.style.color = 'var(--success)';
  setTimeout(() => { msg.textContent = ''; }, 3000);
  
  console.log('Settings loaded:', settings);
}

function resetToSystemDefaults(){
  // Clear all saved settings
  localStorage.removeItem('marineCalcSettings');
  localStorage.removeItem('appLanguage');
  localStorage.removeItem('appMode');
  
  // Reset to system defaults
  document.getElementById('setting-language').value = 'en';
  document.getElementById('setting-refresh-interval').value = 30;
  document.getElementById('setting-autorefresh-time').checked = true;
  document.getElementById('setting-autorefresh-gps').checked = false;
  document.getElementById('setting-speed-unit').value = 'knots';
  document.getElementById('setting-barometer-unit').value = 'mb';
  document.getElementById('setting-timeformat').value = '24h';
  document.getElementById('setting-coordformat').value = 'dms';
  document.getElementById('setting-theme').value = 'professional-navy';
  document.getElementById('setting-showcards').checked = true;
  document.getElementById('setting-showtable').checked = true;
  document.getElementById('setting-showcurrent').checked = true;
  
  currentLanguage = 'en';
  speedUnit = 'knots';
  barometerUnit = 'mb';
  timeFormat = '24h';
  appMode = 'online';
  magVarMode = 'auto';
  
  // Apply defaults
  setMode('online');
  setMagVarMode('auto');
  applyTimeFormat();
  applyTheme();
  applyLanguage();
  updateSpeedUnit();
  updateBarometerUnit();
  
  const msg = document.getElementById('settings-save-message');
  msg.textContent = t('settingsReset');
  msg.style.color = 'var(--success)';
  setTimeout(() => { msg.textContent = ''; }, 3000);
  
  console.log('Settings reset to system defaults');
}

// ‚îÄ‚îÄ‚îÄ Language Application (Framework) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyLanguage(){
  const lang = document.getElementById('setting-language')?.value || 'en';
  currentLanguage = lang;
  
  // Save to localStorage
  localStorage.setItem('appLanguage', lang);
  
  console.log('Language set to:', lang);
  
  // Update all UI text elements
  updateAllUIText();
}

function updateAllUIText(){
  // Header
  const header = document.querySelector('.header h1');
  if(header) header.innerHTML = `Marine <em>Celestial</em> Calculation`;
  
  const subtitle = document.querySelector('.header p');
  if(subtitle) subtitle.textContent = t('appSubtitle');
  
  // GPS Section labels
  const gpsLabel = document.querySelector('.gps-info .label');
  if(gpsLabel) gpsLabel.textContent = t('gpsPosition');
  
  // Tab buttons - update text while preserving emojis
  document.querySelectorAll('.tab-btn').forEach(btn => {
    const text = btn.textContent.trim();
    if(text.includes('üìä')) btn.innerHTML = 'üìä ' + t('tabMain');
    if(text.includes('üëÅÔ∏è')) btn.innerHTML = 'üëÅÔ∏è ' + t('tabVisible');
    if(text.includes('üß≠') && !text.includes('‚öì')) btn.innerHTML = 'üß≠ ' + t('tabCompass');
    if(text.includes('‚öì')) btn.innerHTML = '‚öì ' + t('tabMarineCompass');
    if(text.includes('üåô') && !text.includes('‚òÄÔ∏è')) btn.innerHTML = 'üåô ' + t('tabMoonPhases');
    if(text.includes('üìÖ')) btn.innerHTML = 'üìÖ ' + t('tabLunarCalendar');
    if(text.includes('üåë')) btn.innerHTML = 'üåë ' + t('tabEclipses');
    if(text.includes('‚òÄÔ∏èüåô')) btn.innerHTML = '‚òÄÔ∏èüåô ' + t('tabDayNight');
    if(text.includes('üåç')) btn.innerHTML = 'üåç ' + t('tabWorldClock');
    if(text.includes('‚öôÔ∏è')) btn.innerHTML = '‚öôÔ∏è ' + t('tabSettings');
    if(text.includes('‚ÑπÔ∏è')) btn.innerHTML = '‚ÑπÔ∏è ' + t('tabAbout');
    if(text.includes('¬©Ô∏è')) btn.innerHTML = '¬©Ô∏è ' + t('tabDeveloper');
  });
  
  // Mode buttons
  const onlineBtn = document.getElementById('mode-online');
  const offlineBtn = document.getElementById('mode-offline');
  if(onlineBtn) onlineBtn.textContent = t('online');
  if(offlineBtn) offlineBtn.textContent = t('offline');
  
  // Update GPS status
  updateGPSStatus();
  
  console.log('UI text updated to language:', currentLanguage);
}

// ‚îÄ‚îÄ‚îÄ Unit Conversion Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function convertSpeed(speedInKnots, toUnit){
  switch(toUnit){
    case 'ms': return (speedInKnots * 0.514444).toFixed(2) + ' m/s';
    case 'kmh': return (speedInKnots * 1.852).toFixed(2) + ' km/h';
    default: return speedInKnots.toFixed(2) + ' kts';
  }
}

function convertPressure(pressureInMb, toUnit){
  switch(toUnit){
    case 'hPa': return pressureInMb.toFixed(2) + ' hPa';
    case 'kPa': return (pressureInMb * 0.1).toFixed(2) + ' kPa';
    case 'atm': return (pressureInMb / 1013.25).toFixed(4) + ' atm';
    case 'psi': return (pressureInMb * 0.0145038).toFixed(2) + ' psi';
    case 'bar': return (pressureInMb / 1000).toFixed(4) + ' bar';
    case 'mmWC': return (pressureInMb * 10.1972).toFixed(2) + ' mmWC';
    case 'inHg': return (pressureInMb * 0.02953).toFixed(2) + ' inHg';
    default: return pressureInMb.toFixed(2) + ' mb';
  }
}

function updateSpeedUnit(){
  speedUnit = document.getElementById('setting-speed-unit').value;
  updateGPSDisplay();
}

function updateBarometerUnit(){
  barometerUnit = document.getElementById('setting-barometer-unit').value;
  updateGPSDisplay();
}

function updateGPSDisplay(){
  console.log('updateGPSDisplay called - COG:', cogValue, 'SOG:', sogValue);
  
  const cogEl = document.getElementById('cog-display');
  const marineCogEl = document.getElementById('marine-cog');
  const sogEl = document.getElementById('sog-display');
  const marineSogEl = document.getElementById('marine-sog');
  const baroEl = document.getElementById('barometer-display');
  
  if(cogValue !== null){
    const cogText = cogValue.toFixed(1) + '¬∞';
    if(cogEl) cogEl.textContent = cogText;
    if(marineCogEl) marineCogEl.textContent = cogText;
  } else {
    if(cogEl) cogEl.textContent = '---¬∞';
    if(marineCogEl) marineCogEl.textContent = '---¬∞';
  }
  
  if(sogValue !== null){
    const sogText = convertSpeed(sogValue, speedUnit);
    if(sogEl) sogEl.textContent = sogText;
    if(marineSogEl) marineSogEl.textContent = sogText;
  } else {
    if(sogEl) sogEl.textContent = '--- kts';
    if(marineSogEl) marineSogEl.textContent = '--- kts';
  }
  
  if(baroEl){
    baroEl.textContent = convertPressure(barometerValue, barometerUnit);
  }
  
  console.log('GPS Display updated successfully');
}

// ‚îÄ‚îÄ‚îÄ Time Display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateTimeDisplay(){
  const now = new Date();
  
  // UTC time
  const utcHours = now.getUTCHours();
  const utcMins = String(now.getUTCMinutes()).padStart(2, '0');
  const utcSecs = String(now.getUTCSeconds()).padStart(2, '0');
  document.getElementById('utcTime').textContent = formatTime24or12(utcHours, utcMins, utcSecs);
  
  // Local time with offset
  const offsetVal = parseFloat(document.getElementById('utcOffset').value);
  utcOffsetHours = offsetVal;
  const localDate = new Date(now.getTime() + offsetVal * 3600000);
  const localHours = localDate.getUTCHours();
  const localMins = String(localDate.getUTCMinutes()).padStart(2, '0');
  const localSecs = String(localDate.getUTCSeconds()).padStart(2, '0');
  document.getElementById('localTime').textContent = formatTime24or12(localHours, localMins, localSecs);
  
  // Update offset display
  const sign = offsetVal >= 0 ? '+' : '';
  const hrs = Math.floor(Math.abs(offsetVal));
  const mins = Math.round((Math.abs(offsetVal) - hrs) * 60);
  const offsetStr = mins > 0 ? `${sign}${hrs}:${String(mins).padStart(2,'0')}` : `${sign}${hrs}`;
  document.getElementById('offsetDisplay').textContent = offsetStr;
}

function formatTime24or12(hours, minutes, seconds){
  if(timeFormat === '12h'){
    const period = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    return `${String(displayHours).padStart(2, '0')}:${minutes}:${seconds} ${period}`;
  }
  return `${String(hours).padStart(2, '0')}:${minutes}:${seconds}`;
}

function applyTimeFormat(){
  timeFormat = document.getElementById('setting-timeformat').value;
  // Update all time displays
  updateTimeDisplay();
  updateWorldClocks();
  updateEclipseTimes();
  if(lat !== null) {
    compute(); // Refresh all calculated times
  }
}

// Update time every second
setInterval(updateTimeDisplay, 1000);
updateTimeDisplay();

// ‚îÄ‚îÄ‚îÄ GPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fetchGPS(){
  console.log('fetchGPS called');
  const coordsEl = document.getElementById('coordsDisplay');
  if(coordsEl) coordsEl.textContent = 'Requesting‚Ä¶';
  
  if(!navigator.geolocation){ 
    showManual('Browser does not support GPS.'); 
    return; 
  }
  
  navigator.geolocation.getCurrentPosition(pos=>{
    console.log('GPS position received:', pos.coords);
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
    
    console.log('lat:', lat, 'lon:', lon);
    
    // Get COG and SOG if available (simulated if not available from browser)
    cogValue = pos.coords.heading !== null && pos.coords.heading !== undefined ? pos.coords.heading : 45 + Math.random() * 270;
    sogValue = pos.coords.speed !== null && pos.coords.speed !== undefined ? pos.coords.speed * 1.94384 : 5 + Math.random() * 10;
    
    console.log('COG:', cogValue, 'SOG:', sogValue);
    
    // Simulate barometer reading (would come from device sensor in production)
    barometerValue = 1013.25 + (Math.random() * 20 - 10);
    
    // Cache for offline mode
    cachedGPSData = {lat, lon, cog: cogValue, sog: sogValue, baro: barometerValue};
    
    console.log('About to call updateCoordsUI');
    updateCoordsUI();
    console.log('About to call updateGPSDisplay');
    updateGPSDisplay();
    console.log('About to call updateMarineCompass');
    updateMarineCompass();
    console.log('About to call updateGPSStatus');
    updateGPSStatus();
    
    const manualRow = document.getElementById('manualRow');
    if(manualRow) manualRow.classList.remove('show');
    
    console.log('About to call compute');
    compute();
  }, err=>{
    console.error('GPS error:', err);
    let reason='';
    switch(err.code){
      case err.PERMISSION_DENIED:
        reason='Permission denied. Please allow location access in your browser settings.';
        break;
      case err.POSITION_UNAVAILABLE:
        reason='Position unavailable. GPS signal not available.';
        break;
      case err.TIMEOUT:
        reason='Request timed out. Please try again.';
        break;
      default:
        reason='GPS error occurred.';
    }
    showManual(reason);
    updateGPSStatus();
  },{ timeout:10000, enableHighAccuracy:true });
}
function showManual(msg){
  document.getElementById('coordsDisplay').innerHTML=`<span class="gps-status">‚ö†Ô∏è ${msg}</span>`;
  document.getElementById('manualRow').classList.add('show');
  // Add helpful hint
  const hint = document.createElement('div');
  hint.style.cssText='grid-column:1/-1; font-size:.62rem; color:var(--text-dim); margin-top:4px; line-height:1.5;';
  hint.innerHTML='üí° <em>Tip:</em> Enable location in your browser settings, or enter coordinates manually above.';
  if(!document.querySelector('#manualRow .hint')){
    hint.className='hint';
    document.getElementById('manualRow').appendChild(hint);
  }
}
function applyManual(){
  const latInput = document.getElementById('manLat').value.trim();
  const lonInput = document.getElementById('manLon').value.trim();
  
  // Parse latitude
  let parsedLat = null;
  // Try marine format: DD MM.MMM N/S or DD¬∞MM.MMM'N/S
  const latMarineMatch = latInput.match(/^(\d{1,2})[¬∞\s]+(\d{1,2}(?:\.\d+)?)['\s]*([NS])$/i);
  if(latMarineMatch){
    const deg = parseInt(latMarineMatch[1]);
    const min = parseFloat(latMarineMatch[2]);
    const dir = latMarineMatch[3].toUpperCase();
    parsedLat = deg + min/60;
    if(dir === 'S') parsedLat = -parsedLat;
  } else {
    // Try decimal format
    parsedLat = parseFloat(latInput);
  }
  
  // Parse longitude
  let parsedLon = null;
  // Try marine format: DDD MM.MMM E/W or DDD¬∞MM.MMM'E/W
  const lonMarineMatch = lonInput.match(/^(\d{1,3})[¬∞\s]+(\d{1,2}(?:\.\d+)?)['\s]*([EW])$/i);
  if(lonMarineMatch){
    const deg = parseInt(lonMarineMatch[1]);
    const min = parseFloat(lonMarineMatch[2]);
    const dir = lonMarineMatch[3].toUpperCase();
    parsedLon = deg + min/60;
    if(dir === 'W') parsedLon = -parsedLon;
  } else {
    // Try decimal format
    parsedLon = parseFloat(lonInput);
  }
  
  // Validate
  if(isNaN(parsedLat) || isNaN(parsedLon) || parsedLat < -90 || parsedLat > 90 || parsedLon < -180 || parsedLon > 180){
    document.getElementById('coordsDisplay').innerHTML='<span class="gps-status">‚ö†Ô∏è Invalid coordinates. Use format: 40 42.768 N or decimal degrees.</span>';
    return;
  }
  
  lat = parsedLat;
  lon = parsedLon;
  
  // Simulate GPS data for manual coordinates
  cogValue = 45 + Math.random() * 270;
  sogValue = 5 + Math.random() * 10;
  barometerValue = 1013.25 + (Math.random() * 20 - 10);
  cachedGPSData = {lat, lon, cog: cogValue, sog: sogValue, baro: barometerValue};
  
  updateCoordsUI();
  updateGPSDisplay();
  updateMarineCompass();
  document.getElementById('manualRow').classList.remove('show');
  compute();
}
function updateCoordsUI(){
  if(lat === null || lon === null){
    console.log('updateCoordsUI: lat or lon is null');
    return;
  }
  
  // Convert decimal degrees to degrees and decimal minutes (marine format)
  const latDeg = Math.floor(Math.abs(lat));
  const latMin = ((Math.abs(lat) - latDeg) * 60).toFixed(3);
  const latDir = lat >= 0 ? 'N' : 'S';
  const latFormatted = `${t('latitude')} ${String(latDeg).padStart(2, '0')}¬∞${latMin.padStart(6, '0')}‚Ä≤ ${latDir}`;
  
  const lonDeg = Math.floor(Math.abs(lon));
  const lonMin = ((Math.abs(lon) - lonDeg) * 60).toFixed(3);
  const lonDir = lon >= 0 ? 'E' : 'W';
  const lonFormatted = `${t('longitude')} ${String(lonDeg).padStart(3, '0')}¬∞${lonMin.padStart(6, '0')}‚Ä≤ ${lonDir}`;
  
  const coordsText = `${latFormatted} | ${lonFormatted}`;
  const element = document.getElementById('coordsDisplay');
  
  if(element){
    element.textContent = coordsText;
    console.log('Coordinates updated:', coordsText);
  } else {
    console.error('coordsDisplay element not found');
  }
}

// ‚îÄ‚îÄ‚îÄ Date nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shiftDay(d){
  const dt=new Date(datePicker.value+'T12:00:00');
  dt.setDate(dt.getDate()+d);
  datePicker.value=dt.toISOString().slice(0,10);
  compute();
}

// ‚îÄ‚îÄ‚îÄ Solar math (NOAA-based) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toRad(d){return d*Math.PI/180;}
function toDeg(r){return r*180/Math.PI;}

function julianDay(date){
  return date.getTime()/86400000+2440587.5;
}
function solarCalc(date, latitude, longitude){
  // date = JS Date in UTC for the LOCAL noon of the target day
  const JD=julianDay(date);
  const n=JD-2451545.0;
  // Mean longitude & anomaly
  const L=(280.46646+0.9856474*n)%360;
  const M=(357.52911+0.9856003*n)%360;
  const Mrad=toRad(M);
  // Equation of center
  const C=Math.sin(Mrad)*(1.914602-0.004817*n/36525-0.000014*(n/36525)**2)
         +Math.sin(2*Mrad)*(0.019993-0.000101*n/36525)
         +Math.sin(3*Mrad)*0.000289;
  const sunLon=L+C; // Sun true longitude
  const v=M+C;      // Sun true anomaly
  // Sun radius vector (AU)
  const R=(1.000001018*(1-0.016709*0.016709-0.000042*0.000042))/(1+0.016709*Math.cos(toRad(v)));
  // Apparent longitude
  const omega=125.04-1934.136*n/36525;
  const sunAppLon=sunLon-0.00569-0.00478*Math.sin(toRad(omega));
  // Obliquity of ecliptic
  const eps=23.439291-0.0130042*n/36525+0.00000016*(n/36525)**2;
  const epsCorr=eps+0.00256*Math.cos(toRad(omega));
  // Sun declination
  const sinDec=Math.sin(toRad(epsCorr))*Math.sin(toRad(sunAppLon));
  const dec=toDeg(Math.asin(sinDec));
  // Equation of time (minutes)
  const y=Math.tan(toRad(epsCorr/2))**2;
  const Lrad=toRad(L), Mrad2=toRad(M);
  const EqT=4*toDeg(y*Math.sin(2*Lrad)-2*0.016709*Math.sin(Mrad2)+4*0.016709*y*Math.sin(Mrad2)*Math.cos(2*Lrad)-0.5*y*y*Math.sin(4*Lrad)-1.25*0.016709*0.016709*Math.sin(2*Mrad2));

  return {dec, EqT, R};
}

function solarTime(date, lat, lon, event){
  // event: 'sunrise','sunset','solar_noon','civil_twilight_start','civil_twilight_end','nautical_twilight_start','nautical_twilight_end','astro_twilight_start','astro_twilight_end'
  const {dec, EqT}=solarCalc(date, lat, lon);
  const latRad=toRad(lat), decRad=toRad(dec);

  let cosHA;
  switch(event){
    case 'sunrise': case 'sunset':
      cosHA=(Math.cos(toRad(90.833))-Math.sin(latRad)*Math.sin(decRad))/(Math.cos(latRad)*Math.cos(decRad)); break;
    case 'civil_twilight_start': case 'civil_twilight_end':
      cosHA=(Math.cos(toRad(96))-Math.sin(latRad)*Math.sin(decRad))/(Math.cos(latRad)*Math.cos(decRad)); break;
    case 'nautical_twilight_start': case 'nautical_twilight_end':
      cosHA=(Math.cos(toRad(102))-Math.sin(latRad)*Math.sin(decRad))/(Math.cos(latRad)*Math.cos(decRad)); break;
    case 'astro_twilight_start': case 'astro_twilight_end':
      cosHA=(Math.cos(toRad(108))-Math.sin(latRad)*Math.sin(decRad))/(Math.cos(latRad)*Math.cos(decRad)); break;
    case 'solar_noon':
      cosHA=0; break;
    default: cosHA=0;
  }
  if(event==='solar_noon'){
    const noon=(720-4*lon-EqT)/1440; // fraction of day UTC
    return noon*1440; // minutes from midnight UTC
  }
  if(cosHA<-1||cosHA>1) return null; // sun never rises/sets
  const HA=toDeg(Math.acos(cosHA));
  const rise=(720-4*lon-EqT-HA*4)/1440;
  const set =(720-4*lon-EqT+HA*4)/1440;
  if(event.includes('start')||event==='sunrise') return rise*1440;
  return set*1440;
}

function sunPosition(date, lat, lon){
  // Returns {azimuth, altitude} for a given UTC Date
  const {dec, EqT}=solarCalc(date, lat, lon);
  // Hours since midnight UTC
  const h=date.getUTCHours()+date.getUTCMinutes()/60+date.getUTCSeconds()/3600;
  // Solar time
  const solT=h*60+EqT+4*lon;
  // Hour angle
  const HA=(solT/4-180);
  const latR=toRad(lat), decR=toRad(dec), HAR=toRad(HA);
  const sinAlt=Math.sin(latR)*Math.sin(decR)+Math.cos(latR)*Math.cos(decR)*Math.cos(HAR);
  const alt=toDeg(Math.asin(sinAlt));
  const cosAz=(Math.sin(decR)-Math.sin(latR)*sinAlt)/(Math.cos(latR)*Math.cos(toRad(alt)));
  let az=toDeg(Math.acos(Math.max(-1,Math.min(1,cosAz))));
  if(HA>0) az=360-az;
  return {azimuth:az, altitude:alt};
}

// ‚îÄ‚îÄ‚îÄ Moon calculations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function moonPosition(date, lat, lon){
  // Simplified moon position calculation
  const JD=julianDay(date);
  const T=(JD-2451545.0)/36525;
  
  // Moon's mean longitude
  const L0=218.316+481267.881*T;
  // Moon's mean elongation
  const D=297.85+445267.11*T;
  // Sun's mean anomaly
  const M=357.53+35999.05*T;
  // Moon's mean anomaly
  const M1=134.96+477198.87*T;
  // Moon's argument of latitude
  const F=93.27+483202.02*T;
  
  // Longitude
  const lon_moon=(L0 
    +6.29*Math.sin(toRad(M1))
    -1.27*Math.sin(toRad(M1-2*D))
    +0.66*Math.sin(toRad(2*D))
    +0.21*Math.sin(toRad(2*M1))
    -0.19*Math.sin(toRad(M))
    -0.11*Math.sin(toRad(2*F)))%360;
  
  // Latitude
  const lat_moon=(5.13*Math.sin(toRad(F))
    +0.28*Math.sin(toRad(M1+F))
    -0.28*Math.sin(toRad(F-M1))
    -0.17*Math.sin(toRad(F-2*D)));
  
  // Convert to RA/Dec
  const eps=23.439-0.0000004*T;
  const lambda=toRad(lon_moon);
  const beta=toRad(lat_moon);
  const epsR=toRad(eps);
  
  const RA=toDeg(Math.atan2(Math.sin(lambda)*Math.cos(epsR)-Math.tan(beta)*Math.sin(epsR), Math.cos(lambda)));
  const dec=toDeg(Math.asin(Math.sin(beta)*Math.cos(epsR)+Math.cos(beta)*Math.sin(epsR)*Math.sin(lambda)));
  
  // Local sidereal time
  const UT=date.getUTCHours()+date.getUTCMinutes()/60+date.getUTCSeconds()/3600;
  const JD0=Math.floor(JD-0.5)+0.5;
  const S=JD0-2451545.0;
  const T0=S/36525.0;
  const theta0=100.46061837+36000.770053608*T0+0.000387933*T0*T0;
  const theta=(theta0+360.98564724*UT/24+lon)%360;
  
  // Hour angle
  const HA=(theta-RA+360)%360;
  const HAr=toRad(HA);
  const latR=toRad(lat);
  const decR=toRad(dec);
  
  // Altitude & Azimuth
  const sinAlt=Math.sin(latR)*Math.sin(decR)+Math.cos(latR)*Math.cos(decR)*Math.cos(HAr);
  const alt=toDeg(Math.asin(sinAlt));
  
  const cosA=(Math.sin(decR)-Math.sin(latR)*sinAlt)/(Math.cos(latR)*Math.cos(toRad(alt)));
  let az=toDeg(Math.acos(Math.max(-1,Math.min(1,cosA))));
  if(Math.sin(HAr)>0) az=360-az;
  
  return {azimuth:az, altitude:alt, RA, dec, lon:lon_moon, lat:lat_moon};
}

function moonPhase(date){
  const JD=julianDay(date);
  const T=(JD-2451545.0)/36525;
  
  const D=297.85+445267.11*T;
  const M=357.53+35999.05*T;
  const M1=134.96+477198.87*T;
  
  const phase=(D+6.29*Math.sin(toRad(M1))-1.27*Math.sin(toRad(M1-2*D)))%360;
  const illumination=50*(1-Math.cos(toRad(phase)));
  
  let phaseName;
  if(phase<22.5||phase>=337.5) phaseName='New Moon';
  else if(phase<67.5) phaseName='Waxing Crescent';
  else if(phase<112.5) phaseName='First Quarter';
  else if(phase<157.5) phaseName='Waxing Gibbous';
  else if(phase<202.5) phaseName='Full Moon';
  else if(phase<247.5) phaseName='Waning Gibbous';
  else if(phase<292.5) phaseName='Last Quarter';
  else phaseName='Waning Crescent';
  
  return {phaseName, illumination:illumination.toFixed(0)+'%', phase};
}

function moonRiseSet(date, lat, lon){
  // Simplified calculation - search for altitude crossing 0¬∞
  const baseDate=new Date(date);
  baseDate.setUTCHours(0,0,0,0);
  
  let rise=null, set=null;
  let wasAbove=false;
  
  // Sample every 10 minutes
  for(let mins=0; mins<1440; mins+=10){
    const testDate=new Date(baseDate.getTime()+mins*60000);
    const pos=moonPosition(testDate, lat, lon);
    const isAbove=pos.altitude>0;
    
    if(mins===0){
      wasAbove=isAbove;
      continue;
    }
    
    if(!wasAbove && isAbove && rise===null){
      rise=mins-5; // Rough midpoint
    }
    if(wasAbove && !isAbove && set===null){
      set=mins-5;
    }
    wasAbove=isAbove;
  }
  
  return {rise, set};
}

// ‚îÄ‚îÄ‚îÄ Navigation Stars Database ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NAVIGATION_STARS = {
  // Format: {ra: right ascension (hours), dec: declination (degrees), mag: magnitude}
  'Sirius': {ra: 6.7525, dec: -16.7161, mag: -1.46},
  'Canopus': {ra: 6.3992, dec: -52.6957, mag: -0.74},
  'Arcturus': {ra: 14.2612, dec: 19.1825, mag: -0.05},
  'Rigel Kentaurus': {ra: 14.6612, dec: -60.8372, mag: -0.01},
  'Vega': {ra: 18.6156, dec: 38.7836, mag: 0.03},
  'Capella': {ra: 5.2781, dec: 45.9981, mag: 0.08},
  'Rigel': {ra: 5.2423, dec: -8.2017, mag: 0.13},
  'Procyon': {ra: 7.6553, dec: 5.2250, mag: 0.34},
  'Achernar': {ra: 1.6285, dec: -57.2367, mag: 0.46},
  'Betelgeuse': {ra: 5.9195, dec: 7.4070, mag: 0.50},
  'Hadar': {ra: 14.0637, dec: -60.3730, mag: 0.61},
  'Altair': {ra: 19.8464, dec: 8.8683, mag: 0.77},
  'Acrux': {ra: 12.4433, dec: -63.0990, mag: 0.77},
  'Aldebaran': {ra: 4.5989, dec: 16.5093, mag: 0.85},
  'Spica': {ra: 13.4199, dec: -11.1613, mag: 0.98},
  'Antares': {ra: 16.4901, dec: -26.4320, mag: 1.06},
  'Pollux': {ra: 7.7553, dec: 28.0262, mag: 1.14},
  'Fomalhaut': {ra: 22.9608, dec: -29.6222, mag: 1.16},
  'Deneb': {ra: 20.6906, dec: 45.2803, mag: 1.25},
  'Mimosa': {ra: 12.7953, dec: -59.6889, mag: 1.25},
  'Regulus': {ra: 10.1395, dec: 11.9672, mag: 1.35},
  'Adhara': {ra: 6.9770, dec: -28.9721, mag: 1.50},
  'Castor': {ra: 7.5767, dec: 31.8883, mag: 1.58},
  'Gacrux': {ra: 12.5194, dec: -57.1131, mag: 1.63},
  'Shaula': {ra: 17.5600, dec: -37.1038, mag: 1.63},
  'Bellatrix': {ra: 5.4188, dec: 6.3497, mag: 1.64},
  'Elnath': {ra: 5.4381, dec: 28.6075, mag: 1.65},
  'Miaplacidus': {ra: 9.2200, dec: -69.7172, mag: 1.68},
  'Alnilam': {ra: 5.6036, dec: -1.2019, mag: 1.69},
  'Alnitak': {ra: 5.6794, dec: -1.9425, mag: 1.77},
  'Alioth': {ra: 12.9004, dec: 55.9598, mag: 1.77},
  'Mirfak': {ra: 3.4054, dec: 49.8612, mag: 1.79},
  'Kaus Australis': {ra: 18.4029, dec: -34.3846, mag: 1.79},
  'Alkaid': {ra: 13.7923, dec: 49.3133, mag: 1.86},
  'Avior': {ra: 8.3752, dec: -59.5097, mag: 1.86},
  'Sargas': {ra: 17.6220, dec: -42.9976, mag: 1.87},
  'Menkalinan': {ra: 5.9925, dec: 44.9475, mag: 1.90},
  'Atria': {ra: 16.8110, dec: -69.0277, mag: 1.92},
  'Alhena': {ra: 6.6287, dec: 16.3993, mag: 1.93},
  'Peacock': {ra: 20.4274, dec: -56.7350, mag: 1.94},
  'Mirzam': {ra: 6.3783, dec: -17.9559, mag: 1.98},
  'Alphard': {ra: 9.4597, dec: -8.6586, mag: 1.98},
  'Hamal': {ra: 2.1196, dec: 23.4624, mag: 2.00},
  'Polaris': {ra: 2.5301, dec: 89.2641, mag: 1.98},
  'Algieba': {ra: 10.3328, dec: 19.8414, mag: 2.08},
  'Diphda': {ra: 0.7265, dec: -17.9867, mag: 2.04},
  'Mizar': {ra: 13.3988, dec: 54.9254, mag: 2.04},
  'Nunki': {ra: 18.9210, dec: -26.2967, mag: 2.02},
  'Suhail': {ra: 9.1332, dec: -43.4326, mag: 2.21},
  'Alpheratz': {ra: 0.1397, dec: 29.0906, mag: 2.06},
  'Kochab': {ra: 14.8451, dec: 74.1553, mag: 2.08},
  'Rasalhague': {ra: 17.5822, dec: 12.5600, mag: 2.08},
  'Algol': {ra: 3.1361, dec: 40.9556, mag: 2.12},
  'Denebola': {ra: 11.8176, dec: 14.5719, mag: 2.14},
  'Gienah': {ra: 12.2634, dec: -17.5419, mag: 2.59},
  'Alphecca': {ra: 15.5781, dec: 26.7147, mag: 2.23},
  'Navi': {ra: 0.9453, dec: 60.7167, mag: 2.27},
  'Zubenelgenubi': {ra: 14.8479, dec: -16.0417, mag: 2.75},
  'Eltanin': {ra: 17.9434, dec: 51.4889, mag: 2.23},
  'Schedar': {ra: 0.6751, dec: 56.5372, mag: 2.23},
  'Sabik': {ra: 17.1729, dec: -15.7249, mag: 2.43},
  'Phecda': {ra: 11.8971, dec: 53.6948, mag: 2.44},
  'Ankaa': {ra: 0.4381, dec: -42.3061, mag: 2.39},
  'Scheat': {ra: 23.0628, dec: 28.0828, mag: 2.42},
  'Alderamin': {ra: 21.3099, dec: 62.5856, mag: 2.44},
  'Enif': {ra: 21.7364, dec: 9.8750, mag: 2.39},
  'Markab': {ra: 23.0793, dec: 15.2053, mag: 2.49},
  'Acamar': {ra: 2.9710, dec: -40.3047, mag: 2.88},
  'Menkar': {ra: 3.0380, dec: 4.0897, mag: 2.53},
  'Dubhe': {ra: 11.0621, dec: 61.7510, mag: 1.79}
};

// ‚îÄ‚îÄ‚îÄ Planet Calculations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function planetPosition(planetName, date, lat, lon){
  const JD = julianDay(date);
  const T = (JD - 2451545.0) / 36525; // Julian centuries from J2000
  
  let L, a, e, i, omega, Omega, M;
  
  // Orbital elements (simplified VSOP87)
  switch(planetName){
    case 'Mercury':
      L = 252.25 + 149472.67 * T;
      a = 0.387098;
      e = 0.205635 + 0.000559 * T;
      i = 7.005 + 0.0018 * T;
      omega = 77.456 + 0.0000436 * T;
      Omega = 48.331 + 0.0000469 * T;
      break;
    case 'Venus':
      L = 181.98 + 58517.82 * T;
      a = 0.723330;
      e = 0.006773 - 0.000048 * T;
      i = 3.395 + 0.0010 * T;
      omega = 131.564 + 0.00046 * T;
      Omega = 76.680 - 0.00077 * T;
      break;
    case 'Mars':
      L = 355.43 + 19140.30 * T;
      a = 1.523688;
      e = 0.093405 + 0.000093 * T;
      i = 1.850 - 0.00006 * T;
      omega = 336.060 + 0.00014 * T;
      Omega = 49.558 - 0.00027 * T;
      break;
    case 'Jupiter':
      L = 34.35 + 3034.91 * T;
      a = 5.202603;
      e = 0.048498 + 0.000163 * T;
      i = 1.303 - 0.00020 * T;
      omega = 14.331 + 0.00021 * T;
      Omega = 100.464 + 0.00015 * T;
      break;
    case 'Saturn':
      L = 50.08 + 1222.11 * T;
      a = 9.554909;
      e = 0.055546 - 0.000346 * T;
      i = 2.489 - 0.00037 * T;
      omega = 93.057 + 0.00023 * T;
      Omega = 113.665 + 0.00019 * T;
      break;
    default:
      return null;
  }
  
  // Mean anomaly
  M = (L - omega) % 360;
  if(M < 0) M += 360;
  const Mr = toRad(M);
  
  // Solve Kepler's equation (simplified)
  let E = Mr;
  for(let iter = 0; iter < 10; iter++){
    E = Mr + e * Math.sin(E);
  }
  
  // True anomaly
  const v = 2 * Math.atan2(Math.sqrt(1+e) * Math.sin(E/2), Math.sqrt(1-e) * Math.cos(E/2));
  
  // Distance
  const r = a * (1 - e * Math.cos(E));
  
  // Heliocentric coordinates
  const omegaR = toRad(omega);
  const OmegaR = toRad(Omega);
  const iR = toRad(i);
  
  const xh = r * (Math.cos(OmegaR) * Math.cos(omegaR + v) - Math.sin(OmegaR) * Math.sin(omegaR + v) * Math.cos(iR));
  const yh = r * (Math.sin(OmegaR) * Math.cos(omegaR + v) + Math.cos(OmegaR) * Math.sin(omegaR + v) * Math.cos(iR));
  const zh = r * Math.sin(omegaR + v) * Math.sin(iR);
  
  // Earth's position (simplified)
  const Le = 280.46 + 36000.77 * T;
  const Me = 357.53 + 35999.05 * T;
  const MeR = toRad(Me);
  const C = 1.915 * Math.sin(MeR) + 0.020 * Math.sin(2*MeR);
  const sunLon = Le + C;
  const sunR = 1.00014 - 0.01671 * Math.cos(MeR) - 0.00014 * Math.cos(2*MeR);
  
  const sunLonR = toRad(sunLon);
  const xe = -sunR * Math.cos(sunLonR);
  const ye = -sunR * Math.sin(sunLonR);
  const ze = 0;
  
  // Geocentric coordinates
  const xg = xh + xe;
  const yg = yh + ye;
  const zg = zh + ze;
  
  // Ecliptic longitude and latitude
  const lonEcl = toDeg(Math.atan2(yg, xg));
  const latEcl = toDeg(Math.atan2(zg, Math.sqrt(xg*xg + yg*yg)));
  
  // Convert to equatorial (RA/Dec)
  const eps = 23.439291 - 0.0130042 * T; // Obliquity
  const epsR = toRad(eps);
  const lonR = toRad(lonEcl);
  const latR = toRad(latEcl);
  
  const RA = toDeg(Math.atan2(Math.sin(lonR) * Math.cos(epsR) - Math.tan(latR) * Math.sin(epsR), Math.cos(lonR)));
  const dec = toDeg(Math.asin(Math.sin(latR) * Math.cos(epsR) + Math.cos(latR) * Math.sin(epsR) * Math.sin(lonR)));
  
  // Local Sidereal Time
  const UT = date.getUTCHours() + date.getUTCMinutes()/60 + date.getUTCSeconds()/3600;
  const JD0 = Math.floor(JD - 0.5) + 0.5;
  const S = JD0 - 2451545.0;
  const T0 = S / 36525.0;
  const theta0 = 100.46061837 + 36000.770053608*T0 + 0.000387933*T0*T0;
  const LST = (theta0 + 360.98564724*UT/24 + lon) % 360;
  
  // Hour Angle
  const HA = (LST - RA + 360) % 360;
  const HAr = toRad(HA);
  const latRad = toRad(lat);
  const decRad = toRad(dec);
  
  // Altitude
  const sinAlt = Math.sin(latRad)*Math.sin(decRad) + Math.cos(latRad)*Math.cos(decRad)*Math.cos(HAr);
  const alt = toDeg(Math.asin(sinAlt));
  
  // Azimuth
  const cosA = (Math.sin(decRad) - Math.sin(latRad)*sinAlt) / (Math.cos(latRad)*Math.cos(toRad(alt)));
  let az = toDeg(Math.acos(Math.max(-1, Math.min(1, cosA))));
  if(Math.sin(HAr) > 0) az = 360 - az;
  
  return {azimuth: az, altitude: alt, RA: RA/15, dec: dec, distance: Math.sqrt(xg*xg+yg*yg+zg*zg)};
}

function planetRiseSetTransit(planetName, date, lat, lon){
  // Similar to star calculations but search for planet position
  const baseDate = new Date(date);
  baseDate.setUTCHours(0, 0, 0, 0);
  
  let transitMins = null, riseMins = null, setMins = null;
  let maxAlt = -90;
  
  // Search through the day
  for(let mins = 0; mins < 1440; mins += 10){
    const testDate = new Date(baseDate.getTime() + mins*60000);
    const pos = planetPosition(planetName, testDate, lat, lon);
    
    if(!pos) continue;
    
    // Track highest altitude for transit
    if(pos.altitude > maxAlt){
      maxAlt = pos.altitude;
      transitMins = mins;
    }
    
    // Check for rise/set (altitude crossing 0)
    if(mins > 0){
      const prevDate = new Date(baseDate.getTime() + (mins-10)*60000);
      const prevPos = planetPosition(planetName, prevDate, lat, lon);
      
      if(prevPos){
        if(prevPos.altitude <= 0 && pos.altitude > 0 && riseMins === null){
          riseMins = mins - 5;
        }
        if(prevPos.altitude > 0 && pos.altitude <= 0 && setMins === null){
          setMins = mins - 5;
        }
      }
    }
  }
  
  return {transit: transitMins, rise: riseMins, set: setMins};
}

function starPosition(starName, date, lat, lon){
  const star = NAVIGATION_STARS[starName];
  if(!star) return null;
  
  // Convert RA from hours to degrees
  const RA = star.ra * 15;
  const dec = star.dec;
  
  // Calculate Local Sidereal Time
  const JD = julianDay(date);
  const UT = date.getUTCHours() + date.getUTCMinutes()/60 + date.getUTCSeconds()/3600;
  const JD0 = Math.floor(JD - 0.5) + 0.5;
  const S = JD0 - 2451545.0;
  const T0 = S / 36525.0;
  const theta0 = 100.46061837 + 36000.770053608*T0 + 0.000387933*T0*T0;
  const LST = (theta0 + 360.98564724*UT/24 + lon) % 360;
  
  // Hour Angle
  const HA = (LST - RA + 360) % 360;
  const HAr = toRad(HA);
  const latR = toRad(lat);
  const decR = toRad(dec);
  
  // Altitude
  const sinAlt = Math.sin(latR)*Math.sin(decR) + Math.cos(latR)*Math.cos(decR)*Math.cos(HAr);
  const alt = toDeg(Math.asin(sinAlt));
  
  // Azimuth
  const cosA = (Math.sin(decR) - Math.sin(latR)*sinAlt) / (Math.cos(latR)*Math.cos(toRad(alt)));
  let az = toDeg(Math.acos(Math.max(-1, Math.min(1, cosA))));
  if(Math.sin(HAr) > 0) az = 360 - az;
  
  return {azimuth: az, altitude: alt, RA: star.ra, dec: dec, mag: star.mag};
}

function starRiseSetTransit(starName, date, lat, lon){
  const star = NAVIGATION_STARS[starName];
  if(!star) return null;
  
  const dec = star.dec;
  const latR = toRad(lat);
  const decR = toRad(dec);
  
  // Check if star is circumpolar or never rises
  const cosH = -Math.tan(latR) * Math.tan(decR);
  if(cosH < -1) return {circumpolar: true}; // Never sets
  if(cosH > 1) return {neverRises: true}; // Never rises
  
  // Hour angle at rise/set
  const H = toDeg(Math.acos(cosH));
  
  // Calculate LST at transit (when RA = LST)
  const RA = star.ra * 15; // Convert to degrees
  
  // For a given date, find when LST = RA
  const baseDate = new Date(date);
  baseDate.setUTCHours(0, 0, 0, 0);
  
  let transitMins = null, riseMins = null, setMins = null;
  
  // Search through the day
  for(let mins = 0; mins < 1440; mins += 5){
    const testDate = new Date(baseDate.getTime() + mins*60000);
    const pos = starPosition(starName, testDate, lat, lon);
    
    // Transit occurs at highest altitude (when HA ‚âà 0 or 360)
    if(transitMins === null){
      // Check if star is near meridian
      const JD = julianDay(testDate);
      const UT = testDate.getUTCHours() + testDate.getUTCMinutes()/60;
      const JD0 = Math.floor(JD - 0.5) + 0.5;
      const S = JD0 - 2451545.0;
      const T0 = S / 36525.0;
      const theta0 = 100.46061837 + 36000.770053608*T0 + 0.000387933*T0*T0;
      const LST = (theta0 + 360.98564724*UT/24 + lon) % 360;
      const diff = Math.abs(((LST - RA + 180) % 360) - 180);
      
      if(diff < 5) transitMins = mins;
    }
  }
  
  // Rise: HA = 360 - H (eastern horizon)
  // Set: HA = H (western horizon)
  // Use simplified approach: star rises H/15 hours before transit, sets H/15 hours after
  if(transitMins !== null){
    const hourAngleHours = H / 15;
    riseMins = transitMins - hourAngleHours * 60;
    setMins = transitMins + hourAngleHours * 60;
    
    // Normalize
    if(riseMins < 0) riseMins += 1440;
    if(setMins >= 1440) setMins -= 1440;
  }
  
  return {transit: transitMins, rise: riseMins, set: setMins};
}

function updateStarPosition(){
  const dropdown = document.getElementById('starDropdown');
  const bodyName = dropdown.value;
  
  if(!bodyName || lat === null || lon === null){
    document.getElementById('starCard').style.display = 'none';
    return;
  }
  
  // Check if it's a planet or star
  const isPlanet = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'].includes(bodyName);
  
  // Show card
  document.getElementById('starCard').style.display = 'block';
  document.getElementById('starName').textContent = bodyName;
  document.getElementById('starIcon').textContent = isPlanet ? 'ü™ê' : '‚≠ê';
  
  // Current position
  const now = new Date();
  const pos = isPlanet ? planetPosition(bodyName, now, lat, lon) : starPosition(bodyName, now, lat, lon);
  
  if(pos){
    document.getElementById('starAz').textContent = pos.azimuth.toFixed(1) + '¬∞';
    document.getElementById('starAlt').textContent = pos.altitude.toFixed(2) + '¬∞';
    
    const isVisible = pos.altitude > 0 ? '‚úì Yes' : '‚úó Below horizon';
    document.getElementById('starVisible').textContent = isVisible;
    document.getElementById('starVisible').style.color = pos.altitude > 0 ? 'var(--success)' : 'var(--danger)';
  }
  
  // Rise/Set/Transit times
  const [y, m, d] = datePicker.value.split('-').map(Number);
  const midUTC = new Date(Date.UTC(y, m-1, d, 0, 0, 0));
  const rst = isPlanet ? planetRiseSetTransit(bodyName, midUTC, lat, lon) : starRiseSetTransit(bodyName, midUTC, lat, lon);
  
  if(rst){
    if(rst.circumpolar){
      document.getElementById('starRise').textContent = 'Circumpolar';
      document.getElementById('starTransit').textContent = formatLocalTime(y, m, d, rst.transit || 720);
      document.getElementById('starSet').textContent = 'Never sets';
    } else if(rst.neverRises){
      document.getElementById('starRise').textContent = 'Never rises';
      document.getElementById('starTransit').textContent = '--';
      document.getElementById('starSet').textContent = 'Never rises';
    } else {
      document.getElementById('starRise').textContent = rst.rise !== null ? formatLocalTime(y, m, d, rst.rise) : '--:--';
      document.getElementById('starTransit').textContent = rst.transit !== null ? formatLocalTime(y, m, d, rst.transit) : '--:--';
      document.getElementById('starSet').textContent = rst.set !== null ? formatLocalTime(y, m, d, rst.set) : '--:--';
    }
  }
}

function utcDateFromMinutes(baseDate, mins){
  // baseDate is midnight UTC of the target day
  const d=new Date(baseDate.getTime());
  d.setUTCHours(0,0,0,0);
  d.setUTCMinutes(mins);
  return d;
}

function formatTime(mins, tz){
  // mins = minutes from midnight UTC; convert to local
  const totalSec=mins*60;
  const d=new Date();
  d.setUTCHours(0,0,0,0);
  d.setUTCSeconds(totalSec);
  // Use local time
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true});
}

// ‚îÄ‚îÄ‚îÄ Main compute ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function compute(){
  if(lat===null||lon===null) return;

  const [y,m,d]=datePicker.value.split('-').map(Number);
  // Midnight UTC of that day
  const midUTC = new Date(Date.UTC(y, m-1, d, 0,0,0));
  // Noon UTC for solar calc base
  const noonUTC = new Date(Date.UTC(y, m-1, d, 12,0,0));

  // Sunrise / Sunset
  const srMins = solarTime(noonUTC, lat, lon, 'sunrise');
  const ssMins = solarTime(noonUTC, lat, lon, 'sunset');
  const noonMins= solarTime(noonUTC, lat, lon, 'solar_noon');

  // Twilights
  const ctStart = solarTime(noonUTC, lat, lon, 'civil_twilight_start');
  const ctEnd   = solarTime(noonUTC, lat, lon, 'civil_twilight_end');
  const ntStart = solarTime(noonUTC, lat, lon, 'nautical_twilight_start');
  const ntEnd   = solarTime(noonUTC, lat, lon, 'nautical_twilight_end');
  const atStart = solarTime(noonUTC, lat, lon, 'astro_twilight_start');
  const atEnd   = solarTime(noonUTC, lat, lon, 'astro_twilight_end');

  if(srMins===null||ssMins===null){
    document.getElementById('sriseTime').textContent='N/A';
    document.getElementById('ssetTime').textContent='N/A';
    document.getElementById('detailBody').innerHTML='<tr><td colspan="4" style="color:var(--rose);text-align:center;padding:18px 0;">Sun does not rise or set at this latitude on this date.</td></tr>';
    return;
  }

  // Sun positions at sunrise / sunset
  const srDate = utcDateFromMinutes(midUTC, srMins);
  const ssDate = utcDateFromMinutes(midUTC, ssMins);
  const srPos = sunPosition(srDate, lat, lon);
  const ssPos = sunPosition(ssDate, lat, lon);
  const noonPos = sunPosition(utcDateFromMinutes(midUTC, noonMins), lat, lon);

  // Format local times
  const fmtSr = formatLocalTime(y,m,d,srMins);
  const fmtSs = formatLocalTime(y,m,d,ssMins);

  // Daylight duration
  const dlMins = ssMins - srMins;
  const dlH = Math.floor(dlMins/60);
  const dlM = Math.round(dlMins%60);

  // Update cards
  document.getElementById('sriseTime').textContent=fmtSr;
  document.getElementById('ssetTime').textContent=fmtSs;
  document.getElementById('sriseAz').textContent=srPos.azimuth.toFixed(1)+'¬∞';
  document.getElementById('sriseAlt').textContent=srPos.altitude.toFixed(2)+'¬∞';
  document.getElementById('ssetAz').textContent=ssPos.azimuth.toFixed(1)+'¬∞';
  document.getElementById('ssetAlt').textContent=ssPos.altitude.toFixed(2)+'¬∞';

  // Detail table
  const events=[
    {name:'Astro. Twilight Start', mins:atStart, color:'#6b5b8a'},
    {name:'Nautical Twilight Start', mins:ntStart, color:'#8b7aaa'},
    {name:'Civil Twilight Start', mins:ctStart, color:'#b89ec0'},
    {name:'Sunrise', mins:srMins, color:'var(--gold)', bold:true},
    {name:'Solar Noon', mins:noonMins, color:'#fff', bold:true},
    {name:'Sunset', mins:ssMins, color:'var(--rose)', bold:true},
    {name:'Civil Twilight End', mins:ctEnd, color:'#b89ec0'},
    {name:'Nautical Twilight End', mins:ntEnd, color:'#8b7aaa'},
    {name:'Astro. Twilight End', mins:atEnd, color:'#6b5b8a'},
  ];
  let rows='';
  events.forEach(ev=>{
    if(ev.mins===null) return;
    const evDate=utcDateFromMinutes(midUTC, ev.mins);
    const pos=sunPosition(evDate, lat, lon);
    const ft=formatLocalTime(y,m,d,ev.mins);
    const w=ev.bold?'font-weight:600;':'' ;
    rows+=`<tr>
      <td style="color:${ev.color};${w}">${ev.name}</td>
      <td style="text-align:right;color:${ev.color};${w}">${ft}</td>
      <td style="text-align:right;">${pos.azimuth.toFixed(1)}¬∞</td>
      <td style="text-align:right;">${pos.altitude.toFixed(2)}¬∞</td>
    </tr>`;
  });
  document.getElementById('detailBody').innerHTML=rows;
  document.getElementById('daylightHrs').textContent=`${dlH}h ${dlM}m`;

  // Daylight bar (% of 24h)
  document.getElementById('daylightBar').style.width=(dlMins/1440*100).toFixed(1)+'%';

  // ‚îÄ‚îÄ Moon calculations ‚îÄ‚îÄ
  const moonRS=moonRiseSet(midUTC, lat, lon);
  if(moonRS.rise!==null){
    const mrDate=utcDateFromMinutes(midUTC, moonRS.rise);
    const mrPos=moonPosition(mrDate, lat, lon);
    document.getElementById('mriseTime').textContent=formatLocalTime(y,m,d,moonRS.rise);
    document.getElementById('mriseAz').textContent=mrPos.azimuth.toFixed(1)+'¬∞';
    document.getElementById('mriseAlt').textContent=mrPos.altitude.toFixed(2)+'¬∞';
  } else {
    document.getElementById('mriseTime').textContent='N/A';
    document.getElementById('mriseAz').textContent='--';
    document.getElementById('mriseAlt').textContent='--';
  }
  
  if(moonRS.set!==null){
    const msDate=utcDateFromMinutes(midUTC, moonRS.set);
    const msPos=moonPosition(msDate, lat, lon);
    document.getElementById('msetTime').textContent=formatLocalTime(y,m,d,moonRS.set);
    document.getElementById('msetAz').textContent=msPos.azimuth.toFixed(1)+'¬∞';
    document.getElementById('msetAlt').textContent=msPos.altitude.toFixed(2)+'¬∞';
  } else {
    document.getElementById('msetTime').textContent='N/A';
    document.getElementById('msetAz').textContent='--';
    document.getElementById('msetAlt').textContent='--';
  }

  // Current positions (now)
  const nowDate=new Date();
  const sunNow=sunPosition(nowDate, lat, lon);
  const moonNow=moonPosition(nowDate, lat, lon);
  const phase=moonPhase(nowDate);
  
  document.getElementById('sunNowAz').textContent=sunNow.azimuth.toFixed(1)+'¬∞';
  document.getElementById('sunNowAlt').textContent=sunNow.altitude.toFixed(2)+'¬∞';
  document.getElementById('moonNowAz').textContent=moonNow.azimuth.toFixed(1)+'¬∞';
  document.getElementById('moonNowAlt').textContent=moonNow.altitude.toFixed(2)+'¬∞';
  document.getElementById('moonPhase').textContent=`${phase.phaseName} (${phase.illumination})`;

  // Update star if one is selected
  if(document.getElementById('starDropdown').value){
    updateStarPosition();
  }

  // ‚îÄ‚îÄ Draw arc ‚îÄ‚îÄ
  drawArc(srMins, ssMins, noonMins, midUTC);
}

function formatLocalTime(y,m,d,utcMins){
  // Create a date at that UTC minute and use toLocaleTimeString for local conversion
  const date=new Date(Date.UTC(y,m-1,d));
  date.setUTCMinutes(utcMins);
  
  if(timeFormat === '12h'){
    return date.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true});
  } else {
    return date.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
  }
}

// ‚îÄ‚îÄ‚îÄ Arc drawing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawArc(srMins, ssMins, noonMins, midUTC){
  const W=400, H=180, pad=40, cxL=pad, cxR=W-pad, cxM=W/2;
  const horizY=155;
  const peakY=25;
  // Map sunrise‚ÜícxL, noon‚ÜícxM, sunset‚ÜícxR on x; y = cosine arc
  // Parametric: t in [0,1] from sunrise to sunset
  // x = lerp(cxL, cxR, t)
  // y = horizY - (horizY-peakY)*sin(PI*t)

  const N=80;
  let ghost='', progress='';
  // current time fraction
  const now=new Date();
  const nowUTC=(now.getUTCHours()*60+now.getUTCMinutes());
  const tNow=(nowUTC-srMins)/(ssMins-srMins);

  for(let i=0;i<=N;i++){
    const t=i/N;
    const x=cxL+(cxR-cxL)*t;
    const y=horizY-(horizY-peakY)*Math.sin(Math.PI*t);
    ghost+=(i===0?'M':'L')+x.toFixed(1)+','+y.toFixed(1);
  }
  document.getElementById('arcGhost').setAttribute('d',ghost);

  // Progress up to now (if today)
  const isToday=datePicker.value===new Date().toISOString().slice(0,10);
  const tClamp=isToday?Math.max(0,Math.min(1,tNow)):1;
  const pN=Math.round(tClamp*N);
  for(let i=0;i<=pN;i++){
    const t=i/N;
    const x=cxL+(cxR-cxL)*t;
    const y=horizY-(horizY-peakY)*Math.sin(Math.PI*t);
    progress+=(i===0?'M':'L')+x.toFixed(1)+','+y.toFixed(1);
  }
  document.getElementById('arcProgress').setAttribute('d',progress);

  // Sun position (end of progress)
  const tSun=isToday?tClamp:0.5;
  const sunX=cxL+(cxR-cxL)*tSun;
  const sunY=horizY-(horizY-peakY)*Math.sin(Math.PI*tSun);
  // Move both sun circles
  document.querySelectorAll('#sunCircle').forEach(el=>{ el.setAttribute('cx',sunX); el.setAttribute('cy',sunY); });

  // Labels
  document.getElementById('sriseLabel').setAttribute('x',cxL);
  document.getElementById('sriseLabel').setAttribute('y',horizY+18);
  document.getElementById('sriseLabel').textContent=formatLocalTime(...datePicker.value.split('-').map(Number), srMins);
  document.getElementById('ssetLabel').setAttribute('x',cxR);
  document.getElementById('ssetLabel').setAttribute('y',horizY+18);
  document.getElementById('ssetLabel').textContent=formatLocalTime(...datePicker.value.split('-').map(Number), ssMins);

  // Now dot
  if(isToday && tNow>0 && tNow<1){
    const nX=cxL+(cxR-cxL)*tNow;
    const nY=horizY-(horizY-peakY)*Math.sin(Math.PI*tNow);
    document.getElementById('nowDot').setAttribute('cx',nX);
    document.getElementById('nowDot').setAttribute('cy',nY);
    document.getElementById('nowDot').setAttribute('opacity','1');
    document.getElementById('nowLabel').setAttribute('x',nX);
    document.getElementById('nowLabel').setAttribute('y',nY-14);
    document.getElementById('nowLabel').setAttribute('opacity','1');
  } else {
    document.getElementById('nowDot').setAttribute('opacity','0');
    document.getElementById('nowLabel').setAttribute('opacity','0');
  }
}

// ‚îÄ‚îÄ‚îÄ Tab Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tabName){
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  
  // Show selected tab
  document.getElementById('tab-' + tabName).classList.add('active');
  event.target.classList.add('active');
  
  // Update visible bodies if that tab is selected
  if(tabName === 'visible'){
    updateVisibleBodies();
  }
}

// ‚îÄ‚îÄ‚îÄ Visible Bodies Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateVisibleBodies(){
  if(lat === null || lon === null){
    document.getElementById('visibleTableBody').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--danger);">GPS location required. Please enable GPS or enter coordinates manually.</td></tr>';
    return;
  }

  const now = new Date();
  const bodies = [];
  
  // Add Sun
  const sunPos = sunPosition(now, lat, lon);
  bodies.push({
    name: '‚òÄÔ∏è Sun',
    type: 'Star',
    azimuth: sunPos.azimuth,
    altitude: sunPos.altitude,
    visible: sunPos.altitude > 0
  });
  
  // Add Moon
  const moonPos = moonPosition(now, lat, lon);
  bodies.push({
    name: 'üåô Moon',
    type: 'Satellite',
    azimuth: moonPos.azimuth,
    altitude: moonPos.altitude,
    visible: moonPos.altitude > 0
  });
  
  // Add Planets
  const planets = ['Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn'];
  planets.forEach(planet => {
    const pos = planetPosition(planet, now, lat, lon);
    if(pos){
      bodies.push({
        name: planet,
        type: 'Planet',
        azimuth: pos.azimuth,
        altitude: pos.altitude,
        visible: pos.altitude > 0
      });
    }
  });
  
  // Add all navigation stars
  Object.keys(NAVIGATION_STARS).forEach(starName => {
    const pos = starPosition(starName, now, lat, lon);
    if(pos){
      bodies.push({
        name: starName,
        type: 'Star',
        azimuth: pos.azimuth,
        altitude: pos.altitude,
        visible: pos.altitude > 0
      });
    }
  });
  
  // Sort by altitude
  bodies.sort((a, b) => b.altitude - a.altitude);
  
  // Check sort order
  const sortOrder = document.getElementById('visibleSortOrder')?.value || 'desc';
  if(sortOrder === 'asc'){
    bodies.reverse();
  }
  
  // Filter only visible bodies
  const visibleBodies = bodies.filter(b => b.visible);
  
  // Build table
  let html = '';
  if(visibleBodies.length === 0){
    html = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text-dim);">No celestial bodies currently visible above the horizon.</td></tr>';
  } else {
    visibleBodies.forEach(body => {
      const visClass = body.visible ? 'visible-yes' : 'visible-no';
      const visText = body.visible ? '‚úì Yes' : '‚úó No';
      html += `<tr onclick="showBodyDescription('${body.name.replace(/[üåô‚òÄÔ∏è]/g, '').trim()}')" style="cursor:pointer;">
        <td class="body-name">${body.name}</td>
        <td>${body.type}</td>
        <td>${body.azimuth.toFixed(1)}¬∞</td>
        <td>${body.altitude.toFixed(2)}¬∞</td>
        <td class="${visClass}">${visText}</td>
      </tr>`;
    });
  }
  
  document.getElementById('visibleTableBody').innerHTML = html;
  
  // Update sky plot
  drawSkyPlot();
}

// ‚îÄ‚îÄ‚îÄ Compass Error Calculation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCompassObject(){
  const obj = document.getElementById('compass-object').value;
  if(!obj || lat === null || lon === null) {
    document.getElementById('compass-true-bearing').textContent = '---¬∞';
    return;
  }
  
  const now = new Date();
  let pos = null;
  
  if(obj === 'Sun') pos = sunPosition(now, lat, lon);
  else if(obj === 'Moon') pos = moonPosition(now, lat, lon);
  else if(['Mercury','Venus','Mars','Jupiter','Saturn'].includes(obj)) pos = planetPosition(obj, now, lat, lon);
  else pos = starPosition(obj, now, lat, lon);
  
  if(pos){
    document.getElementById('compass-true-bearing').textContent = pos.azimuth.toFixed(1) + '¬∞';
    calculateCompassError();
  }
}

function calculateCompassError(){
  const trueBearing = parseFloat(document.getElementById('compass-true-bearing').textContent);
  const gyroHeading = parseFloat(document.getElementById('compass-gyro-heading').value);
  const magHeading = parseFloat(document.getElementById('compass-mag-heading').value);
  const gyroBearing = parseFloat(document.getElementById('compass-gyro-bearing').value);
  
  if(isNaN(trueBearing)) return;
  
  // Calculate Magnetic Variation (auto from location)
  const magVar = getMagneticVariation(lat, lon);
  const magVarDir = magVar >= 0 ? 'E' : 'W';
  document.getElementById('compass-mag-variation').textContent = Math.abs(magVar).toFixed(1) + '¬∞ ' + magVarDir;
  
  // Gyro Error = Gyro Heading - True Bearing (displayed as High/Low ONLY)
  if(!isNaN(gyroHeading) && !isNaN(gyroBearing)){
    // Calculate gyro error from gyro bearing vs true bearing
    let gyroError = gyroBearing - trueBearing;
    if(gyroError > 180) gyroError -= 360;
    if(gyroError < -180) gyroError += 360;
    
    // Display as High (H) or Low (L) - NOT East/West
    const gyroDir = gyroError >= 0 ? 'H' : 'L';
    document.getElementById('compass-gyro-error').textContent = Math.abs(gyroError).toFixed(1) + '¬∞ ' + gyroDir;
  }
  
  // Magnetic Error = True Bearing - (Magnetic Heading + Variation) - uses E/W
  if(!isNaN(magHeading)){
    let magError = trueBearing - (magHeading + magVar);
    if(magError > 180) magError -= 360;
    if(magError < -180) magError += 360;
    const magErrDir = magError >= 0 ? 'E' : 'W';
    document.getElementById('compass-mag-error').textContent = Math.abs(magError).toFixed(1) + '¬∞ ' + magErrDir;
  }
  
  // Deviation = Magnetic Error - Variation - uses E/W
  if(!isNaN(magHeading)){
    let deviation = (trueBearing - (magHeading + magVar)) - magVar;
    if(deviation > 180) deviation -= 360;
    if(deviation < -180) deviation += 360;
    const devDir = deviation >= 0 ? 'E' : 'W';
    document.getElementById('compass-deviation').textContent = Math.abs(deviation).toFixed(1) + '¬∞ ' + devDir;
  }
}

function getMagneticVariation(latitude, longitude){
  if(latitude === null || longitude === null) return 0;
  
  // First, try regional lookup table for high accuracy
  // This uses actual nautical chart values
  const regionalVariation = getRegionalMagneticVariation(latitude, longitude);
  if(regionalVariation !== null) return regionalVariation;
  
  // Fallback to WMM-2025 simplified calculation
  // For accurate results, this uses a simplified spherical harmonic model
  // Production applications should use the full WMM-2025 model
  
  const epoch = 2025.0;
  const currentYear = new Date().getFullYear() + (new Date().getMonth() / 12);
  const dt = currentYear - epoch;
  
  // Convert to radians
  const latRad = latitude * Math.PI / 180;
  const lonRad = longitude * Math.PI / 180;
  
  // Simplified WMM-2025 coefficients (first-order approximation)
  // These are scaled versions of the actual Gauss coefficients
  const g10 = -29404.8 + 10.3 * dt;  // nT
  const g11 = -1450.9 + 18.1 * dt;
  const h11 = 4652.5 + -26.6 * dt;
  const g20 = -2499.6 + -11.3 * dt;
  const g21 = 2982.0 + -7.0 * dt;
  const h21 = -2991.6 + -27.9 * dt;
  const g22 = 1677.0 + 1.4 * dt;
  const h22 = -734.6 + 13.4 * dt;
  
  // Schmidt semi-normalized associated Legendre functions
  const sinLat = Math.sin(latRad);
  const cosLat = Math.cos(latRad);
  
  const P10 = sinLat;
  const P11 = cosLat;
  const P20 = (3 * sinLat * sinLat - 1) / 2;
  const P21 = 3 * sinLat * cosLat;
  const P22 = 3 * cosLat * cosLat;
  
  // Calculate X (north), Y (east), Z (down) components
  let X = 0, Y = 0;
  
  // Degree 1
  X += g10 * P10;
  X += (g11 * Math.cos(lonRad) + h11 * Math.sin(lonRad)) * P11;
  Y += (g11 * Math.sin(lonRad) - h11 * Math.cos(lonRad)) * P11;
  
  // Degree 2
  X += g20 * P20;
  X += (g21 * Math.cos(lonRad) + h21 * Math.sin(lonRad)) * P21;
  X += (g22 * Math.cos(2*lonRad) + h22 * Math.sin(2*lonRad)) * P22;
  Y += (g21 * Math.sin(lonRad) - h21 * Math.cos(lonRad)) * P21;
  Y += 2 * (g22 * Math.sin(2*lonRad) - h22 * Math.cos(2*lonRad)) * P22;
  
  // Calculate declination (magnetic variation)
  const declination = Math.atan2(Y, X) * 180 / Math.PI;
  
  console.log(`Magnetic Variation calculated: ${declination.toFixed(1)}¬∞ for Lat:${latitude.toFixed(2)} Lon:${longitude.toFixed(2)}`);
  
  return declination;
}

// Regional Magnetic Variation Lookup (from nautical charts - accurate for 2025)
function getRegionalMagneticVariation(lat, lon){
  // Define regions with accurate nautical chart values
  const regions = [
    // North America - East Coast
    {latMin: 25, latMax: 45, lonMin: -85, lonMax: -65, variation: -14.0, name: "US East Coast"},
    {latMin: 40, latMax: 50, lonMin: -75, lonMax: -65, variation: -15.5, name: "New York area"},
    
    // North America - West Coast  
    {latMin: 30, latMax: 50, lonMin: -125, lonMax: -115, variation: 13.5, name: "US West Coast"},
    {latMin: 35, latMax: 50, lonMin: -123, lonMax: -120, variation: 14.2, name: "California"},
    
    // Gulf of Mexico
    {latMin: 24, latMax: 31, lonMin: -98, lonMax: -80, variation: -2.5, name: "Gulf of Mexico"},
    
    // Caribbean
    {latMin: 10, latMax: 25, lonMin: -85, lonMax: -60, variation: -8.0, name: "Caribbean"},
    
    // Mediterranean
    {latMin: 30, latMax: 46, lonMin: -6, lonMax: 37, variation: 2.5, name: "Mediterranean"},
    
    // North Atlantic
    {latMin: 40, latMax: 60, lonMin: -40, lonMax: -10, variation: -18.0, name: "North Atlantic"},
    
    // UK & North Sea
    {latMin: 50, latMax: 61, lonMin: -10, lonMax: 3, variation: -2.0, name: "UK & North Sea"},
    
    // Indian Ocean - West
    {latMin: -30, latMax: 25, lonMin: 40, lonMax: 80, variation: -1.5, name: "Western Indian Ocean"},
    {latMin: 15, latMax: 25, lonMin: 65, lonMax: 78, variation: -1.0, name: "Arabian Sea"},
    {latMin: 8, latMax: 22, lonMin: 68, lonMax: 78, variation: -0.8, name: "Mumbai area"},
    
    // Far East
    {latMin: 20, latMax: 45, lonMin: 120, lonMax: 145, variation: -6.0, name: "East China Sea"},
    {latMin: 30, latMax: 40, lonMin: 135, lonMax: 145, variation: -7.5, name: "Japan"},
    
    // Australia
    {latMin: -45, latMax: -10, lonMin: 110, lonMax: 155, variation: 8.0, name: "Australia"},
    
    // South Pacific
    {latMin: -50, latMax: 0, lonMin: 160, lonMax: -120, variation: 12.0, name: "South Pacific"},
    
    // South America - East
    {latMin: -35, latMax: 5, lonMin: -60, lonMax: -35, variation: -18.0, name: "Brazil coast"},
    
    // South America - West
    {latMin: -35, latMax: 0, lonMin: -82, lonMax: -70, variation: 2.0, name: "Chile/Peru"},
    
    // Africa - West Coast
    {latMin: -35, latMax: 35, lonMin: -20, lonMax: 20, variation: -8.0, name: "West Africa"},
    
    // Africa - East Coast
    {latMin: -35, latMax: 15, lonMin: 25, lonMax: 55, variation: -5.0, name: "East Africa"}
  ];
  
  // Find matching region
  for(let region of regions){
    if(lat >= region.latMin && lat <= region.latMax && 
       lon >= region.lonMin && lon <= region.lonMax){
      console.log(`Magnetic Variation from nautical chart (${region.name}): ${region.variation.toFixed(1)}¬∞`);
      return region.variation;
    }
  }
  
  return null; // No regional data, will use WMM calculation
}

// ‚îÄ‚îÄ‚îÄ Moon Phases Calendar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateMoonPhases(){
  const month = parseInt(document.getElementById('moonphase-month').value);
  const year = parseInt(document.getElementById('moonphase-year').value);
  const view = document.getElementById('moonphase-view').value;
  
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  
  let html = '';
  
  if(view === 'grid'){
    // Monthly Grid View (existing)
    html = '<table style="width:100%; border-collapse:collapse;">';
    html += '<tr>';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(day => {
      html += `<th style="padding:12px; text-align:center; background:var(--primary); color:#fff; font-weight:700;">${day}</th>`;
    });
    html += '</tr><tr>';
    
    for(let i = 0; i < firstDay; i++){
      html += '<td style="padding:12px; border:1px solid var(--card-border);"></td>';
    }
    
    for(let day = 1; day <= daysInMonth; day++){
      const date = new Date(year, month, day, 12, 0, 0);
      const phase = moonPhase(date);
      
      let phaseEmoji = getMoonEmoji(phase.phaseName);
      let phaseColor = getMoonColor(phase.phaseName);
      
      const isSpecial = phase.phaseName.includes('New Moon') || phase.phaseName.includes('Full Moon') || phase.phaseName.includes('Quarter');
      const bgColor = isSpecial ? 'var(--primary-light)' : 'var(--bg)';
      const border = isSpecial ? '3px solid ' + phaseColor : '1px solid var(--card-border)';
      
      html += `<td style="padding:12px; text-align:center; border:${border}; background:${bgColor}; vertical-align:top;">
        <div style="font-weight:700; font-size:1.1rem; margin-bottom:6px;">${day}</div>
        <div style="font-size:1.5rem; margin-bottom:4px;">${phaseEmoji}</div>
        <div style="font-size:0.7rem; color:var(--text-dim);">${phase.illumination}</div>
        ${isSpecial ? `<div style="font-size:0.65rem; color:${phaseColor}; font-weight:700; margin-top:4px;">${phase.phaseName}</div>` : ''}
      </td>`;
      
      if((firstDay + day) % 7 === 0 && day < daysInMonth){
        html += '</tr><tr>';
      }
    }
    html += '</tr></table>';
  } else if(view === 'timeline'){
    // Timeline View
    html = '<div style="display:flex; overflow-x:auto; gap:12px; padding:20px;">';
    for(let day = 1; day <= daysInMonth; day++){
      const date = new Date(year, month, day, 12, 0, 0);
      const phase = moonPhase(date);
      const phaseEmoji = getMoonEmoji(phase.phaseName);
      const isSpecial = phase.phaseName.includes('New Moon') || phase.phaseName.includes('Full Moon') || phase.phaseName.includes('Quarter');
      
      html += `<div style="flex-shrink:0; text-align:center; padding:16px; background:${isSpecial ? 'var(--primary-light)' : 'var(--card)'}; border:2px solid ${isSpecial ? 'var(--primary)' : 'var(--card-border)'}; border-radius:12px; min-width:100px;">
        <div style="font-size:0.8rem; color:var(--text-dim); margin-bottom:8px;">${date.toLocaleDateString('en-US', {month:'short', day:'numeric'})}</div>
        <div style="font-size:2.5rem; margin-bottom:8px;">${phaseEmoji}</div>
        <div style="font-size:0.75rem; color:var(--text-dim);">${phase.illumination}</div>
        ${isSpecial ? `<div style="font-size:0.7rem; color:var(--primary); font-weight:700; margin-top:8px;">${phase.phaseName}</div>` : ''}
      </div>`;
    }
    html += '</div>';
  } else if(view === 'circular'){
    // Circular Lunar Cycle View
    html = '<div style="position:relative; width:400px; height:400px; margin:40px auto; max-width:100%;">';
    html += '<svg viewBox="0 0 400 400" style="width:100%; height:100%;">';
    html += '<circle cx="200" cy="200" r="180" fill="var(--card)" stroke="var(--primary)" stroke-width="3"/>';
    
    const phases = [];
    for(let day = 1; day <= daysInMonth; day++){
      const date = new Date(year, month, day, 12, 0, 0);
      const phase = moonPhase(date);
      const isSpecial = phase.phaseName.includes('New Moon') || phase.phaseName.includes('Full Moon') || phase.phaseName.includes('Quarter');
      if(isSpecial) phases.push({day, phase: phase.phaseName, date});
    }
    
    phases.forEach((p, i) => {
      const angle = (i / phases.length) * 2 * Math.PI - Math.PI / 2;
      const x = 200 + 140 * Math.cos(angle);
      const y = 200 + 140 * Math.sin(angle);
      html += `<circle cx="${x}" cy="${y}" r="20" fill="var(--primary)" opacity="0.3"/>`;
      html += `<text x="${x}" y="${y+5}" text-anchor="middle" fill="var(--text)" font-size="12" font-weight="700">${p.day}</text>`;
      const labelX = 200 + 170 * Math.cos(angle);
      const labelY = 200 + 170 * Math.sin(angle);
      html += `<text x="${labelX}" y="${labelY}" text-anchor="middle" fill="var(--primary)" font-size="10">${p.phase.split(' ')[0]}</text>`;
    });
    
    html += '</svg></div>';
  } else if(view === 'minimal'){
    // Minimal Professional View
    html = '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:16px; padding:20px;">';
    for(let day = 1; day <= daysInMonth; day++){
      const date = new Date(year, month, day, 12, 0, 0);
      const phase = moonPhase(date);
      const isSpecial = phase.phaseName.includes('New Moon') || phase.phaseName.includes('Full Moon') || phase.phaseName.includes('Quarter');
      
      if(isSpecial){
        const phaseEmoji = getMoonEmoji(phase.phaseName);
        html += `<div style="background:var(--card); border:2px solid var(--primary); border-radius:12px; padding:20px; text-align:center;">
          <div style="font-size:3rem; margin-bottom:12px;">${phaseEmoji}</div>
          <div style="font-size:1.2rem; font-weight:700; color:var(--primary); margin-bottom:8px;">${date.toLocaleDateString('en-US', {month:'short', day:'numeric'})}</div>
          <div style="font-size:0.9rem; color:var(--text); font-weight:600;">${phase.phaseName}</div>
          <div style="font-size:0.8rem; color:var(--text-dim); margin-top:6px;">${phase.illumination}</div>
        </div>`;
      }
    }
    html += '</div>';
  }
  
  document.getElementById('moonphase-calendar').innerHTML = html;
}

function getMoonEmoji(phaseName){
  if(phaseName.includes('New Moon')) return 'üåë';
  if(phaseName.includes('Waxing Crescent')) return 'üåí';
  if(phaseName.includes('First Quarter')) return 'üåì';
  if(phaseName.includes('Waxing Gibbous')) return 'üåî';
  if(phaseName.includes('Full Moon')) return 'üåï';
  if(phaseName.includes('Waning Gibbous')) return 'üåñ';
  if(phaseName.includes('Last Quarter')) return 'üåó';
  if(phaseName.includes('Waning Crescent')) return 'üåò';
  return 'üåë';
}

function getMoonColor(phaseName){
  if(phaseName.includes('New Moon')) return '#333';
  if(phaseName.includes('First Quarter')) return 'var(--primary)';
  if(phaseName.includes('Full Moon')) return 'var(--gold)';
  if(phaseName.includes('Last Quarter')) return 'var(--secondary)';
  return '#777';
}

// ‚îÄ‚îÄ‚îÄ Theme Application ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyTheme(){
  const theme = document.getElementById('setting-theme').value;
  const root = document.documentElement;
  
  // Remove existing theme classes
  root.classList.remove('theme-professional-navy', 'theme-midnight-dark', 'theme-ocean-blue', 'theme-aviation-grey', 'theme-elegant-light');
  
  if(theme === 'auto') {
    // Use system preference
    return;
  }
  
  // Apply theme class
  root.classList.add('theme-' + theme);
  
  // Define theme colors
  const themes = {
    'professional-navy': {
      '--bg': '#f8fafc',
      '--card': '#ffffff',
      '--card-border': '#cbd5e1',
      '--text': '#0f172a',
      '--text-dim': '#475569',
      '--primary': '#0369a1',
      '--primary-light': '#e0f2fe',
      '--primary-dark': '#075985',
      '--secondary': '#0891b2',
      '--accent': '#f59e0b',
      '--gradient-primary': 'linear-gradient(135deg, #0369a1 0%, #0891b2 100%)',
      '--gradient-accent': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
    },
    'midnight-dark': {
      '--bg': '#000000',
      '--card': '#1a1a1a',
      '--card-border': '#333333',
      '--text': '#ffffff',
      '--text-dim': '#999999',
      '--primary': '#6366f1',
      '--primary-light': '#1e1b4b',
      '--primary-dark': '#4f46e5',
      '--secondary': '#8b5cf6',
      '--accent': '#f59e0b',
      '--gradient-primary': 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
      '--gradient-accent': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
    },
    'ocean-blue': {
      '--bg': '#ecfeff',
      '--card': '#ffffff',
      '--card-border': '#a5f3fc',
      '--text': '#083344',
      '--text-dim': '#155e75',
      '--primary': '#0891b2',
      '--primary-light': '#cffafe',
      '--primary-dark': '#0e7490',
      '--secondary': '#06b6d4',
      '--accent': '#14b8a6',
      '--gradient-primary': 'linear-gradient(135deg, #0891b2 0%, #06b6d4 100%)',
      '--gradient-accent': 'linear-gradient(135deg, #14b8a6 0%, #0d9488 100%)'
    },
    'aviation-grey': {
      '--bg': '#f5f5f5',
      '--card': '#ffffff',
      '--card-border': '#d4d4d4',
      '--text': '#262626',
      '--text-dim': '#525252',
      '--primary': '#52525b',
      '--primary-light': '#f4f4f5',
      '--primary-dark': '#3f3f46',
      '--secondary': '#71717a',
      '--accent': '#ea580c',
      '--gradient-primary': 'linear-gradient(135deg, #52525b 0%, #71717a 100%)',
      '--gradient-accent': 'linear-gradient(135deg, #ea580c 0%, #dc2626 100%)'
    },
    'elegant-light': {
      '--bg': '#fefce8',
      '--card': '#ffffff',
      '--card-border': '#fde047',
      '--text': '#422006',
      '--text-dim': '#78350f',
      '--primary': '#ca8a04',
      '--primary-light': '#fef9c3',
      '--primary-dark': '#a16207',
      '--secondary': '#eab308',
      '--accent': '#dc2626',
      '--gradient-primary': 'linear-gradient(135deg, #ca8a04 0%, #eab308 100%)',
      '--gradient-accent': 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)'
    }
  };
  
  const themeColors = themes[theme];
  if(themeColors){
    Object.keys(themeColors).forEach(key => {
      root.style.setProperty(key, themeColors[key]);
    });
  }
}

// ‚îÄ‚îÄ‚îÄ World Clock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let worldClocks = [];
let clockType = 'digital';

function setClockType(type){
  clockType = type;
  document.getElementById('btn-digital').classList.toggle('active', type === 'digital');
  document.getElementById('btn-analog').classList.toggle('active', type === 'analog');
  document.getElementById('btn-digital').style.background = type === 'digital' ? 'var(--primary)' : 'var(--card)';
  document.getElementById('btn-digital').style.color = type === 'digital' ? '#fff' : 'var(--text)';
  document.getElementById('btn-analog').style.background = type === 'analog' ? 'var(--primary)' : 'var(--card)';
  document.getElementById('btn-analog').style.color = type === 'analog' ? '#fff' : 'var(--text)';
  updateWorldClocks();
}

function addWorldClock(){
  const country = document.getElementById('worldclock-country').value;
  if(!country || worldClocks.length >= 8) return;
  
  const clockData = {
    'US-EST': {name: 'New York, USA', offset: -5, dst: true},
    'US-PST': {name: 'Los Angeles, USA', offset: -8, dst: true},
    'GB': {name: 'London, UK', offset: 0, dst: true},
    'FR': {name: 'Paris, France', offset: 1, dst: true},
    'DE': {name: 'Berlin, Germany', offset: 1, dst: true},
    'JP': {name: 'Tokyo, Japan', offset: 9, dst: false},
    'CN': {name: 'Beijing, China', offset: 8, dst: false},
    'AU-AEST': {name: 'Sydney, Australia', offset: 10, dst: true},
    'IN': {name: 'New Delhi, India', offset: 5.5, dst: false},
    'BR': {name: 'S√£o Paulo, Brazil', offset: -3, dst: false},
    'ZA': {name: 'Johannesburg, South Africa', offset: 2, dst: false},
    'AE': {name: 'Dubai, UAE', offset: 4, dst: false},
    'SG': {name: 'Singapore', offset: 8, dst: false},
    'RU': {name: 'Moscow, Russia', offset: 3, dst: false},
    'MX': {name: 'Mexico City, Mexico', offset: -6, dst: true}
  };
  
  if(!clockData[country]) return;
  
  worldClocks.push({id: country, ...clockData[country]});
  updateWorldClocks();
}

function removeWorldClock(id){
  worldClocks = worldClocks.filter(c => c.id !== id);
  updateWorldClocks();
}

function updateWorldClocks(){
  const container = document.getElementById('worldclock-container');
  if(worldClocks.length === 0){
    container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-dim); grid-column:1/-1;">Click "Add Clock" to display world clocks. Up to 8 clocks can be displayed simultaneously.</div>';
    return;
  }
  
  let html = '';
  worldClocks.forEach(clock => {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const clockTime = new Date(utc + (3600000 * clock.offset));
    
    const hours = clockTime.getHours();
    const minutes = clockTime.getMinutes();
    const seconds = clockTime.getSeconds();
    
    const offsetSign = clock.offset >= 0 ? '+' : '';
    const offsetStr = `UTC${offsetSign}${clock.offset}`;
    
    html += `<div style="background:var(--card); border:2px solid var(--card-border); border-radius:12px; padding:20px; box-shadow:var(--shadow-md);">
      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:16px;">
        <div>
          <div style="font-size:1.1rem; font-weight:700; color:var(--text); margin-bottom:4px;">${clock.name}</div>
          <div style="font-size:0.8rem; color:var(--text-dim); font-weight:600;">${offsetStr}</div>
        </div>
        <button onclick="removeWorldClock('${clock.id}')" style="background:var(--danger); color:#fff; border:none; border-radius:6px; width:28px; height:28px; cursor:pointer; font-size:1.2rem; line-height:1;">√ó</button>
      </div>`;
    
    if(clockType === 'digital'){
      let timeStr;
      if(timeFormat === '12h'){
        const period = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        timeStr = `${String(displayHours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')} ${period}`;
      } else {
        timeStr = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
      }
      html += `<div style="font-family:'Courier New', monospace; font-size:2.5rem; font-weight:700; color:var(--primary); text-align:center; padding:20px 0;">${timeStr}</div>`;
    } else {
      html += `<div style="position:relative; width:180px; height:180px; margin:0 auto;">
        <svg viewBox="0 0 200 200" style="width:100%; height:100%;">
          <circle cx="100" cy="100" r="95" fill="var(--bg)" stroke="var(--primary)" stroke-width="4"/>
          ${[...Array(12)].map((_, i) => {
            const angle = (i * 30 - 90) * Math.PI / 180;
            const x1 = 100 + 85 * Math.cos(angle);
            const y1 = 100 + 85 * Math.sin(angle);
            const x2 = 100 + 75 * Math.cos(angle);
            const y2 = 100 + 75 * Math.sin(angle);
            return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="var(--text)" stroke-width="3"/>`;
          }).join('')}
          ${(() => {
            const hourAngle = ((hours % 12 + minutes/60) * 30 - 90) * Math.PI / 180;
            const minuteAngle = (minutes * 6 - 90) * Math.PI / 180;
            const secondAngle = (seconds * 6 - 90) * Math.PI / 180;
            return `
              <line x1="100" y1="100" x2="${100 + 50 * Math.cos(hourAngle)}" y2="${100 + 50 * Math.sin(hourAngle)}" stroke="var(--text)" stroke-width="6" stroke-linecap="round"/>
              <line x1="100" y1="100" x2="${100 + 70 * Math.cos(minuteAngle)}" y2="${100 + 70 * Math.sin(minuteAngle)}" stroke="var(--primary)" stroke-width="4" stroke-linecap="round"/>
              <line x1="100" y1="100" x2="${100 + 75 * Math.cos(secondAngle)}" y2="${100 + 75 * Math.sin(secondAngle)}" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"/>
              <circle cx="100" cy="100" r="8" fill="var(--primary)"/>
            `;
          })()}
        </svg>
      </div>`;
    }
    
    html += `</div>`;
  });
  
  container.innerHTML = html;
}

// Update eclipse local times
function updateEclipseTimes(){
  const offset = parseFloat(document.getElementById('utcOffset').value);
  
  // Next eclipses
  const nextLunar = new Date('2026-05-26T11:18:00Z');
  const nextSolar = new Date('2026-08-12T17:47:00Z');
  const lastLunar = new Date('2025-09-18T02:44:00Z');
  const lastSolar = new Date('2025-10-02T18:46:00Z');
  
  document.getElementById('eclipse-next-lunar-time-local').textContent = formatTimeWithOffset(nextLunar, offset);
  document.getElementById('eclipse-next-solar-time-local').textContent = formatTimeWithOffset(nextSolar, offset);
  document.getElementById('eclipse-last-lunar-time-local').textContent = formatTimeWithOffset(lastLunar, offset);
  document.getElementById('eclipse-last-solar-time-local').textContent = formatTimeWithOffset(lastSolar, offset);
}

function formatTimeWithOffset(date, offset){
  const localDate = new Date(date.getTime() + offset * 3600000);
  const hours = localDate.getUTCHours();
  const minutes = String(localDate.getUTCMinutes()).padStart(2, '0');
  const seconds = String(localDate.getUTCSeconds()).padStart(2, '0');
  
  let timeStr;
  if(timeFormat === '12h'){
    const period = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    timeStr = `${String(displayHours).padStart(2,'0')}:${minutes}:${seconds} ${period}`;
  } else {
    timeStr = `${String(hours).padStart(2,'0')}:${minutes}:${seconds}`;
  }
  
  const sign = offset >= 0 ? '+' : '';
  return `${timeStr} (UTC${sign}${offset})`;
}

// ‚îÄ‚îÄ‚îÄ Day/Night Duration Graph ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let dayNightChart = null;

function updateDayNightGraph(){
  const country = document.getElementById('daynight-country').value;
  const duration = parseInt(document.getElementById('daynight-duration').value);
  
  if(!country) {
    const canvas = document.getElementById('daynight-chart');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'var(--text-dim)';
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Please select a country', canvas.width/2, canvas.height/2);
    return;
  }
  
  // Country coordinates (capital cities)
  const coords = {
    'US': {lat: 38.9, lon: -77.0, name: 'Washington D.C.'},
    'GB': {lat: 51.5, lon: -0.1, name: 'London'},
    'CA': {lat: 45.4, lon: -75.7, name: 'Ottawa'},
    'AU': {lat: -35.3, lon: 149.1, name: 'Canberra'},
    'IN': {lat: 28.6, lon: 77.2, name: 'New Delhi'},
    'JP': {lat: 35.7, lon: 139.7, name: 'Tokyo'},
    'DE': {lat: 52.5, lon: 13.4, name: 'Berlin'},
    'FR': {lat: 48.9, lon: 2.4, name: 'Paris'},
    'BR': {lat: -15.8, lon: -47.9, name: 'Bras√≠lia'},
    'ZA': {lat: -25.7, lon: 28.2, name: 'Pretoria'},
    'NO': {lat: 59.9, lon: 10.8, name: 'Oslo'},
    'SE': {lat: 59.3, lon: 18.1, name: 'Stockholm'},
    'IS': {lat: 64.1, lon: -21.9, name: 'Reykjavik'},
    'NZ': {lat: -41.3, lon: 174.8, name: 'Wellington'},
    'SG': {lat: 1.3, lon: 103.8, name: 'Singapore'}
  };
  
  const loc = coords[country];
  const today = new Date();
  const labels = [];
  const daylightData = [];
  const nightData = [];
  
  for(let i = 0; i < duration; i++){
    const date = new Date(today);
    date.setDate(date.getDate() + i);
    
    labels.push(date.toLocaleDateString('en-US', {month:'short', day:'numeric'}));
    
    // Calculate sunrise/sunset for this location and date
    const midUTC = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0));
    const srMins = solarTime(midUTC, loc.lat, loc.lon, 'sunrise');
    const ssMins = solarTime(midUTC, loc.lat, loc.lon, 'sunset');
    
    if(srMins !== null && ssMins !== null){
      const daylight = (ssMins - srMins) / 60; // hours
      const night = 24 - daylight;
      daylightData.push(daylight.toFixed(2));
      nightData.push(night.toFixed(2));
    } else {
      daylightData.push(null);
      nightData.push(null);
    }
  }
  
  // Create or update chart
  const canvas = document.getElementById('daynight-chart');
  const ctx = canvas.getContext('2d');
  
  if(dayNightChart) dayNightChart.destroy();
  
  // Simple canvas-based chart (no external library needed)
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const chartWidth = canvas.width - 80;
  const chartHeight = canvas.height - 80;
  const barWidth = chartWidth / duration;
  
  ctx.fillStyle = 'var(--text)';
  ctx.font = '12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(`Day & Night Duration - ${loc.name}`, canvas.width/2, 20);
  
  // Draw bars
  for(let i = 0; i < duration; i++){
    const x = 60 + i * barWidth;
    const dayHrs = parseFloat(daylightData[i]);
    const nightHrs = parseFloat(nightData[i]);
    
    if(dayHrs){
      // Daylight bar (gold)
      const dayHeight = (dayHrs / 24) * chartHeight;
      ctx.fillStyle = '#fbbf24';
      ctx.fillRect(x, 40 + chartHeight - dayHeight, barWidth - 2, dayHeight);
      
      // Night bar (dark blue)
      const nightHeight = (nightHrs / 24) * chartHeight;
      ctx.fillStyle = '#1e40af';
      ctx.fillRect(x, 40, barWidth - 2, nightHeight);
    }
    
    // Label every 7 days or if duration < 30, show all
    if(i % Math.max(1, Math.floor(duration / 10)) === 0){
      ctx.fillStyle = 'var(--text-dim)';
      ctx.font = '10px sans-serif';
      ctx.save();
      ctx.translate(x + barWidth/2, canvas.height - 20);
      ctx.rotate(-Math.PI/4);
      ctx.fillText(labels[i], 0, 0);
      ctx.restore();
    }
  }
  
  // Legend
  ctx.fillStyle = '#fbbf24';
  ctx.fillRect(20, canvas.height - 50, 20, 10);
  ctx.fillStyle = 'var(--text)';
  ctx.font = '12px sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('Daylight', 45, canvas.height - 42);
  
  ctx.fillStyle = '#1e40af';
  ctx.fillRect(120, canvas.height - 50, 20, 10);
  ctx.fillStyle = 'var(--text)';
  ctx.fillText('Night', 145, canvas.height - 42);
}

// ‚îÄ‚îÄ‚îÄ Marine Compass Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateMarineCompass(){
  if(lat === null || lon === null) return;
  
  // Update position display
  const latDeg = Math.floor(Math.abs(lat));
  const latMin = ((Math.abs(lat) - latDeg) * 60).toFixed(3);
  const latDir = lat >= 0 ? 'N' : 'S';
  const lonDeg = Math.floor(Math.abs(lon));
  const lonMin = ((Math.abs(lon) - lonDeg) * 60).toFixed(3);
  const lonDir = lon >= 0 ? 'E' : 'W';
  
  document.getElementById('marine-position').innerHTML = `
    <div>${String(latDeg).padStart(2, '0')}¬∞ ${latMin.padStart(6, '0')}' ${latDir}</div>
    <div>${String(lonDeg).padStart(3, '0')}¬∞ ${lonMin.padStart(6, '0')}' ${lonDir}</div>
  `;
  
  // Draw compass
  const canvas = document.getElementById('marineCompassCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const size = canvas.width;
  const cx = size / 2;
  const cy = size / 2;
  const radius = size * 0.4;
  
  ctx.clearRect(0, 0, size, size);
  
  // Outer ring
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
  ctx.stroke();
  
  // Draw degree marks
  ctx.lineWidth = 2;
  for(let i = 0; i < 360; i += 10){
    const angle = (i - 90) * Math.PI / 180;
    const isCardinal = i % 90 === 0;
    const isMajor = i % 30 === 0;
    const length = isCardinal ? 25 : (isMajor ? 15 : 10);
    
    ctx.beginPath();
    ctx.moveTo(cx + (radius - length) * Math.cos(angle), cy + (radius - length) * Math.sin(angle));
    ctx.lineTo(cx + radius * Math.cos(angle), cy + radius * Math.sin(angle));
    ctx.strokeStyle = isCardinal ? '#dc2626' : getComputedStyle(document.documentElement).getPropertyValue('--text');
    ctx.stroke();
  }
  
  // Cardinal directions
  ctx.fillStyle = '#dc2626';
  ctx.font = 'bold 24px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('N', cx, cy - radius - 30);
  ctx.fillText('S', cx, cy + radius + 30);
  ctx.fillText('E', cx + radius + 30, cy);
  ctx.fillText('W', cx - radius - 30, cy);
  
  // COG needle (if available)
  if(cogValue !== null){
    const cogAngle = (cogValue - 90) * Math.PI / 180;
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + (radius - 40) * Math.cos(cogAngle), cy + (radius - 40) * Math.sin(cogAngle));
    ctx.stroke();
    
    // Arrowhead
    ctx.fillStyle = '#f59e0b';
    ctx.beginPath();
    const arrowSize = 15;
    ctx.moveTo(cx + (radius - 40) * Math.cos(cogAngle), cy + (radius - 40) * Math.sin(cogAngle));
    ctx.lineTo(cx + (radius - 55) * Math.cos(cogAngle - 0.3), cy + (radius - 55) * Math.sin(cogAngle - 0.3));
    ctx.lineTo(cx + (radius - 55) * Math.cos(cogAngle + 0.3), cy + (radius - 55) * Math.sin(cogAngle + 0.3));
    ctx.closePath();
    ctx.fill();
  }
  
  // Center dot
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
  ctx.beginPath();
  ctx.arc(cx, cy, 10, 0, 2 * Math.PI);
  ctx.fill();
}

// ‚îÄ‚îÄ‚îÄ Sky Plot Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let skyPlotBodies = []; // Store body positions for touch interaction

function drawSkyPlot(){
  const canvas = document.getElementById('skyPlotCanvas');
  if(!canvas || lat === null) return;
  
  const ctx = canvas.getContext('2d');
  const size = canvas.width;
  const cx = size / 2;
  const cy = size / 2;
  const radius = size * 0.45;
  
  ctx.clearRect(0, 0, size, size);
  skyPlotBodies = []; // Clear previous bodies
  
  // Background
  const gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius);
  gradient.addColorStop(0, '#1a2332');
  gradient.addColorStop(1, '#0a1929');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, size, size);
  
  // Altitude circles (every 30¬∞)
  ctx.strokeStyle = 'rgba(255,255,255,0.2)';
  ctx.lineWidth = 1;
  for(let alt = 30; alt <= 90; alt += 30){
    const r = radius * (1 - alt / 90);
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, 2 * Math.PI);
    ctx.stroke();
    
    // Label
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.font = '10px sans-serif';
    ctx.fillText(alt + '¬∞', cx + r + 5, cy);
  }
  
  // Azimuth lines (every 45¬∞)
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  for(let az = 0; az < 360; az += 45){
    const angle = (az - 90) * Math.PI / 180;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + radius * Math.cos(angle), cy + radius * Math.sin(angle));
    ctx.stroke();
  }
  
  // Cardinal directions
  ctx.fillStyle = 'rgba(255,255,255,0.7)';
  ctx.font = 'bold 14px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('N', cx, cy - radius - 10);
  ctx.fillText('S', cx, cy + radius + 20);
  ctx.fillText('E', cx + radius + 15, cy + 5);
  ctx.fillText('W', cx - radius - 15, cy + 5);
  
  // Plot celestial bodies
  const now = new Date();
  
  // Sun
  const sunPos = sunPosition(now, lat, lon);
  if(sunPos.altitude > 0){
    plotBodyWithLabel(ctx, cx, cy, radius, sunPos.azimuth, sunPos.altitude, '#fbbf24', 8, '‚òÄÔ∏è Sun', sunPos);
  }
  
  // Moon
  const moonPos = moonPosition(now, lat, lon);
  if(moonPos.altitude > 0){
    plotBodyWithLabel(ctx, cx, cy, radius, moonPos.azimuth, moonPos.altitude, '#60a5fa', 8, 'üåô Moon', moonPos);
  }
  
  // Planets
  ['Mercury','Venus','Mars','Jupiter','Saturn'].forEach(planet => {
    const pos = planetPosition(planet, now, lat, lon);
    if(pos && pos.altitude > 0){
      plotBodyWithLabel(ctx, cx, cy, radius, pos.azimuth, pos.altitude, '#f87171', 6, planet, pos);
    }
  });
  
  // Stars (sample - only brightest)
  ['Sirius','Vega','Arcturus','Capella','Rigel','Procyon','Betelgeuse','Altair','Aldebaran','Spica'].forEach(star => {
    const pos = starPosition(star, now, lat, lon);
    if(pos && pos.altitude > 0){
      plotBodyWithLabel(ctx, cx, cy, radius, pos.azimuth, pos.altitude, '#fde047', 4, star, pos);
    }
  });
  
  // Add touch/click event listener
  canvas.onclick = handleSkyPlotClick;
  canvas.ontouchend = handleSkyPlotClick;
}

function plotBodyWithLabel(ctx, cx, cy, radius, azimuth, altitude, color, size, name, posData){
  const r = radius * (1 - altitude / 90);
  const angle = (azimuth - 90) * Math.PI / 180;
  const x = cx + r * Math.cos(angle);
  const y = cy + r * Math.sin(angle);
  
  // Draw body
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(x, y, size, 0, 2 * Math.PI);
  ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.5)';
  ctx.lineWidth = 1;
  ctx.stroke();
  
  // Draw label near body
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.font = 'bold 9px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(name, x, y - size - 5);
  
  // Store for touch interaction
  skyPlotBodies.push({
    x, y, size: size + 5, // Add padding for easier touch
    name, 
    azimuth: azimuth.toFixed(1),
    altitude: altitude.toFixed(1),
    type: name.includes('‚òÄÔ∏è') ? 'Star' : name.includes('üåô') ? 'Satellite' : name.includes('Mercury') || name.includes('Venus') || name.includes('Mars') || name.includes('Jupiter') || name.includes('Saturn') ? 'Planet' : 'Star'
  });
}

function handleSkyPlotClick(e){
  const canvas = document.getElementById('skyPlotCanvas');
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  
  let clickX, clickY;
  if(e.type === 'touchend'){
    const touch = e.changedTouches[0];
    clickX = (touch.clientX - rect.left) * scaleX;
    clickY = (touch.clientY - rect.top) * scaleY;
  } else {
    clickX = (e.clientX - rect.left) * scaleX;
    clickY = (e.clientY - rect.top) * scaleY;
  }
  
  // Check if click is near any body
  for(let body of skyPlotBodies){
    const dist = Math.sqrt(Math.pow(clickX - body.x, 2) + Math.pow(clickY - body.y, 2));
    if(dist <= body.size * 2){
      showSkyObjectInfo(body);
      return;
    }
  }
}

function showSkyObjectInfo(body){
  const infoHtml = `
    <div style="background:var(--card); border:2px solid var(--primary); border-radius:12px; padding:16px; margin-top:16px; box-shadow:var(--shadow-lg);">
      <h4 style="font-size:1.1rem; font-weight:700; color:var(--primary); margin-bottom:12px;">${body.name}</h4>
      <div style="display:grid; grid-template-columns:auto 1fr; gap:8px 16px; font-size:0.9rem;">
        <div style="font-weight:700; color:var(--text-dim);">Type:</div>
        <div>${body.type}</div>
        <div style="font-weight:700; color:var(--text-dim);">Azimuth:</div>
        <div>${body.azimuth}¬∞</div>
        <div style="font-weight:700; color:var(--text-dim);">Altitude:</div>
        <div>${body.altitude}¬∞</div>
      </div>
      <button onclick="this.parentElement.remove()" style="margin-top:12px; background:var(--primary); color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:700;">Close</button>
    </div>
  `;
  
  // Remove existing info boxes
  const existing = document.querySelectorAll('#skyPlotCanvas ~ div');
  existing.forEach(el => {
    if(el.innerHTML.includes('Azimuth:')) el.remove();
  });
  
  // Add new info box
  const canvas = document.getElementById('skyPlotCanvas');
  canvas.insertAdjacentHTML('afterend', infoHtml);
}

function plotBody(ctx, cx, cy, radius, azimuth, altitude, color, size){
  const r = radius * (1 - altitude / 90);
  const angle = (azimuth - 90) * Math.PI / 180;
  const x = cx + r * Math.cos(angle);
  const y = cy + r * Math.sin(angle);
  
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(x, y, size, 0, 2 * Math.PI);
  ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.5)';
  ctx.lineWidth = 1;
  ctx.stroke();
}

// ‚îÄ‚îÄ‚îÄ Day/Night Table Population ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateDayNightTable(){
  const country = document.getElementById('daynight-country').value;
  const duration = parseInt(document.getElementById('daynight-duration').value);
  
  if(!country){
    document.getElementById('dayNightTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--text-dim);">Please select a country to view day/night data.</td></tr>';
    document.getElementById('timezone-indicator').style.display = 'none';
    return;
  }
  
  const coords = {
    'US': {lat: 38.9, lon: -77.0, name: 'Washington D.C.', tz: 'EST (UTC-5)'},
    'GB': {lat: 51.5, lon: -0.1, name: 'London', tz: 'GMT (UTC+0)'},
    'CA': {lat: 45.4, lon: -75.7, name: 'Ottawa', tz: 'EST (UTC-5)'},
    'AU': {lat: -35.3, lon: 149.1, name: 'Canberra', tz: 'AEDT (UTC+11)'},
    'IN': {lat: 28.6, lon: 77.2, name: 'New Delhi', tz: 'IST (UTC+5:30)'},
    'JP': {lat: 35.7, lon: 139.7, name: 'Tokyo', tz: 'JST (UTC+9)'},
    'DE': {lat: 52.5, lon: 13.4, name: 'Berlin', tz: 'CET (UTC+1)'},
    'FR': {lat: 48.9, lon: 2.4, name: 'Paris', tz: 'CET (UTC+1)'},
    'BR': {lat: -15.8, lon: -47.9, name: 'Bras√≠lia', tz: 'BRT (UTC-3)'},
    'ZA': {lat: -25.7, lon: 28.2, name: 'Pretoria', tz: 'SAST (UTC+2)'},
    'NO': {lat: 59.9, lon: 10.8, name: 'Oslo', tz: 'CET (UTC+1)'},
    'SE': {lat: 59.3, lon: 18.1, name: 'Stockholm', tz: 'CET (UTC+1)'},
    'IS': {lat: 64.1, lon: -21.9, name: 'Reykjavik', tz: 'GMT (UTC+0)'},
    'NZ': {lat: -41.3, lon: 174.8, name: 'Wellington', tz: 'NZDT (UTC+13)'},
    'SG': {lat: 1.3, lon: 103.8, name: 'Singapore', tz: 'SGT (UTC+8)'}
  };
  
  const loc = coords[country];
  
  // Show timezone indicator
  const tzIndicator = document.getElementById('timezone-indicator');
  tzIndicator.style.display = 'block';
  tzIndicator.querySelector('div').textContent = `Time zone automatically selected: ${loc.name} - ${loc.tz}`;
  
  const today = new Date();
  let html = '';
  
  for(let i = 0; i < duration; i++){
    const date = new Date(today);
    date.setDate(date.getDate() + i);
    
    const y = date.getFullYear();
    const m = date.getMonth() + 1;
    const d = date.getDate();
    const midUTC = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
    
    const srMins = solarTime(midUTC, loc.lat, loc.lon, 'sunrise');
    const ssMins = solarTime(midUTC, loc.lat, loc.lon, 'sunset');
    const ctStart = solarTime(midUTC, loc.lat, loc.lon, 'civilTwilightStart');
    const ctEnd = solarTime(midUTC, loc.lat, loc.lon, 'civilTwilightEnd');
    const ntStart = solarTime(midUTC, loc.lat, loc.lon, 'nauticalTwilightStart');
    const ntEnd = solarTime(midUTC, loc.lat, loc.lon, 'nauticalTwilightEnd');
    
    if(srMins !== null && ssMins !== null){
      const dayMins = ssMins - srMins;
      const nightMins = 1440 - dayMins;
      
      const srTime = formatLocalTime(y, m, d, srMins);
      const ssTime = formatLocalTime(y, m, d, ssMins);
      const dayDur = `${Math.floor(dayMins/60)}h ${Math.round(dayMins%60)}m`;
      const nightDur = `${Math.floor(nightMins/60)}h ${Math.round(nightMins%60)}m`;
      const civilTwi = ctStart !== null && ctEnd !== null ? `${formatLocalTime(y,m,d,ctStart)} - ${formatLocalTime(y,m,d,ctEnd)}` : 'N/A';
      const nautTwi = ntStart !== null && ntEnd !== null ? `${formatLocalTime(y,m,d,ntStart)} - ${formatLocalTime(y,m,d,ntEnd)}` : 'N/A';
      
      html += `<tr>
        <td style="padding:12px; font-weight:700;">${date.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'})}</td>
        <td style="padding:12px;">${srTime}</td>
        <td style="padding:12px;">${ssTime}</td>
        <td style="padding:12px;">${dayDur}</td>
        <td style="padding:12px;">${nightDur}</td>
        <td style="padding:12px; font-size:0.85rem;">${civilTwi}</td>
        <td style="padding:12px; font-size:0.85rem;">${nautTwi}</td>
      </tr>`;
    }
  }
  
  document.getElementById('dayNightTableBody').innerHTML = html || '<tr><td colspan="7" style="text-align:center; padding:30px;">No data available</td></tr>';
}

// ‚îÄ‚îÄ‚îÄ Lunar Calendar Population ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateLunarCalendar(){
  if(lat === null || lon === null){
    document.getElementById('lunarCalendarBody').innerHTML = '<tr><td colspan="9" style="text-align:center; padding:30px; color:var(--danger);">GPS location required. Please enable GPS or enter coordinates manually.</td></tr>';
    return;
  }
  
  const month = parseInt(document.getElementById('lunarcal-month').value);
  const year = parseInt(document.getElementById('lunarcal-year').value);
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  let html = '';
  for(let day = 1; day <= daysInMonth; day++){
    const date = new Date(year, month, day, 12, 0, 0);
    const dayName = date.toLocaleDateString('en-US', {weekday: 'short'});
    
    // Calculate moon data
    const y = year;
    const m = month + 1;
    const d = day;
    const midUTC = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
    
    const moonRise = lunarTime(midUTC, lat, lon, 'moonrise');
    const moonSet = lunarTime(midUTC, lat, lon, 'moonset');
    const phase = moonPhase(date);
    
    // Moon distance (approximate)
    const moonDist = 384400; // Average distance in km
    
    // Moon age
    const newMoon = new Date(2000, 0, 6, 18, 14);
    const daysSinceNew = (date - newMoon) / 86400000;
    const age = (daysSinceNew % 29.53).toFixed(1);
    
    const mrTime = moonRise !== null ? formatLocalTime(y, m, d, moonRise) : 'N/A';
    const msTime = moonSet !== null ? formatLocalTime(y, m, d, moonSet) : 'N/A';
    const mrAz = moonRise !== null ? '---¬∞' : 'N/A';  // Would need proper calculation
    const msAz = moonSet !== null ? '---¬∞' : 'N/A';
    
    html += `<tr style="border-bottom:1px solid var(--card-border);">
      <td style="padding:12px; font-weight:700;">${date.toLocaleDateString('en-US', {month:'short', day:'numeric'})}, ${dayName}</td>
      <td style="padding:12px;">${mrTime}</td>
      <td style="padding:12px;">${mrAz}</td>
      <td style="padding:12px;">${msTime}</td>
      <td style="padding:12px;">${msAz}</td>
      <td style="padding:12px;">${phase.phaseName}</td>
      <td style="padding:12px;">${moonDist}</td>
      <td style="padding:12px;">${age}</td>
      <td style="padding:12px;">${phase.illumination}</td>
    </tr>`;
  }
  
  document.getElementById('lunarCalendarBody').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ Body Description Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showBodyDescription(bodyName){
  const descriptions = {
    'Sun': 'The Sun is the star at the center of our Solar System. It is a nearly perfect sphere of hot plasma, with internal convective motion that generates a magnetic field.',
    'Moon': 'Earth\'s only natural satellite. The Moon is the fifth largest satellite in the Solar System and the largest relative to its parent planet.',
    'Mercury': 'The smallest planet in our solar system and nearest to the Sun. Mercury is only slightly larger than Earth\'s Moon.',
    'Venus': 'The second planet from the Sun. It is named after the Roman goddess of love and beauty. Venus is the brightest natural object in Earth\'s night sky after the Moon.',
    'Mars': 'The fourth planet from the Sun. Often called the "Red Planet" due to its reddish appearance caused by iron oxide on its surface.',
    'Jupiter': 'The fifth planet from the Sun and the largest in the Solar System. It is a gas giant with a mass more than two and a half times that of all the other planets combined.',
    'Saturn': 'The sixth planet from the Sun and the second-largest in the Solar System. It is a gas giant with an average radius about nine and a half times that of Earth.',
    'Sirius': 'The brightest star in the night sky. Its name is derived from the Greek word meaning "glowing" or "scorching".',
    'Vega': 'The brightest star in the constellation of Lyra. It is one of the most luminous stars in the Sun\'s neighborhood.',
    'Arcturus': 'The brightest star in the constellation of Bo√∂tes and the fourth-brightest star in the night sky.'
  };
  
  document.getElementById('body-description-title').textContent = bodyName;
  document.getElementById('body-description-content').innerHTML = descriptions[bodyName] || 'No description available for this celestial body.';
  document.getElementById('body-description-overlay').style.display = 'flex';
}

function closeBodyDescription(){
  document.getElementById('body-description-overlay').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let refreshInterval = null;

// Initialize moon phase year selector
(function(){
  const yearSel = document.getElementById('moonphase-year');
  const currentYear = new Date().getFullYear();
  for(let y = currentYear - 5; y <= currentYear + 10; y++){
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if(y === currentYear) opt.selected = true;
    yearSel.appendChild(opt);
  }
  const currentMonth = new Date().getMonth();
  document.getElementById('moonphase-month').value = currentMonth;
})();

// Initialize lunar calendar year selector
(function(){
  const yearSel = document.getElementById('lunarcal-year');
  const currentYear = new Date().getFullYear();
  for(let y = currentYear - 5; y <= currentYear + 10; y++){
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if(y === currentYear) opt.selected = true;
    yearSel.appendChild(opt);
  }
  const currentMonth = new Date().getMonth();
  document.getElementById('lunarcal-month').value = currentMonth;
})();

window.onload=function(){
  // Load saved language FIRST
  const savedLanguage = localStorage.getItem('appLanguage') || 'en';
  currentLanguage = savedLanguage;
  if(document.getElementById('setting-language')){
    document.getElementById('setting-language').value = savedLanguage;
  }
  
  // Load saved app mode
  const savedMode = localStorage.getItem('appMode') || 'online';
  appMode = savedMode;
  setMode(savedMode);
  
  // Load saved settings if available
  const savedSettings = localStorage.getItem('marineCalcSettings');
  if(savedSettings){
    try{
      loadDefaultSettings();
    } catch(e){
      console.log('Error loading saved settings:', e);
    }
  } else {
    // Apply language even if no saved settings
    applyLanguage();
  }
  
  fetchGPS();
  
  // Initialize time format from settings
  timeFormat = document.getElementById('setting-timeformat')?.value || '24h';
  
  // Initialize moon phases
  updateMoonPhases();
  
  // Initialize lunar calendar - will show message to enable GPS if not available
  setTimeout(() => {
    if(lat !== null && lon !== null){
      updateLunarCalendar();
    }
  }, 2000);
  
  // Initialize eclipse times
  updateEclipseTimes();
  
  // Draw initial sky plot
  setTimeout(() => {
    if(lat !== null){
      drawSkyPlot();
    }
  }, 1500);
  
  // Draw marine compass periodically
  setInterval(() => {
    if(document.getElementById('tab-marinecompass')?.classList.contains('active')){
      updateMarineCompass();
    }
  }, 2000);
  
  // Update world clocks every second
  setInterval(updateWorldClocks, 1000);
  
  // Update GPS status every 5 seconds
  setInterval(updateGPSStatus, 5000);
  
  // Update eclipse times when offset changes
  document.getElementById('utcOffset').addEventListener('change', updateEclipseTimes);
  
  // Listen for time format changes
  document.getElementById('setting-timeformat')?.addEventListener('change', applyTimeFormat);
  
  // Set up auto-refresh based on settings
  function setupRefresh(){
    if(refreshInterval) clearInterval(refreshInterval);
    
    const interval = parseInt(document.getElementById('setting-refresh-interval')?.value || 30) * 1000;
    const timeRefresh = document.getElementById('setting-autorefresh-time')?.checked;
    const gpsRefresh = document.getElementById('setting-autorefresh-gps')?.checked;
    
    refreshInterval = setInterval(()=>{ 
      if(lat!==null && timeRefresh && appMode === 'online') {
        compute();
        // Update visible tab if active
        if(document.getElementById('tab-visible')?.classList.contains('active')){
          updateVisibleBodies();
        }
        // Update compass if object selected
        if(document.getElementById('tab-compass')?.classList.contains('active')){
          updateCompassObject();
        }
        // Update eclipse times
        updateEclipseTimes();
      }
      if(gpsRefresh && appMode === 'online') {
        fetchGPS();
      }
    }, interval);
  }
  
  setupRefresh();
  
  // Listen for settings changes
  document.getElementById('setting-refresh-interval')?.addEventListener('change', setupRefresh);
  document.getElementById('setting-autorefresh-time')?.addEventListener('change', setupRefresh);
  document.getElementById('setting-autorefresh-gps')?.addEventListener('change', setupRefresh);
};
</script>
</body>
</html>
